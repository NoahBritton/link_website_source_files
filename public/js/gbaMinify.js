function SRAMSavedata(t){MemoryView.call(this,new ArrayBuffer(t),0),this.writePending=!1}function FlashSavedata(t){MemoryView.call(this,new ArrayBuffer(t),0),this.COMMAND_WIPE=16,this.COMMAND_ERASE_SECTOR=48,this.COMMAND_ERASE=128,this.COMMAND_ID=144,this.COMMAND_WRITE=160,this.COMMAND_SWITCH_BANK=176,this.COMMAND_TERMINATE_ID=240,this.ID_PANASONIC=6962,this.ID_SANYO=4962,this.bank0=new DataView(this.buffer,0,65536),65536<t?(this.id=this.ID_SANYO,this.bank1=new DataView(this.buffer,65536)):(this.id=this.ID_PANASONIC,this.bank1=null),this.bank=this.bank0,this.idMode=!1,this.writePending=!1,this.first=0,this.second=0,this.command=0,this.pendingCommand=0}function EEPROMSavedata(t,e){MemoryView.call(this,new ArrayBuffer(t),0),this.writeAddress=0,this.readBitsRemaining=0,this.readAddress=0,this.command=0,this.commandBitsRemaining=0,this.realSize=0,this.addressBits=0,this.writePending=!1,this.dma=e.core.irq.dma[3],this.COMMAND_NULL=0,this.COMMAND_PENDING=1,this.COMMAND_WRITE=2,this.COMMAND_READ_PENDING=3,this.COMMAND_READ=4}function GameBoyAdvanceSIO(){this.SIO_NORMAL_8=0,this.SIO_NORMAL_32=1,this.SIO_MULTI=2,this.SIO_UART=3,this.SIO_GPIO=8,this.SIO_JOYBUS=12,this.BAUD=[9600,38400,57600,115200]}function hex(t,e,i){void 0===i&&(i=!0),void 0===e&&(e=8);t=(t>>>0).toString(16).toUpperCase();return(e-=t.length)<0?t:(i?"0x":"")+new Array(e+1).join("0")+t}function GameBoyAdvanceVideo(){this.renderPath=new GameBoyAdvanceSoftwareRenderer,this.CYCLES_PER_PIXEL=4,this.HORIZONTAL_PIXELS=240,this.HBLANK_PIXELS=68,this.HDRAW_LENGTH=1006,this.HBLANK_LENGTH=226,this.HORIZONTAL_LENGTH=1232,this.VERTICAL_PIXELS=160,this.VBLANK_PIXELS=68,this.VERTICAL_TOTAL_PIXELS=228,this.TOTAL_LENGTH=280896,this.drawCallback=function(){},this.vblankCallback=function(){}}function GameBoyAdvanceAudio(){var e;window.AudioContext=window.AudioContext||window.webkitAudioContext,window.AudioContext?((e=this).context=new AudioContext,this.bufferSize=0,this.bufferSize=4096,this.maxSamples=this.bufferSize<<2,this.buffers=[new Float32Array(this.maxSamples),new Float32Array(this.maxSamples)],this.sampleMask=this.maxSamples-1,this.context.createScriptProcessor?this.jsAudio=this.context.createScriptProcessor(this.bufferSize):this.jsAudio=this.context.createJavaScriptNode(this.bufferSize),this.jsAudio.onaudioprocess=function(t){e.audioProcess(t)}):this.context=null,this.masterEnable=!0,this.masterVolume=1,this.SOUND_MAX=1024,this.FIFO_MAX=512,this.PSG_MAX=128}function ARMCore(){this.inherit(),this.SP=13,this.LR=14,this.PC=15,this.MODE_ARM=0,this.MODE_THUMB=1,this.MODE_USER=16,this.MODE_FIQ=17,this.MODE_IRQ=18,this.MODE_SUPERVISOR=19,this.MODE_ABORT=23,this.MODE_UNDEFINED=27,this.MODE_SYSTEM=31,this.BANK_NONE=0,this.BANK_FIQ=1,this.BANK_IRQ=2,this.BANK_SUPERVISOR=3,this.BANK_ABORT=4,this.BANK_UNDEFINED=5,this.UNALLOC_MASK=268435200,this.USER_MASK=4026531840,this.PRIV_MASK=207,this.STATE_MASK=32,this.WORD_SIZE_ARM=4,this.WORD_SIZE_THUMB=2,this.BASE_RESET=0,this.BASE_UNDEF=4,this.BASE_SWI=8,this.BASE_PABT=12,this.BASE_DABT=16,this.BASE_IRQ=24,this.BASE_FIQ=28,this.armCompiler=new ARMCoreArm(this),this.thumbCompiler=new ARMCoreThumb(this),this.generateConds(),this.gprs=new Int32Array(16)}function GameBoyAdvance(){this.LOG_ERROR=1,this.LOG_WARN=2,this.LOG_STUB=4,this.LOG_INFO=8,this.LOG_DEBUG=16,this.SYS_ID="com.endrift.gbajs",this.logLevel=this.LOG_ERROR|this.LOG_WARN,this.rom=null,this.cpu=new ARMCore,this.mmu=new GameBoyAdvanceMMU,this.irq=new GameBoyAdvanceInterruptHandler,this.io=new GameBoyAdvanceIO,this.audio=new GameBoyAdvanceAudio,this.video=new GameBoyAdvanceVideo,this.keypad=new GameBoyAdvanceKeypad,this.sio=new GameBoyAdvanceSIO,this.cpu.mmu=this.mmu,this.cpu.irq=this.irq,this.mmu.cpu=this.cpu,(this.mmu.core=this).irq.cpu=this.cpu,this.irq.io=this.io,this.irq.audio=this.audio,this.irq.video=this.video,(this.irq.core=this).io.cpu=this.cpu,this.io.audio=this.audio,this.io.video=this.video,this.io.keypad=this.keypad,this.io.sio=this.sio,(this.io.core=this).audio.cpu=this.cpu,(this.audio.core=this).video.cpu=this.cpu,(((this.video.core=this).keypad.core=this).sio.core=this).keypad.registerHandlers(),this.doStep=this.waitFrame,this.paused=!1,this.seenFrame=!1,this.seenSave=!1,this.lastVblank=0,this.queue=null,this.reportFPS=null,this.throttle=16;var e=this;window.queueFrame=function(t){e.queue=window.setTimeout(t,e.throttle)},window.URL=window.URL||window.webkitURL,this.video.vblankCallback=function(){e.seenFrame=!0}}function GameBoyAdvanceGPIO(t,e){this.core=t,this.rom=e,this.readWrite=0,this.direction=0,this.device=new GameBoyAdvanceRTC(this)}function GameBoyAdvanceRTC(t){this.gpio=t,this.pins=0,this.direction=0,this.totalBytes=[0,0,7,0,1,0,3,0],this.bytesRemaining=0,this.transferStep=0,this.reading=0,this.bitsRead=0,this.bits=0,this.command=-1,this.control=64,this.time=[0,0,0,0,0,0,0]}function GameBoyAdvanceIO(){this.DISPCNT=0,this.GREENSWP=2,this.DISPSTAT=4,this.VCOUNT=6,this.BG0CNT=8,this.BG1CNT=10,this.BG2CNT=12,this.BG3CNT=14,this.BG0HOFS=16,this.BG0VOFS=18,this.BG1HOFS=20,this.BG1VOFS=22,this.BG2HOFS=24,this.BG2VOFS=26,this.BG3HOFS=28,this.BG3VOFS=30,this.BG2PA=32,this.BG2PB=34,this.BG2PC=36,this.BG2PD=38,this.BG2X_LO=40,this.BG2X_HI=42,this.BG2Y_LO=44,this.BG2Y_HI=46,this.BG3PA=48,this.BG3PB=50,this.BG3PC=52,this.BG3PD=54,this.BG3X_LO=56,this.BG3X_HI=58,this.BG3Y_LO=60,this.BG3Y_HI=62,this.WIN0H=64,this.WIN1H=66,this.WIN0V=68,this.WIN1V=70,this.WININ=72,this.WINOUT=74,this.MOSAIC=76,this.BLDCNT=80,this.BLDALPHA=82,this.BLDY=84,this.SOUND1CNT_LO=96,this.SOUND1CNT_HI=98,this.SOUND1CNT_X=100,this.SOUND2CNT_LO=104,this.SOUND2CNT_HI=108,this.SOUND3CNT_LO=112,this.SOUND3CNT_HI=114,this.SOUND3CNT_X=116,this.SOUND4CNT_LO=120,this.SOUND4CNT_HI=124,this.SOUNDCNT_LO=128,this.SOUNDCNT_HI=130,this.SOUNDCNT_X=132,this.SOUNDBIAS=136,this.WAVE_RAM0_LO=144,this.WAVE_RAM0_HI=146,this.WAVE_RAM1_LO=148,this.WAVE_RAM1_HI=150,this.WAVE_RAM2_LO=152,this.WAVE_RAM2_HI=154,this.WAVE_RAM3_LO=156,this.WAVE_RAM3_HI=158,this.FIFO_A_LO=160,this.FIFO_A_HI=162,this.FIFO_B_LO=164,this.FIFO_B_HI=166,this.DMA0SAD_LO=176,this.DMA0SAD_HI=178,this.DMA0DAD_LO=180,this.DMA0DAD_HI=182,this.DMA0CNT_LO=184,this.DMA0CNT_HI=186,this.DMA1SAD_LO=188,this.DMA1SAD_HI=190,this.DMA1DAD_LO=192,this.DMA1DAD_HI=194,this.DMA1CNT_LO=196,this.DMA1CNT_HI=198,this.DMA2SAD_LO=200,this.DMA2SAD_HI=202,this.DMA2DAD_LO=204,this.DMA2DAD_HI=206,this.DMA2CNT_LO=208,this.DMA2CNT_HI=210,this.DMA3SAD_LO=212,this.DMA3SAD_HI=214,this.DMA3DAD_LO=216,this.DMA3DAD_HI=218,this.DMA3CNT_LO=220,this.DMA3CNT_HI=222,this.TM0CNT_LO=256,this.TM0CNT_HI=258,this.TM1CNT_LO=260,this.TM1CNT_HI=262,this.TM2CNT_LO=264,this.TM2CNT_HI=266,this.TM3CNT_LO=268,this.TM3CNT_HI=270,this.SIODATA32_LO=288,this.SIOMULTI0=288,this.SIODATA32_HI=290,this.SIOMULTI1=290,this.SIOMULTI2=292,this.SIOMULTI3=294,this.SIOCNT=296,this.SIOMLT_SEND=298,this.SIODATA8=298,this.RCNT=308,this.JOYCNT=320,this.JOY_RECV=336,this.JOY_TRANS=340,this.JOYSTAT=344,this.KEYINPUT=304,this.KEYCNT=306,this.IE=512,this.IF=514,this.WAITCNT=516,this.IME=520,this.POSTFLG=768,this.HALTCNT=769,this.DEFAULT_DISPCNT=128,this.DEFAULT_SOUNDBIAS=512,this.DEFAULT_BGPA=1,this.DEFAULT_BGPD=1,this.DEFAULT_RCNT=32768}function GameBoyAdvanceInterruptHandler(){this.inherit(),this.FREQUENCY=16777216,this.cpu=null,this.enable=!1,this.IRQ_VBLANK=0,this.IRQ_HBLANK=1,this.IRQ_VCOUNTER=2,this.IRQ_TIMER0=3,this.IRQ_TIMER1=4,this.IRQ_TIMER2=5,this.IRQ_TIMER3=6,this.IRQ_SIO=7,this.IRQ_DMA0=8,this.IRQ_DMA1=9,this.IRQ_DMA2=10,this.IRQ_DMA3=11,this.IRQ_KEYPAD=12,this.IRQ_GAMEPAK=13,this.MASK_VBLANK=1,this.MASK_HBLANK=2,this.MASK_VCOUNTER=4,this.MASK_TIMER0=8,this.MASK_TIMER1=16,this.MASK_TIMER2=32,this.MASK_TIMER3=64,this.MASK_SIO=128,this.MASK_DMA0=256,this.MASK_DMA1=512,this.MASK_DMA2=1024,this.MASK_DMA3=2048,this.MASK_KEYPAD=4096,this.MASK_GAMEPAK=8192}function GameBoyAdvanceKeypad(){this.KEYCODE_LEFT=37,this.KEYCODE_UP=38,this.KEYCODE_RIGHT=39,this.KEYCODE_DOWN=40,this.KEYCODE_START=13,this.KEYCODE_SELECT=220,this.KEYCODE_A=90,this.KEYCODE_B=88,this.KEYCODE_L=65,this.KEYCODE_R=83,this.GAMEPAD_LEFT=14,this.GAMEPAD_UP=12,this.GAMEPAD_RIGHT=15,this.GAMEPAD_DOWN=13,this.GAMEPAD_START=9,this.GAMEPAD_SELECT=8,this.GAMEPAD_A=1,this.GAMEPAD_B=0,this.GAMEPAD_L=4,this.GAMEPAD_R=5,this.GAMEPAD_THRESHOLD=.2,this.A=0,this.B=1,this.SELECT=2,this.START=3,this.RIGHT=4,this.LEFT=5,this.UP=6,this.DOWN=7,this.R=8,this.L=9,this.currentDown=1023,this.eatInput=!1,this.gamepads=[]}function MemoryView(t,e){this.inherit(),this.buffer=t,this.view=new DataView(this.buffer,"number"==typeof e?e:0),this.mask=t.byteLength-1,this.resetMask()}function MemoryBlock(t,e){MemoryView.call(this,new ArrayBuffer(t)),this.ICACHE_PAGE_BITS=e,this.PAGE_MASK=(2<<this.ICACHE_PAGE_BITS)-1,this.icache=new Array(t>>this.ICACHE_PAGE_BITS+1)}function ROMView(t,e){MemoryView.call(this,t,e),this.ICACHE_PAGE_BITS=10,this.PAGE_MASK=(2<<this.ICACHE_PAGE_BITS)-1,this.icache=new Array(t.byteLength>>this.ICACHE_PAGE_BITS+1),this.mask=33554431,this.resetMask()}function BIOSView(t,e){MemoryView.call(this,t,e),this.ICACHE_PAGE_BITS=16,this.PAGE_MASK=(2<<this.ICACHE_PAGE_BITS)-1,this.icache=new Array(1)}function BadMemory(t,e){this.inherit(),this.cpu=e,this.mmu=t}function GameBoyAdvanceMMU(){this.inherit(),this.REGION_BIOS=0,this.REGION_WORKING_RAM=2,this.REGION_WORKING_IRAM=3,this.REGION_IO=4,this.REGION_PALETTE_RAM=5,this.REGION_VRAM=6,this.REGION_OAM=7,this.REGION_CART0=8,this.REGION_CART1=10,this.REGION_CART2=12,this.REGION_CART_SRAM=14,this.BASE_BIOS=0,this.BASE_WORKING_RAM=33554432,this.BASE_WORKING_IRAM=50331648,this.BASE_IO=67108864,this.BASE_PALETTE_RAM=83886080,this.BASE_VRAM=100663296,this.BASE_OAM=117440512,this.BASE_CART0=134217728,this.BASE_CART1=167772160,this.BASE_CART2=201326592,this.BASE_CART_SRAM=234881024,this.BASE_MASK=251658240,this.BASE_OFFSET=24,this.OFFSET_MASK=16777215,this.SIZE_BIOS=16384,this.SIZE_WORKING_RAM=262144,this.SIZE_WORKING_IRAM=32768,this.SIZE_IO=1024,this.SIZE_PALETTE_RAM=1024,this.SIZE_VRAM=98304,this.SIZE_OAM=1024,this.SIZE_CART0=33554432,this.SIZE_CART1=33554432,this.SIZE_CART2=33554432,this.SIZE_CART_SRAM=32768,this.SIZE_CART_FLASH512=65536,this.SIZE_CART_FLASH1M=131072,this.SIZE_CART_EEPROM=8192,this.DMA_TIMING_NOW=0,this.DMA_TIMING_VBLANK=1,this.DMA_TIMING_HBLANK=2,this.DMA_TIMING_CUSTOM=3,this.DMA_INCREMENT=0,this.DMA_DECREMENT=1,this.DMA_FIXED=2,this.DMA_INCREMENT_RELOAD=3,this.DMA_OFFSET=[1,-1,0,1],this.WAITSTATES=[0,0,2,0,0,0,0,0,4,4,4,4,4,4,4],this.WAITSTATES_32=[0,0,5,0,0,1,0,1,7,7,9,9,13,13,8],this.WAITSTATES_SEQ=[0,0,2,0,0,0,0,0,2,2,4,4,8,8,4],this.WAITSTATES_SEQ_32=[0,0,5,0,0,1,0,1,5,5,9,9,17,17,8],this.NULLWAIT=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(var t=15;t<256;++t)this.WAITSTATES[t]=0,this.WAITSTATES_32[t]=0,this.WAITSTATES_SEQ[t]=0,this.WAITSTATES_SEQ_32[t]=0,this.NULLWAIT[t]=0;this.ROM_WS=[4,3,2,8],this.ROM_WS_SEQ=[[2,1],[4,1],[8,1]],this.ICACHE_PAGE_BITS=8,this.PAGE_MASK=(2<<this.ICACHE_PAGE_BITS)-1,this.bios=null}function MemoryAligned16(t){this.buffer=new Uint16Array(t>>1)}function GameBoyAdvanceVRAM(t){MemoryAligned16.call(this,t),this.vram=this.buffer}function GameBoyAdvanceOAM(t){MemoryAligned16.call(this,t),this.oam=this.buffer,this.objs=new Array(128);for(var e=0;e<128;++e)this.objs[e]=new GameBoyAdvanceOBJ(this,e);this.scalerot=new Array(32);for(e=0;e<32;++e)this.scalerot[e]={a:1,b:0,c:0,d:1}}function GameBoyAdvancePalette(){this.colors=[new Array(256),new Array(256)],this.adjustedColors=[new Array(256),new Array(256)],this.passthroughColors=[this.colors[0],this.colors[0],this.colors[0],this.colors[0],this.colors[1],this.colors[0]],this.blendY=1}function GameBoyAdvanceOBJ(t,e){this.TILE_OFFSET=65536,this.oam=t,this.index=e,this.x=0,this.y=0,this.scalerot=0,this.doublesize=!1,this.disable=1,this.mode=0,this.mosaic=!1,this.multipalette=!1,this.shape=0,this.scalerotParam=0,this.hflip=0,this.vflip=0,this.tileBase=0,this.priority=0,this.palette=0,this.drawScanline=this.drawScanlineNormal,this.pushPixel=GameBoyAdvanceSoftwareRenderer.pushPixel,this.cachedWidth=8,this.cachedHeight=8}function GameBoyAdvanceOBJLayer(t,e){this.video=t,this.bg=!1,this.index=t.LAYER_OBJ,this.priority=e,this.enabled=!1,this.objwin=0}function GameBoyAdvanceSoftwareRenderer(){this.LAYER_BG0=0,this.LAYER_BG1=1,this.LAYER_BG2=2,this.LAYER_BG3=3,this.LAYER_OBJ=4,this.LAYER_BACKDROP=5,this.HORIZONTAL_PIXELS=240,this.VERTICAL_PIXELS=160,this.LAYER_MASK=6,this.BACKGROUND_MASK=1,this.TARGET2_MASK=8,this.TARGET1_MASK=16,this.OBJWIN_MASK=32,this.WRITTEN_MASK=128,this.PRIORITY_MASK=this.LAYER_MASK|this.BACKGROUND_MASK,this.drawBackdrop=new function(a){this.bg=!0,this.priority=-1,this.index=a.LAYER_BACKDROP,this.enabled=!0,this.drawScanline=function(t,e,i,s){for(var r=i;r<s;++r)t.stencil[r]&a.WRITTEN_MASK?t.stencil[r]&a.TARGET1_MASK&&(t.color[r]=a.palette.mix(a.blendB,a.palette.accessColor(this.index,0),a.blendA,t.color[r]),t.stencil[r]=a.WRITTEN_MASK):(t.color[r]=a.palette.accessColor(this.index,0),t.stencil[r]=a.WRITTEN_MASK)}}(this)}SRAMSavedata.prototype=Object.create(MemoryView.prototype),SRAMSavedata.prototype.store8=function(t,e){this.view.setInt8(t,e),this.writePending=!0},SRAMSavedata.prototype.store16=function(t,e){this.view.setInt16(t,e,!0),this.writePending=!0},SRAMSavedata.prototype.store32=function(t,e){this.view.setInt32(t,e,!0),this.writePending=!0},FlashSavedata.prototype=Object.create(MemoryView.prototype),FlashSavedata.prototype.load8=function(t){return this.idMode&&t<2?this.id>>(t<<3)&255:t<65536?this.bank.getInt8(t):0},FlashSavedata.prototype.load16=function(t){return 255&this.load8(t)|this.load8(t+1)<<8},FlashSavedata.prototype.load32=function(t){return 255&this.load8(t)|this.load8(t+1)<<8|this.load8(t+2)<<16|this.load8(t+3)<<24},FlashSavedata.prototype.loadU8=function(t){return 255&this.load8(t)},FlashSavedata.prototype.loadU16=function(t){return 255&this.loadU8(t)|this.loadU8(t+1)<<8},FlashSavedata.prototype.store8=function(t,e){switch(this.command){case 0:if(21845==t)if(85==this.second){switch(e){case this.COMMAND_ERASE:this.pendingCommand=e;break;case this.COMMAND_ID:this.idMode=!0;break;case this.COMMAND_TERMINATE_ID:this.idMode=!1;break;default:this.command=e}this.second=0,this.first=0}else this.command=0,this.first=e,this.idMode=!1;else 10922==t&&170==this.first&&(this.first=0,this.pendingCommand?this.command=this.pendingCommand:this.second=e);break;case this.COMMAND_ERASE:switch(e){case this.COMMAND_WIPE:if(21845==t)for(var i=0;i<this.view.byteLength;i+=4)this.view.setInt32(i,-1);break;case this.COMMAND_ERASE_SECTOR:if(0==(4095&t))for(i=t;i<t+4096;i+=4)this.bank.setInt32(i,-1)}this.pendingCommand=0,this.command=0;break;case this.COMMAND_WRITE:this.bank.setInt8(t,e),this.command=0,this.writePending=!0;break;case this.COMMAND_SWITCH_BANK:this.bank1&&0==t&&(this.bank=1==e?this.bank1:this.bank0),this.command=0}},FlashSavedata.prototype.store16=function(t,e){throw new Error("Unaligned save to flash!")},FlashSavedata.prototype.store32=function(t,e){throw new Error("Unaligned save to flash!")},FlashSavedata.prototype.replaceData=function(t){var e=this.view===this.bank1;MemoryView.prototype.replaceData.call(this,t,0),this.bank0=new DataView(this.buffer,0,65536),65536<t.byteLength?this.bank1=new DataView(this.buffer,65536):this.bank1=null,this.bank=e?this.bank1:this.bank0},EEPROMSavedata.prototype=Object.create(MemoryView.prototype),EEPROMSavedata.prototype.load8=function(t){throw new Error("Unsupported 8-bit access!")},EEPROMSavedata.prototype.load16=function(t){return this.loadU16(t)},EEPROMSavedata.prototype.loadU8=function(t){throw new Error("Unsupported 8-bit access!")},EEPROMSavedata.prototype.loadU16=function(t){if(this.command!=this.COMMAND_READ||!this.dma.enable)return 1;if(--this.readBitsRemaining,this.readBitsRemaining<64){var e=63-this.readBitsRemaining,e=this.view.getUint8(this.readAddress+e>>3,!1)>>7-(7&e);return this.readBitsRemaining||(this.command=this.COMMAND_NULL),1&e}return 0},EEPROMSavedata.prototype.load32=function(t){throw new Error("Unsupported 32-bit access!")},EEPROMSavedata.prototype.store8=function(t,e){throw new Error("Unsupported 8-bit access!")},EEPROMSavedata.prototype.store16=function(t,e){switch(this.command){case this.COMMAND_NULL:default:this.command=1&e;break;case this.COMMAND_PENDING:this.command<<=1,this.command|=1&e,this.command==this.COMMAND_WRITE?(this.realSize||(i=this.dma.count-67,this.realSize=8<<i,this.addressBits=i),this.commandBitsRemaining=this.addressBits+64+1,this.writeAddress=0):(this.realSize||(i=this.dma.count-3,this.realSize=8<<i,this.addressBits=i),this.commandBitsRemaining=this.addressBits+1,this.readAddress=0);break;case this.COMMAND_WRITE:var i;64<--this.commandBitsRemaining?(this.writeAddress<<=1,this.writeAddress|=(1&e)<<6):this.commandBitsRemaining<=0?(this.command=this.COMMAND_NULL,this.writePending=!0):(i=this.view.getUint8(this.writeAddress>>3),i&=~(1<<7-(7&this.writeAddress)),i|=(1&e)<<7-(7&this.writeAddress),this.view.setUint8(this.writeAddress>>3,i),++this.writeAddress);break;case this.COMMAND_READ_PENDING:0<--this.commandBitsRemaining?(this.readAddress<<=1,1&e&&(this.readAddress|=64)):(this.readBitsRemaining=68,this.command=this.COMMAND_READ)}},EEPROMSavedata.prototype.store32=function(t,e){throw new Error("Unsupported 32-bit access!")},EEPROMSavedata.prototype.replaceData=function(t){MemoryView.prototype.replaceData.call(this,t,0)},GameBoyAdvanceSIO.prototype.clear=function(){this.mode=this.SIO_GPIO,this.sd=!1,this.irq=!1,this.multiplayer={baud:0,si:0,id:0,error:0,busy:0,states:[65535,65535,65535,65535]},this.linkLayer=null},GameBoyAdvanceSIO.prototype.setMode=function(t){t&=8&t?12:3,this.mode=t,this.core.INFO("Setting SIO mode to "+hex(t,1))},GameBoyAdvanceSIO.prototype.writeRCNT=function(t){this.mode==this.SIO_GPIO&&this.core.STUB("General purpose serial not supported")},GameBoyAdvanceSIO.prototype.writeSIOCNT=function(t){switch(this.mode){case this.SIO_NORMAL_8:this.core.STUB("8-bit transfer unsupported");break;case this.SIO_NORMAL_32:this.core.STUB("32-bit transfer unsupported");break;case this.SIO_MULTI:this.multiplayer.baud=3&t,this.linkLayer&&this.linkLayer.setBaud(this.BAUD[this.multiplayer.baud]),this.multiplayer.si||(this.multiplayer.busy=128&t,this.linkLayer&&this.multiplayer.busy&&this.linkLayer.startMultiplayerTransfer()),this.irq=16384&t;break;case this.SIO_UART:this.core.STUB("UART unsupported");break;case this.SIO_GPIO:break;case this.SIO_JOYBUS:this.core.STUB("JOY BUS unsupported")}},GameBoyAdvanceSIO.prototype.readSIOCNT=function(){var t=this.mode<<12&65535;switch(this.mode){case this.SIO_NORMAL_8:this.core.STUB("8-bit transfer unsupported");break;case this.SIO_NORMAL_32:this.core.STUB("32-bit transfer unsupported");break;case this.SIO_MULTI:t|=this.multiplayer.baud,t|=this.multiplayer.si,t|=!!this.sd<<3,t|=this.multiplayer.id<<4,t|=this.multiplayer.error,t|=this.multiplayer.busy,t|=!!this.multiplayer.irq<<14;break;case this.SIO_UART:this.core.STUB("UART unsupported");break;case this.SIO_GPIO:break;case this.SIO_JOYBUS:this.core.STUB("JOY BUS unsupported")}return t},GameBoyAdvanceSIO.prototype.read=function(t){switch(this.mode){case this.SIO_NORMAL_32:this.core.STUB("32-bit transfer unsupported");break;case this.SIO_MULTI:return this.multiplayer.states[t];case this.SIO_UART:this.core.STUB("UART unsupported");break;default:this.core.WARN("Reading from transfer register in unsupported mode")}return 0},ARMCoreThumb=function(t){this.cpu=t},ARMCoreThumb.prototype.constructADC=function(r,a){var n=this.cpu,o=n.gprs;return function(){n.mmu.waitPrefetch(o[n.PC]);var t=(o[a]>>>0)+!!n.cpsrC,e=o[r],i=(e>>>0)+t,s=e>>31,e=i>>31,t=t>>31;n.cpsrN=e,n.cpsrZ=!(4294967295&i),n.cpsrC=4294967295<i,n.cpsrV=s==t&&s!=e&&t!=e,o[r]=i}},ARMCoreThumb.prototype.constructADD1=function(e,i,s){var r=this.cpu,a=r.gprs;return function(){r.mmu.waitPrefetch(a[r.PC]);var t=(a[i]>>>0)+s;r.cpsrN=t>>31,r.cpsrZ=!(4294967295&t),r.cpsrC=4294967295<t,r.cpsrV=!(a[i]>>31)&&(a[i]>>31^t)>>31&&t>>31,a[e]=t}},ARMCoreThumb.prototype.constructADD2=function(e,i){var s=this.cpu,r=s.gprs;return function(){s.mmu.waitPrefetch(r[s.PC]);var t=(r[e]>>>0)+i;s.cpsrN=t>>31,s.cpsrZ=!(4294967295&t),s.cpsrC=4294967295<t,s.cpsrV=!(r[e]>>31)&&(r[e]^t)>>31&&(i^t)>>31,r[e]=t}},ARMCoreThumb.prototype.constructADD3=function(e,i,s){var r=this.cpu,a=r.gprs;return function(){r.mmu.waitPrefetch(a[r.PC]);var t=(a[i]>>>0)+(a[s]>>>0);r.cpsrN=t>>31,r.cpsrZ=!(4294967295&t),r.cpsrC=4294967295<t,r.cpsrV=!((a[i]^a[s])>>31)&&(a[i]^t)>>31&&(a[s]^t)>>31,a[e]=t}},ARMCoreThumb.prototype.constructADD4=function(t,e){var i=this.cpu,s=i.gprs;return function(){i.mmu.waitPrefetch(s[i.PC]),s[t]+=s[e]}},ARMCoreThumb.prototype.constructADD5=function(t,e){var i=this.cpu,s=i.gprs;return function(){i.mmu.waitPrefetch(s[i.PC]),s[t]=(4294967292&s[i.PC])+e}},ARMCoreThumb.prototype.constructADD6=function(t,e){var i=this.cpu,s=i.gprs;return function(){i.mmu.waitPrefetch(s[i.PC]),s[t]=s[i.SP]+e}},ARMCoreThumb.prototype.constructADD7=function(t){var e=this.cpu,i=e.gprs;return function(){e.mmu.waitPrefetch(i[e.PC]),i[e.SP]+=t}},ARMCoreThumb.prototype.constructAND=function(t,e){var i=this.cpu,s=i.gprs;return function(){i.mmu.waitPrefetch(s[i.PC]),s[t]=s[t]&s[e],i.cpsrN=s[t]>>31,i.cpsrZ=!(4294967295&s[t])}},ARMCoreThumb.prototype.constructASR1=function(t,e,i){var s=this.cpu,r=s.gprs;return function(){s.mmu.waitPrefetch(r[s.PC]),0==i?(s.cpsrC=r[e]>>31,s.cpsrC?r[t]=4294967295:r[t]=0):(s.cpsrC=r[e]&1<<i-1,r[t]=r[e]>>i),s.cpsrN=r[t]>>31,s.cpsrZ=!(4294967295&r[t])}},ARMCoreThumb.prototype.constructASR2=function(e,i){var s=this.cpu,r=s.gprs;return function(){s.mmu.waitPrefetch(r[s.PC]);var t=255&r[i];t&&(t<32?(s.cpsrC=r[e]&1<<t-1,r[e]>>=t):(s.cpsrC=r[e]>>31,s.cpsrC?r[e]=4294967295:r[e]=0)),s.cpsrN=r[e]>>31,s.cpsrZ=!(4294967295&r[e])}},ARMCoreThumb.prototype.constructB1=function(t,e){var i=this.cpu,s=i.gprs;return function(){i.mmu.waitPrefetch(s[i.PC]),e()&&(s[i.PC]+=t)}},ARMCoreThumb.prototype.constructB2=function(t){var e=this.cpu,i=e.gprs;return function(){e.mmu.waitPrefetch(i[e.PC]),i[e.PC]+=t}},ARMCoreThumb.prototype.constructBIC=function(t,e){var i=this.cpu,s=i.gprs;return function(){i.mmu.waitPrefetch(s[i.PC]),s[t]=s[t]&~s[e],i.cpsrN=s[t]>>31,i.cpsrZ=!(4294967295&s[t])}},ARMCoreThumb.prototype.constructBL1=function(t){var e=this.cpu,i=e.gprs;return function(){e.mmu.waitPrefetch(i[e.PC]),i[e.LR]=i[e.PC]+t}},ARMCoreThumb.prototype.constructBL2=function(e){var i=this.cpu,s=i.gprs;return function(){i.mmu.waitPrefetch(s[i.PC]);var t=s[i.PC];s[i.PC]=s[i.LR]+(e<<1),s[i.LR]=t-1}},ARMCoreThumb.prototype.constructBX=function(t,e){var i=this.cpu,s=i.gprs;return function(){i.mmu.waitPrefetch(s[i.PC]),i.switchExecMode(1&s[e]);var t=0;15==e&&(t=2&s[e]),s[i.PC]=s[e]&4294967294-t}},ARMCoreThumb.prototype.constructCMN=function(e,i){var s=this.cpu,r=s.gprs;return function(){s.mmu.waitPrefetch(r[s.PC]);var t=(r[e]>>>0)+(r[i]>>>0);s.cpsrN=t>>31,s.cpsrZ=!(4294967295&t),s.cpsrC=4294967295<t,s.cpsrV=r[e]>>31==r[i]>>31&&r[e]>>31!=t>>31&&r[i]>>31!=t>>31}},ARMCoreThumb.prototype.constructCMP1=function(e,i){var s=this.cpu,r=s.gprs;return function(){s.mmu.waitPrefetch(r[s.PC]);var t=r[e]-i;s.cpsrN=t>>31,s.cpsrZ=!(4294967295&t),s.cpsrC=r[e]>>>0>=i,s.cpsrV=r[e]>>31&&(r[e]^t)>>31}},ARMCoreThumb.prototype.constructCMP2=function(a,n){var o=this.cpu,h=o.gprs;return function(){o.mmu.waitPrefetch(h[o.PC]);var t=h[a],e=h[n],i=t-e,s=i>>31,r=t>>31;o.cpsrN=s,o.cpsrZ=!(4294967295&i),o.cpsrC=e>>>0<=t>>>0,o.cpsrV=r!=e>>31&&r!=s}},ARMCoreThumb.prototype.constructCMP3=function(e,i){var s=this.cpu,r=s.gprs;return function(){s.mmu.waitPrefetch(r[s.PC]);var t=r[e]-r[i];s.cpsrN=t>>31,s.cpsrZ=!(4294967295&t),s.cpsrC=r[e]>>>0>=r[i]>>>0,s.cpsrV=(r[e]^r[i])>>31&&(r[e]^t)>>31}},ARMCoreThumb.prototype.constructEOR=function(t,e){var i=this.cpu,s=i.gprs;return function(){i.mmu.waitPrefetch(s[i.PC]),s[t]=s[t]^s[e],i.cpsrN=s[t]>>31,i.cpsrZ=!(4294967295&s[t])}},ARMCoreThumb.prototype.constructLDMIA=function(r,a){var n=this.cpu,o=n.gprs;return function(){n.mmu.waitPrefetch(o[n.PC]);for(var t=o[r],e=0,i=1,s=0;s<8;i<<=1,++s)a&i&&(o[s]=n.mmu.load32(t),t+=4,++e);n.mmu.waitMulti32(t,e),1<<r&a||(o[r]=t)}},ARMCoreThumb.prototype.constructLDR1=function(e,i,s){var r=this.cpu,a=r.gprs;return function(){r.mmu.waitPrefetch(a[r.PC]);var t=a[i]+s;a[e]=r.mmu.load32(t),r.mmu.wait32(t),++r.cycles}},ARMCoreThumb.prototype.constructLDR2=function(t,e,i){var s=this.cpu,r=s.gprs;return function(){s.mmu.waitPrefetch(r[s.PC]),r[t]=s.mmu.load32(r[e]+r[i]),s.mmu.wait32(r[e]+r[i]),++s.cycles}},ARMCoreThumb.prototype.constructLDR3=function(t,e){var i=this.cpu,s=i.gprs;return function(){i.mmu.waitPrefetch(s[i.PC]),s[t]=i.mmu.load32((4294967292&s[i.PC])+e),i.mmu.wait32(s[i.PC]),++i.cycles}},ARMCoreThumb.prototype.constructLDR4=function(t,e){var i=this.cpu,s=i.gprs;return function(){i.mmu.waitPrefetch(s[i.PC]),s[t]=i.mmu.load32(s[i.SP]+e),i.mmu.wait32(s[i.SP]+e),++i.cycles}},ARMCoreThumb.prototype.constructLDRB1=function(e,i,s){var r=this.cpu,a=r.gprs;return function(){var t=a[i]+s;r.mmu.waitPrefetch(a[r.PC]),a[e]=r.mmu.loadU8(t),r.mmu.wait(t),++r.cycles}},ARMCoreThumb.prototype.constructLDRB2=function(t,e,i){var s=this.cpu,r=s.gprs;return function(){s.mmu.waitPrefetch(r[s.PC]),r[t]=s.mmu.loadU8(r[e]+r[i]),s.mmu.wait(r[e]+r[i]),++s.cycles}},ARMCoreThumb.prototype.constructLDRH1=function(e,i,s){var r=this.cpu,a=r.gprs;return function(){var t=a[i]+s;r.mmu.waitPrefetch(a[r.PC]),a[e]=r.mmu.loadU16(t),r.mmu.wait(t),++r.cycles}},ARMCoreThumb.prototype.constructLDRH2=function(t,e,i){var s=this.cpu,r=s.gprs;return function(){s.mmu.waitPrefetch(r[s.PC]),r[t]=s.mmu.loadU16(r[e]+r[i]),s.mmu.wait(r[e]+r[i]),++s.cycles}},ARMCoreThumb.prototype.constructLDRSB=function(t,e,i){var s=this.cpu,r=s.gprs;return function(){s.mmu.waitPrefetch(r[s.PC]),r[t]=s.mmu.load8(r[e]+r[i]),s.mmu.wait(r[e]+r[i]),++s.cycles}},ARMCoreThumb.prototype.constructLDRSH=function(t,e,i){var s=this.cpu,r=s.gprs;return function(){s.mmu.waitPrefetch(r[s.PC]),r[t]=s.mmu.load16(r[e]+r[i]),s.mmu.wait(r[e]+r[i]),++s.cycles}},ARMCoreThumb.prototype.constructLSL1=function(t,e,i){var s=this.cpu,r=s.gprs;return function(){s.mmu.waitPrefetch(r[s.PC]),0==i?r[t]=r[e]:(s.cpsrC=r[e]&1<<32-i,r[t]=r[e]<<i),s.cpsrN=r[t]>>31,s.cpsrZ=!(4294967295&r[t])}},ARMCoreThumb.prototype.constructLSL2=function(e,i){var s=this.cpu,r=s.gprs;return function(){s.mmu.waitPrefetch(r[s.PC]);var t=255&r[i];t&&(t<32?(s.cpsrC=r[e]&1<<32-t,r[e]<<=t):(s.cpsrC=32<t?0:1&r[e],r[e]=0)),s.cpsrN=r[e]>>31,s.cpsrZ=!(4294967295&r[e])}},ARMCoreThumb.prototype.constructLSR1=function(t,e,i){var s=this.cpu,r=s.gprs;return function(){s.mmu.waitPrefetch(r[s.PC]),0==i?(s.cpsrC=r[e]>>31,r[t]=0):(s.cpsrC=r[e]&1<<i-1,r[t]=r[e]>>>i),s.cpsrN=0,s.cpsrZ=!(4294967295&r[t])}},ARMCoreThumb.prototype.constructLSR2=function(e,i){var s=this.cpu,r=s.gprs;return function(){s.mmu.waitPrefetch(r[s.PC]);var t=255&r[i];t&&(t<32?(s.cpsrC=r[e]&1<<t-1,r[e]>>>=t):(s.cpsrC=32<t?0:r[e]>>31,r[e]=0)),s.cpsrN=r[e]>>31,s.cpsrZ=!(4294967295&r[e])}},ARMCoreThumb.prototype.constructMOV1=function(t,e){var i=this.cpu,s=i.gprs;return function(){i.mmu.waitPrefetch(s[i.PC]),s[t]=e,i.cpsrN=e>>31,i.cpsrZ=!(4294967295&e)}},ARMCoreThumb.prototype.constructMOV2=function(e,i,t){var s=this.cpu,r=s.gprs;return function(){s.mmu.waitPrefetch(r[s.PC]);var t=r[i];s.cpsrN=t>>31,s.cpsrZ=!(4294967295&t),s.cpsrC=0,s.cpsrV=0,r[e]=t}},ARMCoreThumb.prototype.constructMOV3=function(t,e){var i=this.cpu,s=i.gprs;return function(){i.mmu.waitPrefetch(s[i.PC]),s[t]=s[e]}},ARMCoreThumb.prototype.constructMUL=function(i,s){var r=this.cpu,a=r.gprs;return function(){var t,e;r.mmu.waitPrefetch(a[r.PC]),r.mmu.waitMul(a[s]),4294901760&a[s]&&4294901760&a[i]?(t=(4294901760&a[i])*a[s]&4294967295,e=(65535&a[i])*a[s]&4294967295,a[i]=t+e&4294967295):a[i]*=a[s],r.cpsrN=a[i]>>31,r.cpsrZ=!(4294967295&a[i])}},ARMCoreThumb.prototype.constructMVN=function(t,e){var i=this.cpu,s=i.gprs;return function(){i.mmu.waitPrefetch(s[i.PC]),s[t]=~s[e],i.cpsrN=s[t]>>31,i.cpsrZ=!(4294967295&s[t])}},ARMCoreThumb.prototype.constructNEG=function(e,i){var s=this.cpu,r=s.gprs;return function(){s.mmu.waitPrefetch(r[s.PC]);var t=-r[i];s.cpsrN=t>>31,s.cpsrZ=!(4294967295&t),s.cpsrC=t>>>0<=0,s.cpsrV=r[i]>>31&&t>>31,r[e]=t}},ARMCoreThumb.prototype.constructORR=function(t,e){var i=this.cpu,s=i.gprs;return function(){i.mmu.waitPrefetch(s[i.PC]),s[t]=s[t]|s[e],i.cpsrN=s[t]>>31,i.cpsrZ=!(4294967295&s[t])}},ARMCoreThumb.prototype.constructPOP=function(r,a){var n=this.cpu,o=n.gprs;return function(){n.mmu.waitPrefetch(o[n.PC]),++n.cycles;for(var t=o[n.SP],e=0,i=1,s=0;s<8;i<<=1,++s)r&i&&(n.mmu.waitSeq32(t),o[s]=n.mmu.load32(t),t+=4,++e);a&&(o[n.PC]=4294967294&n.mmu.load32(t),t+=4,++e),n.mmu.waitMulti32(t,e),o[n.SP]=t}},ARMCoreThumb.prototype.constructPUSH=function(r,a){var n=this.cpu,o=n.gprs;return function(){var t,e,i=o[n.SP]-4,s=0;for(n.mmu.waitPrefetch(o[n.PC]),a&&(n.mmu.store32(i,o[n.LR]),i-=4,++s),t=128,e=7;t;t>>=1,--e)if(r&t){n.mmu.store32(i,o[e]),i-=4,++s;break}for(t>>=1,--e;t;t>>=1,--e)r&t&&(n.mmu.store32(i,o[e]),i-=4,++s);n.mmu.waitMulti32(i,s),o[n.SP]=i+4}},ARMCoreThumb.prototype.constructROR=function(e,i){var s=this.cpu,r=s.gprs;return function(){s.mmu.waitPrefetch(r[s.PC]);var t=255&r[i];t&&(0<(t=31&t)?(s.cpsrC=r[e]&1<<t-1,r[e]=r[e]>>>t|r[e]<<32-t):s.cpsrC=r[e]>>31),s.cpsrN=r[e]>>31,s.cpsrZ=!(4294967295&r[e])}},ARMCoreThumb.prototype.constructSBC=function(i,s){var r=this.cpu,a=r.gprs;return function(){r.mmu.waitPrefetch(a[r.PC]);var t=(a[s]>>>0)+!r.cpsrC,e=(a[i]>>>0)-t;r.cpsrN=e>>31,r.cpsrZ=!(4294967295&e),r.cpsrC=a[i]>>>0>=e>>>0,r.cpsrV=(a[i]^t)>>31&&(a[i]^e)>>31,a[i]=e}},ARMCoreThumb.prototype.constructSTMIA=function(r,a){var n=this.cpu,o=n.gprs;return function(){n.mmu.wait(o[n.PC]);for(var t=o[r],e=0,i=1,s=0;s<8;i<<=1,++s)if(a&i){n.mmu.store32(t,o[s]),t+=4,++e;break}for(i<<=1,++s;s<8;i<<=1,++s)a&i&&(n.mmu.store32(t,o[s]),t+=4,++e);n.mmu.waitMulti32(t,e),o[r]=t}},ARMCoreThumb.prototype.constructSTR1=function(e,i,s){var r=this.cpu,a=r.gprs;return function(){var t=a[i]+s;r.mmu.store32(t,a[e]),r.mmu.wait(a[r.PC]),r.mmu.wait32(t)}},ARMCoreThumb.prototype.constructSTR2=function(t,e,i){var s=this.cpu,r=s.gprs;return function(){s.mmu.store32(r[e]+r[i],r[t]),s.mmu.wait(r[s.PC]),s.mmu.wait32(r[e]+r[i])}},ARMCoreThumb.prototype.constructSTR3=function(t,e){var i=this.cpu,s=i.gprs;return function(){i.mmu.store32(s[i.SP]+e,s[t]),i.mmu.wait(s[i.PC]),i.mmu.wait32(s[i.SP]+e)}},ARMCoreThumb.prototype.constructSTRB1=function(e,i,s){var r=this.cpu,a=r.gprs;return function(){var t=a[i]+s;r.mmu.store8(t,a[e]),r.mmu.wait(a[r.PC]),r.mmu.wait(t)}},ARMCoreThumb.prototype.constructSTRB2=function(t,e,i){var s=this.cpu,r=s.gprs;return function(){s.mmu.store8(r[e]+r[i],r[t]),s.mmu.wait(r[s.PC]),s.mmu.wait(r[e]+r[i])}},ARMCoreThumb.prototype.constructSTRH1=function(e,i,s){var r=this.cpu,a=r.gprs;return function(){var t=a[i]+s;r.mmu.store16(t,a[e]),r.mmu.wait(a[r.PC]),r.mmu.wait(t)}},ARMCoreThumb.prototype.constructSTRH2=function(t,e,i){var s=this.cpu,r=s.gprs;return function(){s.mmu.store16(r[e]+r[i],r[t]),s.mmu.wait(r[s.PC]),s.mmu.wait(r[e]+r[i])}},ARMCoreThumb.prototype.constructSUB1=function(e,i,s){var r=this.cpu,a=r.gprs;return function(){r.mmu.waitPrefetch(a[r.PC]);var t=a[i]-s;r.cpsrN=t>>31,r.cpsrZ=!(4294967295&t),r.cpsrC=a[i]>>>0>=s,r.cpsrV=a[i]>>31&&(a[i]^t)>>31,a[e]=t}},ARMCoreThumb.prototype.constructSUB2=function(e,i){var s=this.cpu,r=s.gprs;return function(){s.mmu.waitPrefetch(r[s.PC]);var t=r[e]-i;s.cpsrN=t>>31,s.cpsrZ=!(4294967295&t),s.cpsrC=r[e]>>>0>=i,s.cpsrV=r[e]>>31&&(r[e]^t)>>31,r[e]=t}},ARMCoreThumb.prototype.constructSUB3=function(e,i,s){var r=this.cpu,a=r.gprs;return function(){r.mmu.waitPrefetch(a[r.PC]);var t=a[i]-a[s];r.cpsrN=t>>31,r.cpsrZ=!(4294967295&t),r.cpsrC=a[i]>>>0>=a[s]>>>0,r.cpsrV=a[i]>>31!=a[s]>>31&&a[i]>>31!=t>>31,a[e]=t}},ARMCoreThumb.prototype.constructSWI=function(t){var e=this.cpu,i=e.gprs;return function(){e.irq.swi(t),e.mmu.waitPrefetch(i[e.PC])}},ARMCoreThumb.prototype.constructTST=function(e,i){var s=this.cpu,r=s.gprs;return function(){s.mmu.waitPrefetch(r[s.PC]);var t=r[e]&r[i];s.cpsrN=t>>31,s.cpsrZ=!(4294967295&t)}},Object.prototype.inherit=function(){for(var t in this)this[t]=this[t]},Serializer={TAG_INT:1,TAG_STRING:2,TAG_STRUCT:3,TAG_BLOB:4,TAG_BOOLEAN:5,TYPE:"application/octet-stream",pointer:function(){this.index=0,this.top=0,this.stack=[]},pack:function(t){var e=new DataView(new ArrayBuffer(4));return e.setUint32(0,t,!0),e.buffer},pack8:function(t){var e=new DataView(new ArrayBuffer(1));return e.setUint8(0,t,!0),e.buffer},prefix:function(t){return new Blob([Serializer.pack(t.size||t.length||t.byteLength),t],{type:Serializer.TYPE})},serialize:function(t){var e=[],s=4;for(i in t)if(t.hasOwnProperty(i)){var r,a,n=Serializer.prefix(i);switch(typeof t[i]){case"number":r=Serializer.TAG_INT,a=Serializer.pack(t[i]);break;case"string":r=Serializer.TAG_STRING,a=Serializer.prefix(t[i]);break;case"object":a=t[i].type==Serializer.TYPE?(r=Serializer.TAG_BLOB,t[i]):(r=Serializer.TAG_STRUCT,Serializer.serialize(t[i]));break;case"boolean":r=Serializer.TAG_BOOLEAN,a=Serializer.pack8(t[i]);break;default:console.log(t[i])}s+=1+n.size+(a.size||a.byteLength||a.length),e.push(Serializer.pack8(r)),e.push(n),e.push(a)}return e.unshift(Serializer.pack(s)),new Blob(e)},deserialize:function(t,e){var i=new FileReader;i.onload=function(t){e(Serializer.deserealizeStream(new DataView(t.target.result),new Serializer.pointer))},i.readAsArrayBuffer(t)},deserealizeStream:function(t,e){e.push();for(var i={},s=t.getUint32(e.advance(4),!0);e.mark()<s;){var r=t.getUint8(e.advance(1)),a=e.readString(t);switch(r){case Serializer.TAG_INT:o=t.getUint32(e.advance(4),!0);break;case Serializer.TAG_STRING:o=e.readString(t);break;case Serializer.TAG_STRUCT:o=Serializer.deserealizeStream(t,e);break;case Serializer.TAG_BLOB:var n=t.getUint32(e.advance(4),!0),o=t.buffer.slice(e.advance(n),e.advance(0));break;case Serializer.TAG_BOOLEAN:o=!!t.getUint8(e.advance(1))}i[a]=o}if(e.mark()>s)throw"Size of serialized data exceeded";return e.pop(),i},serializePNG:function(t,u,p){for(var d=document.createElement("canvas"),m=d.getContext("2d"),l=u.getContext("2d").getImageData(0,0,u.width,u.height),e=0,i=0;i<u.height;++i)for(var s=0;s<u.width;++s)l.data[4*(s+i*u.width)+3]||++e;for(var r=3*e+(u.width*u.height-e),A=1;r*A*A<t.size;++A);var a=r*A*A-t.size,f=Math.ceil(a/(u.width*A));d.setAttribute("width",u.width*A),d.setAttribute("height",u.height*A+f);a=new FileReader;return a.onload=function(t){for(var e=new Uint8Array(t.target.result),i=0,s=0,r=m.createImageData(d.width,d.height+f),a=0;a<d.height;++a)for(var n=0;n<d.width;++n){var o,h=a/A|0,c=n/A|0;h>u.height||!l.data[4*(c+h*u.width)+3]?(r.data[s++]=e[i++],r.data[s++]=e[i++],r.data[s++]=e[i++],r.data[s++]=0):(o=e[i++],r.data[s++]=l.data[4*(c+h*u.width)+0]|7&o,r.data[s++]=l.data[4*(c+h*u.width)+1]|o>>3&7,r.data[s++]=l.data[4*(c+h*u.width)+2]|o>>6&7,r.data[s++]=l.data[4*(c+h*u.width)+3])}m.putImageData(r,0,0),p(d.toDataURL("image/png"))},a.readAsArrayBuffer(t),d},deserializePNG:function(t,h){var e=new FileReader;e.onload=function(t){var e=document.createElement("img");e.setAttribute("src",t.target.result);var i=document.createElement("canvas");i.setAttribute("height",e.height),i.setAttribute("width",e.width);var s=i.getContext("2d");s.drawImage(e,0,0);for(var r=s.getImageData(0,0,i.width,i.height),t=[],a=0;a<i.height;++a)for(var n,o=0;o<i.width;++o)r.data[4*(o+a*i.width)+3]?(n=0,n|=7&r.data[4*(o+a*i.width)+0],n|=(7&r.data[4*(o+a*i.width)+1])<<3,n|=(7&r.data[4*(o+a*i.width)+2])<<6,t.push(n)):(t.push(r.data[4*(o+a*i.width)+0]),t.push(r.data[4*(o+a*i.width)+1]),t.push(r.data[4*(o+a*i.width)+2]));newBlob=new Blob(t.map(function(t){var e=new Uint8Array(1);return e[0]=t,e}),{type:Serializer.TYPE}),Serializer.deserialize(newBlob,h)},e.readAsDataURL(t)}},Serializer.pointer.prototype.advance=function(t){var e=this.index;return this.index+=t,e},Serializer.pointer.prototype.mark=function(){return this.index-this.top},Serializer.pointer.prototype.push=function(){this.stack.push(this.top),this.top=this.index},Serializer.pointer.prototype.pop=function(){this.top=this.stack.pop()},Serializer.pointer.prototype.readString=function(t){for(var e=t.getUint32(this.advance(4),!0),i=[],s=0;s<e;++s)i.push(String.fromCharCode(t.getUint8(this.advance(1))));return i.join("")},GameBoyAdvanceVideo.prototype.clear=function(){this.renderPath.clear(this.cpu.mmu),this.DISPSTAT_MASK=65336,this.inHblank=!1,this.inVblank=!1,this.vcounter=0,this.vblankIRQ=0,this.hblankIRQ=0,this.vcounterIRQ=0,this.vcountSetting=0,this.vcount=-1,this.lastHblank=0,this.nextHblank=this.HDRAW_LENGTH,this.nextEvent=this.nextHblank,this.nextHblankIRQ=0,this.nextVblankIRQ=0,this.nextVcounterIRQ=0},GameBoyAdvanceVideo.prototype.freeze=function(){return{inHblank:this.inHblank,inVblank:this.inVblank,vcounter:this.vcounter,vblankIRQ:this.vblankIRQ,hblankIRQ:this.hblankIRQ,vcounterIRQ:this.vcounterIRQ,vcountSetting:this.vcountSetting,vcount:this.vcount,lastHblank:this.lastHblank,nextHblank:this.nextHblank,nextEvent:this.nextEvent,nextHblankIRQ:this.nextHblankIRQ,nextVblankIRQ:this.nextVblankIRQ,nextVcounterIRQ:this.nextVcounterIRQ,renderPath:this.renderPath.freeze(this.core.encodeBase64)}},GameBoyAdvanceVideo.prototype.defrost=function(t){this.inHblank=t.inHblank,this.inVblank=t.inVblank,this.vcounter=t.vcounter,this.vblankIRQ=t.vblankIRQ,this.hblankIRQ=t.hblankIRQ,this.vcounterIRQ=t.vcounterIRQ,this.vcountSetting=t.vcountSetting,this.vcount=t.vcount,this.lastHblank=t.lastHblank,this.nextHblank=t.nextHblank,this.nextEvent=t.nextEvent,this.nextHblankIRQ=t.nextHblankIRQ,this.nextVblankIRQ=t.nextVblankIRQ,this.nextVcounterIRQ=t.nextVcounterIRQ,this.renderPath.defrost(t.renderPath,this.core.decodeBase64)},GameBoyAdvanceVideo.prototype.setBacking=function(t){var e=t.createImageData(this.HORIZONTAL_PIXELS,this.VERTICAL_PIXELS);this.context=t;for(var i=0;i<this.HORIZONTAL_PIXELS*this.VERTICAL_PIXELS*4;)e.data[i++]=255,e.data[i++]=255,e.data[i++]=255,e.data[i++]=255;this.renderPath.setBacking(e)},GameBoyAdvanceVideo.prototype.updateTimers=function(t){t=t.cycles;if(this.nextEvent<=t)if(this.inHblank){switch(this.inHblank=!1,this.nextEvent=this.nextHblank,++this.vcount,this.vcount){case this.VERTICAL_PIXELS:this.inVblank=!0,this.renderPath.finishDraw(this),this.nextVblankIRQ=this.nextEvent+this.TOTAL_LENGTH,this.cpu.mmu.runVblankDmas(),this.vblankIRQ&&this.cpu.irq.raiseIRQ(this.cpu.irq.IRQ_VBLANK),this.vblankCallback();break;case this.VERTICAL_TOTAL_PIXELS-1:this.inVblank=!1;break;case this.VERTICAL_TOTAL_PIXELS:this.vcount=0,this.renderPath.startDraw()}this.vcounter=this.vcount==this.vcountSetting,this.vcounter&&this.vcounterIRQ&&(this.cpu.irq.raiseIRQ(this.cpu.irq.IRQ_VCOUNTER),this.nextVcounterIRQ+=this.TOTAL_LENGTH),this.vcount<this.VERTICAL_PIXELS&&this.renderPath.drawScanline(this.vcount)}else this.inHblank=!0,this.lastHblank=this.nextHblank,this.nextEvent=this.lastHblank+this.HBLANK_LENGTH,this.nextHblank=this.nextEvent+this.HDRAW_LENGTH,this.nextHblankIRQ=this.nextHblank,this.vcount<this.VERTICAL_PIXELS&&this.cpu.mmu.runHblankDmas(),this.hblankIRQ&&this.cpu.irq.raiseIRQ(this.cpu.irq.IRQ_HBLANK)},GameBoyAdvanceVideo.prototype.writeDisplayStat=function(t){this.vblankIRQ=8&t,this.hblankIRQ=16&t,this.vcounterIRQ=32&t,this.vcountSetting=(65280&t)>>8,this.vcounterIRQ&&(this.nextVcounterIRQ=this.nextHblank+this.HBLANK_LENGTH+(this.vcountSetting-this.vcount)*this.HORIZONTAL_LENGTH,this.nextVcounterIRQ<this.nextEvent&&(this.nextVcounterIRQ+=this.TOTAL_LENGTH))},GameBoyAdvanceVideo.prototype.readDisplayStat=function(){return this.inVblank|this.inHblank<<1|this.vcounter<<2},GameBoyAdvanceVideo.prototype.finishDraw=function(t){this.context.putImageData(t,0,0),this.drawCallback()},ARMCoreArm=function(a){this.cpu=a,this.addressingMode23Immediate=[function(e,i,s){function t(){var t=r[e];return s&&!s()||(r[e]-=i),t}var r=a.gprs;return t.writesPC=e==a.PC,t},null,null,null,function(e,i,s){function t(){var t=r[e];return s&&!s()||(r[e]+=i),t}var r=a.gprs;return t.writesPC=e==a.PC,t},null,null,null,function(t,e,i){function s(){return addr=r[t]-e}var r=a.gprs;return s.writesPC=!1,s},function(e,i,s){function t(){var t=r[e]-i;return s&&!s()||(r[e]=t),t}var r=a.gprs;return t.writesPC=e==a.PC,t},null,null,function(t,e,i){function s(){return addr=r[t]+e}var r=a.gprs;return s.writesPC=!1,s},function(e,i,s){function t(){var t=r[e]+i;return s&&!s()||(r[e]=t),t}var r=a.gprs;return t.writesPC=e==a.PC,t},null,null],this.addressingMode23Register=[function(e,i,s){function t(){var t=r[e];return s&&!s()||(r[e]-=r[i]),t}var r=a.gprs;return t.writesPC=e==a.PC,t},null,null,null,function(e,i,s){function t(){var t=r[e];return s&&!s()||(r[e]+=r[i]),t}var r=a.gprs;return t.writesPC=e==a.PC,t},null,null,null,function(t,e,i){function s(){return r[t]-r[e]}var r=a.gprs;return s.writesPC=!1,s},function(e,i,s){function t(){var t=r[e]-r[i];return s&&!s()||(r[e]=t),t}var r=a.gprs;return t.writesPC=e==a.PC,t},null,null,function(t,e,i){function s(){return r[t]+r[e]}var r=a.gprs;return s.writesPC=!1,s},function(e,i,s){function t(){var t=r[e]+r[i];return s&&!s()||(r[e]=t),t}var r=a.gprs;return t.writesPC=e==a.PC,t},null,null],this.addressingMode2RegisterShifted=[function(e,i,s){function t(){var t=r[e];return s&&!s()||(i(),r[e]-=a.shifterOperand),t}var r=a.gprs;return t.writesPC=e==a.PC,t},null,null,null,function(e,i,s){function t(){var t=r[e];return s&&!s()||(i(),r[e]+=a.shifterOperand),t}var r=a.gprs;return t.writesPC=e==a.PC,t},null,null,null,function(t,e,i){function s(){return e(),r[t]-a.shifterOperand}var r=a.gprs;return s.writesPC=!1,s},function(e,i,s){function t(){i();var t=r[e]-a.shifterOperand;return s&&!s()||(r[e]=t),t}var r=a.gprs;return t.writesPC=e==a.PC,t},null,null,function(t,e,i){function s(){return e(),r[t]+a.shifterOperand}var r=a.gprs;return s.writesPC=!1,s},function(e,i,s){function t(){i();var t=r[e]+a.shifterOperand;return s&&!s()||(r[e]=t),t}var r=a.gprs;return t.writePC=e==a.PC,t},null,null]},ARMCoreArm.prototype.constructAddressingMode1ASR=function(i,s){var r=this.cpu,a=r.gprs;return function(){++r.cycles;var t=a[i];i==r.PC&&(t+=4),t&=255;var e=a[s];s==r.PC&&(e+=4),0==t?(r.shifterOperand=e,r.shifterCarryOut=r.cpsrC):t<32?(r.shifterOperand=e>>t,r.shifterCarryOut=e&1<<t-1):a[s]>>31?(r.shifterOperand=4294967295,r.shifterCarryOut=2147483648):(r.shifterOperand=0,r.shifterCarryOut=0)}},ARMCoreArm.prototype.constructAddressingMode1Immediate=function(t){var e=this.cpu;return function(){e.shifterOperand=t,e.shifterCarryOut=e.cpsrC}},ARMCoreArm.prototype.constructAddressingMode1ImmediateRotate=function(t,e){var i=this.cpu;return function(){i.shifterOperand=t>>>e|t<<32-e,i.shifterCarryOut=i.shifterOperand>>31}},ARMCoreArm.prototype.constructAddressingMode1LSL=function(i,s){var r=this.cpu,a=r.gprs;return function(){++r.cycles;var t=a[i];i==r.PC&&(t+=4),t&=255;var e=a[s];s==r.PC&&(e+=4),0==t?(r.shifterOperand=e,r.shifterCarryOut=r.cpsrC):t<32?(r.shifterOperand=e<<t,r.shifterCarryOut=e&1<<32-t):32==t?(r.shifterOperand=0,r.shifterCarryOut=1&e):(r.shifterOperand=0,r.shifterCarryOut=0)}},ARMCoreArm.prototype.constructAddressingMode1LSR=function(i,s){var r=this.cpu,a=r.gprs;return function(){++r.cycles;var t=a[i];i==r.PC&&(t+=4),t&=255;var e=a[s];s==r.PC&&(e+=4),0==t?(r.shifterOperand=e,r.shifterCarryOut=r.cpsrC):t<32?(r.shifterOperand=e>>>t,r.shifterCarryOut=e&1<<t-1):32==t?(r.shifterOperand=0,r.shifterCarryOut=e>>31):(r.shifterOperand=0,r.shifterCarryOut=0)}},ARMCoreArm.prototype.constructAddressingMode1ROR=function(s,r){var a=this.cpu,n=a.gprs;return function(){++a.cycles;var t=n[s];s==a.PC&&(t+=4),t&=255;var e=n[r];r==a.PC&&(e+=4);var i=31&t;0==t?(a.shifterOperand=e,a.shifterCarryOut=a.cpsrC):i?(a.shifterOperand=n[r]>>>i|n[r]<<32-i,a.shifterCarryOut=e&1<<i-1):(a.shifterOperand=e,a.shifterCarryOut=e>>31)}},ARMCoreArm.prototype.constructAddressingMode23Immediate=function(t,e,i){var s=(983040&t)>>16;return this.addressingMode23Immediate[(27262976&t)>>21](s,e,i)},ARMCoreArm.prototype.constructAddressingMode23Register=function(t,e,i){var s=(983040&t)>>16;return this.addressingMode23Register[(27262976&t)>>21](s,e,i)},ARMCoreArm.prototype.constructAddressingMode2RegisterShifted=function(t,e,i){var s=(983040&t)>>16;return this.addressingMode2RegisterShifted[(27262976&t)>>21](s,e,i)},ARMCoreArm.prototype.constructAddressingMode4=function(t,e){var i=this.cpu.gprs;return function(){return i[e]+t}},ARMCoreArm.prototype.constructAddressingMode4Writeback=function(i,s,r,a){var n=this.cpu,o=n.gprs;return function(t){var e=o[r]+i;return t&&a&&n.mmu.store32(o[r]+i-4,o[r]),o[r]+=s,e}},ARMCoreArm.prototype.constructADC=function(e,i,s,r){var a=this.cpu,n=a.gprs;return function(){var t;a.mmu.waitPrefetch32(n[a.PC]),r&&!r()||(s(),t=(a.shifterOperand>>>0)+!!a.cpsrC,n[e]=(n[i]>>>0)+t)}},ARMCoreArm.prototype.constructADCS=function(i,s,r,a){var n=this.cpu,o=n.gprs;return function(){var t,e;n.mmu.waitPrefetch32(o[n.PC]),a&&!a()||(r(),t=(n.shifterOperand>>>0)+!!n.cpsrC,e=(o[s]>>>0)+t,i==n.PC&&n.hasSPSR()?n.unpackCPSR(n.spsr):(n.cpsrN=e>>31,n.cpsrZ=!(4294967295&e),n.cpsrC=4294967295<e,n.cpsrV=o[s]>>31==t>>31&&o[s]>>31!=e>>31&&t>>31!=e>>31),o[i]=e)}},ARMCoreArm.prototype.constructADD=function(t,e,i,s){var r=this.cpu,a=r.gprs;return function(){r.mmu.waitPrefetch32(a[r.PC]),s&&!s()||(i(),a[t]=(a[e]>>>0)+(r.shifterOperand>>>0))}},ARMCoreArm.prototype.constructADDS=function(e,i,s,r){var a=this.cpu,n=a.gprs;return function(){var t;a.mmu.waitPrefetch32(n[a.PC]),r&&!r()||(s(),t=(n[i]>>>0)+(a.shifterOperand>>>0),e==a.PC&&a.hasSPSR()?a.unpackCPSR(a.spsr):(a.cpsrN=t>>31,a.cpsrZ=!(4294967295&t),a.cpsrC=4294967295<t,a.cpsrV=n[i]>>31==a.shifterOperand>>31&&n[i]>>31!=t>>31&&a.shifterOperand>>31!=t>>31),n[e]=t)}},ARMCoreArm.prototype.constructAND=function(t,e,i,s){var r=this.cpu,a=r.gprs;return function(){r.mmu.waitPrefetch32(a[r.PC]),s&&!s()||(i(),a[t]=a[e]&r.shifterOperand)}},ARMCoreArm.prototype.constructANDS=function(t,e,i,s){var r=this.cpu,a=r.gprs;return function(){r.mmu.waitPrefetch32(a[r.PC]),s&&!s()||(i(),a[t]=a[e]&r.shifterOperand,t==r.PC&&r.hasSPSR()?r.unpackCPSR(r.spsr):(r.cpsrN=a[t]>>31,r.cpsrZ=!(4294967295&a[t]),r.cpsrC=r.shifterCarryOut))}},ARMCoreArm.prototype.constructB=function(t,e){var i=this.cpu,s=i.gprs;return function(){!e||e()?(i.mmu.waitPrefetch32(s[i.PC]),s[i.PC]+=t):i.mmu.waitPrefetch32(s[i.PC])}},ARMCoreArm.prototype.constructBIC=function(t,e,i,s){var r=this.cpu,a=r.gprs;return function(){r.mmu.waitPrefetch32(a[r.PC]),s&&!s()||(i(),a[t]=a[e]&~r.shifterOperand)}},ARMCoreArm.prototype.constructBICS=function(t,e,i,s){var r=this.cpu,a=r.gprs;return function(){r.mmu.waitPrefetch32(a[r.PC]),s&&!s()||(i(),a[t]=a[e]&~r.shifterOperand,t==r.PC&&r.hasSPSR()?r.unpackCPSR(r.spsr):(r.cpsrN=a[t]>>31,r.cpsrZ=!(4294967295&a[t]),r.cpsrC=r.shifterCarryOut))}},ARMCoreArm.prototype.constructBL=function(t,e){var i=this.cpu,s=i.gprs;return function(){!e||e()?(i.mmu.waitPrefetch32(s[i.PC]),s[i.LR]=s[i.PC]-4,s[i.PC]+=t):i.mmu.waitPrefetch32(s[i.PC])}},ARMCoreArm.prototype.constructBX=function(t,e){var i=this.cpu,s=i.gprs;return function(){!e||e()?(i.mmu.waitPrefetch32(s[i.PC]),i.switchExecMode(1&s[t]),s[i.PC]=4294967294&s[t]):i.mmu.waitPrefetch32(s[i.PC])}},ARMCoreArm.prototype.constructCMN=function(t,e,i,s){var r=this.cpu,a=r.gprs;return function(){var t;r.mmu.waitPrefetch32(a[r.PC]),s&&!s()||(i(),t=(a[e]>>>0)+(r.shifterOperand>>>0),r.cpsrN=t>>31,r.cpsrZ=!(4294967295&t),r.cpsrC=4294967295<t,r.cpsrV=a[e]>>31==r.shifterOperand>>31&&a[e]>>31!=t>>31&&r.shifterOperand>>31!=t>>31)}},ARMCoreArm.prototype.constructCMP=function(t,e,i,s){var r=this.cpu,a=r.gprs;return function(){var t;r.mmu.waitPrefetch32(a[r.PC]),s&&!s()||(i(),t=a[e]-r.shifterOperand,r.cpsrN=t>>31,r.cpsrZ=!(4294967295&t),r.cpsrC=a[e]>>>0>=r.shifterOperand>>>0,r.cpsrV=a[e]>>31!=r.shifterOperand>>31&&a[e]>>31!=t>>31)}},ARMCoreArm.prototype.constructEOR=function(t,e,i,s){var r=this.cpu,a=r.gprs;return function(){r.mmu.waitPrefetch32(a[r.PC]),s&&!s()||(i(),a[t]=a[e]^r.shifterOperand)}},ARMCoreArm.prototype.constructEORS=function(t,e,i,s){var r=this.cpu,a=r.gprs;return function(){r.mmu.waitPrefetch32(a[r.PC]),s&&!s()||(i(),a[t]=a[e]^r.shifterOperand,t==r.PC&&r.hasSPSR()?r.unpackCPSR(r.spsr):(r.cpsrN=a[t]>>31,r.cpsrZ=!(4294967295&a[t]),r.cpsrC=r.shifterCarryOut))}},ARMCoreArm.prototype.constructLDM=function(r,a,n){var o=this.cpu,h=o.gprs,c=o.mmu;return function(){if(c.waitPrefetch32(h[o.PC]),!n||n()){for(var t=a(!1),e=0,i=r,s=0;i;i>>=1,++s)1&i&&(h[s]=c.load32(4294967292&t),t+=4,++e);c.waitMulti32(t,e),++o.cycles}}},ARMCoreArm.prototype.constructLDMS=function(a,n,o){var h=this.cpu,c=h.gprs,u=h.mmu;return function(){if(u.waitPrefetch32(c[h.PC]),!o||o()){var t,e,i=n(!1),s=0,r=h.mode;for(h.switchMode(h.MODE_SYSTEM),t=a,e=0;t;t>>=1,++e)1&t&&(c[e]=u.load32(4294967292&i),i+=4,++s);h.switchMode(r),u.waitMulti32(i,s),++h.cycles}}},ARMCoreArm.prototype.constructLDR=function(e,i,s){var r=this.cpu,a=r.gprs;return function(){var t;r.mmu.waitPrefetch32(a[r.PC]),s&&!s()||(t=i(),a[e]=r.mmu.load32(t),r.mmu.wait32(t),++r.cycles)}},ARMCoreArm.prototype.constructLDRB=function(e,i,s){var r=this.cpu,a=r.gprs;return function(){var t;r.mmu.waitPrefetch32(a[r.PC]),s&&!s()||(t=i(),a[e]=r.mmu.loadU8(t),r.mmu.wait(t),++r.cycles)}},ARMCoreArm.prototype.constructLDRH=function(e,i,s){var r=this.cpu,a=r.gprs;return function(){var t;r.mmu.waitPrefetch32(a[r.PC]),s&&!s()||(t=i(),a[e]=r.mmu.loadU16(t),r.mmu.wait(t),++r.cycles)}},ARMCoreArm.prototype.constructLDRSB=function(e,i,s){var r=this.cpu,a=r.gprs;return function(){var t;r.mmu.waitPrefetch32(a[r.PC]),s&&!s()||(t=i(),a[e]=r.mmu.load8(t),r.mmu.wait(t),++r.cycles)}},ARMCoreArm.prototype.constructLDRSH=function(e,i,s){var r=this.cpu,a=r.gprs;return function(){var t;r.mmu.waitPrefetch32(a[r.PC]),s&&!s()||(t=i(),a[e]=r.mmu.load16(t),r.mmu.wait(t),++r.cycles)}},ARMCoreArm.prototype.constructMLA=function(i,s,r,a,n){var o=this.cpu,h=o.gprs;return function(){var t,e;o.mmu.waitPrefetch32(h[o.PC]),n&&!n()||(++o.cycles,o.mmu.waitMul(r),4294901760&h[a]&&4294901760&h[r]?(t=(4294901760&h[a])*h[r]&4294967295,e=(65535&h[a])*h[r]&4294967295,h[i]=t+e+h[s]&4294967295):h[i]=h[a]*h[r]+h[s])}},ARMCoreArm.prototype.constructMLAS=function(i,s,r,a,n){var o=this.cpu,h=o.gprs;return function(){var t,e;o.mmu.waitPrefetch32(h[o.PC]),n&&!n()||(++o.cycles,o.mmu.waitMul(r),4294901760&h[a]&&4294901760&h[r]?(t=(4294901760&h[a])*h[r]&4294967295,e=(65535&h[a])*h[r]&4294967295,h[i]=t+e+h[s]&4294967295):h[i]=h[a]*h[r]+h[s],o.cpsrN=h[i]>>31,o.cpsrZ=!(4294967295&h[i]))}},ARMCoreArm.prototype.constructMOV=function(t,e,i,s){var r=this.cpu,a=r.gprs;return function(){r.mmu.waitPrefetch32(a[r.PC]),s&&!s()||(i(),a[t]=r.shifterOperand)}},ARMCoreArm.prototype.constructMOVS=function(t,e,i,s){var r=this.cpu,a=r.gprs;return function(){r.mmu.waitPrefetch32(a[r.PC]),s&&!s()||(i(),a[t]=r.shifterOperand,t==r.PC&&r.hasSPSR()?r.unpackCPSR(r.spsr):(r.cpsrN=a[t]>>31,r.cpsrZ=!(4294967295&a[t]),r.cpsrC=r.shifterCarryOut))}},ARMCoreArm.prototype.constructMRS=function(t,e,i){var s=this.cpu,r=s.gprs;return function(){s.mmu.waitPrefetch32(r[s.PC]),i&&!i()||(r[t]=e?s.spsr:s.packCPSR())}},ARMCoreArm.prototype.constructMSR=function(i,s,r,a,n){var o=this.cpu,h=o.gprs,c=65536&r,u=524288&r;return function(){var t,e;o.mmu.waitPrefetch32(h[o.PC]),n&&!n()||(t=33554432&r?a:h[i],e=(c?255:0)|(u?4278190080:0),s?(e&=o.USER_MASK|o.PRIV_MASK|o.STATE_MASK,o.spsr=o.spsr&~e|t&e):(e&o.USER_MASK&&(o.cpsrN=t>>31,o.cpsrZ=1073741824&t,o.cpsrC=536870912&t,o.cpsrV=268435456&t),o.mode!=o.MODE_USER&&e&o.PRIV_MASK&&(o.switchMode(15&t|16),o.cpsrI=128&t,o.cpsrF=64&t)))}},ARMCoreArm.prototype.constructMUL=function(i,s,r,a){var n=this.cpu,o=n.gprs;return function(){var t,e;n.mmu.waitPrefetch32(o[n.PC]),a&&!a()||(n.mmu.waitMul(o[s]),4294901760&o[r]&&4294901760&o[s]?(t=(4294901760&o[r])*o[s]|0,e=(65535&o[r])*o[s]|0,o[i]=t+e):o[i]=o[r]*o[s])}},ARMCoreArm.prototype.constructMULS=function(i,s,r,a){var n=this.cpu,o=n.gprs;return function(){var t,e;n.mmu.waitPrefetch32(o[n.PC]),a&&!a()||(n.mmu.waitMul(o[s]),4294901760&o[r]&&4294901760&o[s]?(t=(4294901760&o[r])*o[s]|0,e=(65535&o[r])*o[s]|0,o[i]=t+e):o[i]=o[r]*o[s],n.cpsrN=o[i]>>31,n.cpsrZ=!(4294967295&o[i]))}},ARMCoreArm.prototype.constructMVN=function(t,e,i,s){var r=this.cpu,a=r.gprs;return function(){r.mmu.waitPrefetch32(a[r.PC]),s&&!s()||(i(),a[t]=~r.shifterOperand)}},ARMCoreArm.prototype.constructMVNS=function(t,e,i,s){var r=this.cpu,a=r.gprs;return function(){r.mmu.waitPrefetch32(a[r.PC]),s&&!s()||(i(),a[t]=~r.shifterOperand,t==r.PC&&r.hasSPSR()?r.unpackCPSR(r.spsr):(r.cpsrN=a[t]>>31,r.cpsrZ=!(4294967295&a[t]),r.cpsrC=r.shifterCarryOut))}},ARMCoreArm.prototype.constructORR=function(t,e,i,s){var r=this.cpu,a=r.gprs;return function(){r.mmu.waitPrefetch32(a[r.PC]),s&&!s()||(i(),a[t]=a[e]|r.shifterOperand)}},ARMCoreArm.prototype.constructORRS=function(t,e,i,s){var r=this.cpu,a=r.gprs;return function(){r.mmu.waitPrefetch32(a[r.PC]),s&&!s()||(i(),a[t]=a[e]|r.shifterOperand,t==r.PC&&r.hasSPSR()?r.unpackCPSR(r.spsr):(r.cpsrN=a[t]>>31,r.cpsrZ=!(4294967295&a[t]),r.cpsrC=r.shifterCarryOut))}},ARMCoreArm.prototype.constructRSB=function(t,e,i,s){var r=this.cpu,a=r.gprs;return function(){r.mmu.waitPrefetch32(a[r.PC]),s&&!s()||(i(),a[t]=r.shifterOperand-a[e])}},ARMCoreArm.prototype.constructRSBS=function(e,i,s,r){var a=this.cpu,n=a.gprs;return function(){var t;a.mmu.waitPrefetch32(n[a.PC]),r&&!r()||(s(),t=a.shifterOperand-n[i],e==a.PC&&a.hasSPSR()?a.unpackCPSR(a.spsr):(a.cpsrN=t>>31,a.cpsrZ=!(4294967295&t),a.cpsrC=a.shifterOperand>>>0>=n[i]>>>0,a.cpsrV=a.shifterOperand>>31!=n[i]>>31&&a.shifterOperand>>31!=t>>31),n[e]=t)}},ARMCoreArm.prototype.constructRSC=function(e,i,s,r){var a=this.cpu,n=a.gprs;return function(){var t;a.mmu.waitPrefetch32(n[a.PC]),r&&!r()||(s(),t=(n[i]>>>0)+!a.cpsrC,n[e]=(a.shifterOperand>>>0)-t)}},ARMCoreArm.prototype.constructRSCS=function(i,s,r,a){var n=this.cpu,o=n.gprs;return function(){var t,e;n.mmu.waitPrefetch32(o[n.PC]),a&&!a()||(r(),t=(o[s]>>>0)+!n.cpsrC,e=(n.shifterOperand>>>0)-t,i==n.PC&&n.hasSPSR()?n.unpackCPSR(n.spsr):(n.cpsrN=e>>31,n.cpsrZ=!(4294967295&e),n.cpsrC=n.shifterOperand>>>0>=e>>>0,n.cpsrV=n.shifterOperand>>31!=t>>31&&n.shifterOperand>>31!=e>>31),o[i]=e)}},ARMCoreArm.prototype.constructSBC=function(e,i,s,r){var a=this.cpu,n=a.gprs;return function(){var t;a.mmu.waitPrefetch32(n[a.PC]),r&&!r()||(s(),t=(a.shifterOperand>>>0)+!a.cpsrC,n[e]=(n[i]>>>0)-t)}},ARMCoreArm.prototype.constructSBCS=function(i,s,r,a){var n=this.cpu,o=n.gprs;return function(){var t,e;n.mmu.waitPrefetch32(o[n.PC]),a&&!a()||(r(),t=(n.shifterOperand>>>0)+!n.cpsrC,e=(o[s]>>>0)-t,i==n.PC&&n.hasSPSR()?n.unpackCPSR(n.spsr):(n.cpsrN=e>>31,n.cpsrZ=!(4294967295&e),n.cpsrC=o[s]>>>0>=e>>>0,n.cpsrV=o[s]>>31!=t>>31&&o[s]>>31!=e>>31),o[i]=e)}},ARMCoreArm.prototype.constructSMLAL=function(i,s,r,a,n){var o=this.cpu,h=o.gprs;return function(){var t,e;o.mmu.waitPrefetch32(h[o.PC]),n&&!n()||(o.cycles+=2,o.mmu.waitMul(r),t=(4294901760&h[a])*h[r],e=(65535&h[a])*h[r],e=(h[s]>>>0)+t+e,h[s]=e,h[i]+=Math.floor(1/4294967296*e))}},ARMCoreArm.prototype.constructSMLALS=function(i,s,r,a,n){var o=this.cpu,h=o.gprs;return function(){var t,e;o.mmu.waitPrefetch32(h[o.PC]),n&&!n()||(o.cycles+=2,o.mmu.waitMul(r),t=(4294901760&h[a])*h[r],e=(65535&h[a])*h[r],e=(h[s]>>>0)+t+e,h[s]=e,h[i]+=Math.floor(1/4294967296*e),o.cpsrN=h[i]>>31,o.cpsrZ=!(4294967295&h[i]||4294967295&h[s]))}},ARMCoreArm.prototype.constructSMULL=function(i,s,r,a,n){var o=this.cpu,h=1/4294967296,c=o.gprs;return function(){var t,e;o.mmu.waitPrefetch32(c[o.PC]),n&&!n()||(++o.cycles,o.mmu.waitMul(c[r]),t=((4294901760&c[a])>>0)*(c[r]>>0),e=((65535&c[a])>>0)*(c[r]>>0),c[s]=(4294967295&t)+(4294967295&e)&4294967295,c[i]=Math.floor(t*h+e*h))}},ARMCoreArm.prototype.constructSMULLS=function(i,s,r,a,n){var o=this.cpu,h=1/4294967296,c=o.gprs;return function(){var t,e;o.mmu.waitPrefetch32(c[o.PC]),n&&!n()||(++o.cycles,o.mmu.waitMul(c[r]),t=((4294901760&c[a])>>0)*(c[r]>>0),e=((65535&c[a])>>0)*(c[r]>>0),c[s]=(4294967295&t)+(4294967295&e)&4294967295,c[i]=Math.floor(t*h+e*h),o.cpsrN=c[i]>>31,o.cpsrZ=!(4294967295&c[i]||4294967295&c[s]))}},ARMCoreArm.prototype.constructSTM=function(r,a,n){var o=this.cpu,h=o.gprs,c=o.mmu;return function(){if(!n||n()){c.wait32(h[o.PC]);for(var t=a(!0),e=0,i=r,s=0;i;i>>=1,++s)1&i&&(c.store32(t,h[s]),t+=4,++e);c.waitMulti32(t,e)}else c.waitPrefetch32(h[o.PC])}},ARMCoreArm.prototype.constructSTMS=function(a,n,o){var h=this.cpu,c=h.gprs,u=h.mmu;return function(){if(!o||o()){u.wait32(c[h.PC]);var t,e,i=h.mode,s=n(!0),r=0;for(h.switchMode(h.MODE_SYSTEM),t=a,e=0;t;t>>=1,++e)1&t&&(u.store32(s,c[e]),s+=4,++r);h.switchMode(i),u.waitMulti32(s,r)}else u.waitPrefetch32(c[h.PC])}},ARMCoreArm.prototype.constructSTR=function(e,i,s){var r=this.cpu,a=r.gprs;return function(){var t;!s||s()?(t=i(),r.mmu.store32(t,a[e]),r.mmu.wait32(t),r.mmu.wait32(a[r.PC])):r.mmu.waitPrefetch32(a[r.PC])}},ARMCoreArm.prototype.constructSTRB=function(e,i,s){var r=this.cpu,a=r.gprs;return function(){var t;!s||s()?(t=i(),r.mmu.store8(t,a[e]),r.mmu.wait(t),r.mmu.wait32(a[r.PC])):r.mmu.waitPrefetch32(a[r.PC])}},ARMCoreArm.prototype.constructSTRH=function(e,i,s){var r=this.cpu,a=r.gprs;return function(){var t;!s||s()?(t=i(),r.mmu.store16(t,a[e]),r.mmu.wait(t),r.mmu.wait32(a[r.PC])):r.mmu.waitPrefetch32(a[r.PC])}},ARMCoreArm.prototype.constructSUB=function(t,e,i,s){var r=this.cpu,a=r.gprs;return function(){r.mmu.waitPrefetch32(a[r.PC]),s&&!s()||(i(),a[t]=a[e]-r.shifterOperand)}},ARMCoreArm.prototype.constructSUBS=function(e,i,s,r){var a=this.cpu,n=a.gprs;return function(){var t;a.mmu.waitPrefetch32(n[a.PC]),r&&!r()||(s(),t=n[i]-a.shifterOperand,e==a.PC&&a.hasSPSR()?a.unpackCPSR(a.spsr):(a.cpsrN=t>>31,a.cpsrZ=!(4294967295&t),a.cpsrC=n[i]>>>0>=a.shifterOperand>>>0,a.cpsrV=n[i]>>31!=a.shifterOperand>>31&&n[i]>>31!=t>>31),n[e]=t)}},ARMCoreArm.prototype.constructSWI=function(t,e){var i=this.cpu,s=i.gprs;return function(){(!e||e())&&i.irq.swi32(t),i.mmu.waitPrefetch32(s[i.PC])}},ARMCoreArm.prototype.constructSWP=function(e,i,s,r){var a=this.cpu,n=a.gprs;return function(){var t;a.mmu.waitPrefetch32(n[a.PC]),r&&!r()||(a.mmu.wait32(n[i]),a.mmu.wait32(n[i]),t=a.mmu.load32(n[i]),a.mmu.store32(n[i],n[s]),n[e]=t,++a.cycles)}},ARMCoreArm.prototype.constructSWPB=function(e,i,s,r){var a=this.cpu,n=a.gprs;return function(){var t;a.mmu.waitPrefetch32(n[a.PC]),r&&!r()||(a.mmu.wait(n[i]),a.mmu.wait(n[i]),t=a.mmu.load8(n[i]),a.mmu.store8(n[i],n[s]),n[e]=t,++a.cycles)}},ARMCoreArm.prototype.constructTEQ=function(t,e,i,s){var r=this.cpu,a=r.gprs;return function(){var t;r.mmu.waitPrefetch32(a[r.PC]),s&&!s()||(i(),t=a[e]^r.shifterOperand,r.cpsrN=t>>31,r.cpsrZ=!(4294967295&t),r.cpsrC=r.shifterCarryOut)}},ARMCoreArm.prototype.constructTST=function(t,e,i,s){var r=this.cpu,a=r.gprs;return function(){var t;r.mmu.waitPrefetch32(a[r.PC]),s&&!s()||(i(),t=a[e]&r.shifterOperand,r.cpsrN=t>>31,r.cpsrZ=!(4294967295&t),r.cpsrC=r.shifterCarryOut)}},ARMCoreArm.prototype.constructUMLAL=function(i,s,r,a,n){var o=this.cpu,h=o.gprs;return function(){var t,e;o.mmu.waitPrefetch32(h[o.PC]),n&&!n()||(o.cycles+=2,o.mmu.waitMul(r),t=((4294901760&h[a])>>>0)*(h[r]>>>0),e=(65535&h[a])*(h[r]>>>0),e=(h[s]>>>0)+t+e,h[s]=e,h[i]+=1/4294967296*e)}},ARMCoreArm.prototype.constructUMLALS=function(i,s,r,a,n){var o=this.cpu,h=o.gprs;return function(){var t,e;o.mmu.waitPrefetch32(h[o.PC]),n&&!n()||(o.cycles+=2,o.mmu.waitMul(r),t=((4294901760&h[a])>>>0)*(h[r]>>>0),e=(65535&h[a])*(h[r]>>>0),e=(h[s]>>>0)+t+e,h[s]=e,h[i]+=1/4294967296*e,o.cpsrN=h[i]>>31,o.cpsrZ=!(4294967295&h[i]||4294967295&h[s]))}},ARMCoreArm.prototype.constructUMULL=function(i,s,r,a,n){var o=this.cpu,h=1/4294967296,c=o.gprs;return function(){var t,e;o.mmu.waitPrefetch32(c[o.PC]),n&&!n()||(++o.cycles,o.mmu.waitMul(c[r]),t=((4294901760&c[a])>>>0)*(c[r]>>>0),e=((65535&c[a])>>>0)*(c[r]>>>0),c[s]=(4294967295&t)+(4294967295&e)&4294967295,c[i]=t*h+e*h>>>0)}},ARMCoreArm.prototype.constructUMULLS=function(i,s,r,a,n){var o=this.cpu,h=1/4294967296,c=o.gprs;return function(){var t,e;o.mmu.waitPrefetch32(c[o.PC]),n&&!n()||(++o.cycles,o.mmu.waitMul(c[r]),t=((4294901760&c[a])>>>0)*(c[r]>>>0),e=((65535&c[a])>>>0)*(c[r]>>>0),c[s]=(4294967295&t)+(4294967295&e)&4294967295,c[i]=t*h+e*h>>>0,o.cpsrN=c[i]>>31,o.cpsrZ=!(4294967295&c[i]||4294967295&c[s]))}},GameBoyAdvanceAudio.prototype.clear=function(){if(this.fifoA=[],this.fifoB=[],this.fifoASample=0,this.fifoBSample=0,this.enabled=!1,this.context)try{this.jsAudio.disconnect(this.context.destination)}catch(t){}this.enableChannel3=!1,this.enableChannel4=!1,this.enableChannelA=!1,this.enableChannelB=!1,this.enableRightChannelA=!1,this.enableLeftChannelA=!1,this.enableRightChannelB=!1,this.enableLeftChannelB=!1,this.playingChannel3=!1,this.playingChannel4=!1,this.volumeLeft=0,this.volumeRight=0,this.ratioChannelA=1,this.ratioChannelB=1,this.enabledLeft=0,this.enabledRight=0,this.dmaA=-1,this.dmaB=-1,this.soundTimerA=0,this.soundTimerB=0,this.soundRatio=1,this.soundBias=512,this.squareChannels=new Array;for(var t=0;t<2;++t)this.squareChannels[t]={enabled:!1,playing:!1,sample:0,duty:.5,increment:0,step:0,initialVolume:0,volume:0,frequency:0,interval:0,sweepSteps:0,sweepIncrement:0,sweepInterval:0,doSweep:!1,raise:0,lower:0,nextStep:0,timed:!1,length:0,end:0};this.waveData=new Uint8Array(32),this.channel3Dimension=0,this.channel3Bank=0,this.channel3Volume=0,this.channel3Interval=0,this.channel3Next=0,this.channel3Length=0,this.channel3Timed=!1,this.channel3End=0,this.channel3Pointer=0,this.channel3Sample=0,this.cpuFrequency=this.core.irq.FREQUENCY,this.channel4={sample:0,lfsr:0,width:15,interval:this.cpuFrequency/524288,increment:0,step:0,initialVolume:0,volume:0,nextStep:0,timed:!1,length:0,end:0},this.nextEvent=0,this.nextSample=0,this.outputPointer=0,this.samplePointer=0,this.backup=0,this.totalSamples=0,this.sampleRate=32768,this.sampleInterval=this.cpuFrequency/this.sampleRate,this.resampleRatio=1,this.context&&(this.resampleRatio=this.sampleRate/this.context.sampleRate),this.writeSquareChannelFC(0,0),this.writeSquareChannelFC(1,0),this.writeChannel4FC(0)},GameBoyAdvanceAudio.prototype.freeze=function(){return{nextSample:this.nextSample}},GameBoyAdvanceAudio.prototype.defrost=function(t){this.nextSample=t.nextSample},GameBoyAdvanceAudio.prototype.pause=function(t){if(this.context)if(t)try{this.jsAudio.disconnect(this.context.destination)}catch(t){}else this.enabled&&this.jsAudio.connect(this.context.destination)},GameBoyAdvanceAudio.prototype.updateTimers=function(){var t,e,i=this.cpu.cycles;!this.enabled||i<this.nextEvent&&i<this.nextSample||(i>=this.nextEvent&&(t=this.squareChannels[0],this.nextEvent=1/0,t.playing&&this.updateSquareChannel(t,i),(t=this.squareChannels[1]).playing&&this.updateSquareChannel(t,i),this.enableChannel3&&this.playingChannel3&&(i>=this.channel3Next&&(this.channel3Write&&(e=this.waveData[this.channel3Pointer>>1],this.channel3Sample=((e>>((1&this.channel3Pointer)<<2)&15)-8)/8,this.channel3Pointer=this.channel3Pointer+1,this.channel3Dimension&&64<=this.channel3Pointer?this.channel3Pointer-=64:(!this.channel3Bank&&32<=this.channel3Pointer||64<=this.channel3Pointer)&&(this.channel3Pointer-=32)),this.channel3Next+=this.channel3Interval,this.channel3Interval&&this.nextEvent>this.channel3Next&&(this.nextEvent=this.channel3Next)),this.channel3Timed&&i>=this.channel3End&&(this.playingChannel3=!1)),this.enableChannel4&&this.playingChannel4&&(this.channel4.timed&&i>=this.channel4.end?this.playingChannel4=!1:(i>=this.channel4.next&&(this.channel4.lfsr>>=1,e=1&this.channel4.lfsr,this.channel4.lfsr|=(this.channel4.lfsr>>1&1^e)<<this.channel4.width-1,this.channel4.next+=this.channel4.interval,this.channel4.sample=2*(e-.5)*this.channel4.volume),this.updateEnvelope(this.channel4,i),this.nextEvent>this.channel4.next&&(this.nextEvent=this.channel4.next),this.channel4.timed&&this.nextEvent>this.channel4.end&&(this.nextEvent=this.channel4.end)))),i>=this.nextSample&&(this.sample(),this.nextSample+=this.sampleInterval),this.nextEvent=Math.ceil(this.nextEvent),(this.nextEvent<i||this.nextSample<i)&&this.updateTimers())},GameBoyAdvanceAudio.prototype.writeEnable=function(t){if(this.enabled=!!t,this.nextEvent=this.cpu.cycles,this.nextSample=this.nextEvent,this.updateTimers(),this.core.irq.pollNextEvent(),this.context)if(t)this.jsAudio.connect(this.context.destination);else try{this.jsAudio.disconnect(this.context.destination)}catch(t){}},GameBoyAdvanceAudio.prototype.writeSoundControlLo=function(t){this.masterVolumeLeft=7&t,this.masterVolumeRight=t>>4&7,this.enabledLeft=t>>8&15,this.enabledRight=t>>12&15,this.setSquareChannelEnabled(this.squareChannels[0],1&(this.enabledLeft|this.enabledRight)),this.setSquareChannelEnabled(this.squareChannels[1],2&(this.enabledLeft|this.enabledRight)),this.enableChannel3=4&(this.enabledLeft|this.enabledRight),this.setChannel4Enabled(8&(this.enabledLeft|this.enabledRight)),this.updateTimers(),this.core.irq.pollNextEvent()},GameBoyAdvanceAudio.prototype.writeSoundControlHi=function(t){switch(3&t){case 0:this.soundRatio=.25;break;case 1:this.soundRatio=.5;break;case 2:this.soundRatio=1}this.ratioChannelA=.5*(1+((4&t)>>2)),this.ratioChannelB=.5*(1+((8&t)>>3)),this.enableRightChannelA=256&t,this.enableLeftChannelA=512&t,this.enableChannelA=768&t,this.soundTimerA=1024&t,2048&t&&(this.fifoA=[]),this.enableRightChannelB=4096&t,this.enableLeftChannelB=8192&t,this.enableChannelB=12288&t,this.soundTimerB=16384&t,32768&t&&(this.fifoB=[])},GameBoyAdvanceAudio.prototype.resetSquareChannel=function(t){t.step&&(t.nextStep=this.cpu.cycles+t.step),t.enabled&&!t.playing&&(t.raise=this.cpu.cycles,t.lower=t.raise+t.duty*t.interval,t.end=this.cpu.cycles+t.length,this.nextEvent=this.cpu.cycles),t.playing=t.enabled,this.updateTimers(),this.core.irq.pollNextEvent()},GameBoyAdvanceAudio.prototype.setSquareChannelEnabled=function(t,e){t.enabled&&t.playing||!e?t.enabled=!!e:(t.enabled=!!e,this.updateTimers(),this.core.irq.pollNextEvent())},GameBoyAdvanceAudio.prototype.writeSquareChannelSweep=function(t,e){t=this.squareChannels[t];t.sweepSteps=7&e,t.sweepIncrement=8&e?-1:1,t.sweepInterval=(e>>4&7)*this.cpuFrequency/128,t.doSweep=!!t.sweepInterval,t.nextSweep=this.cpu.cycles+t.sweepInterval,this.resetSquareChannel(t)},GameBoyAdvanceAudio.prototype.writeSquareChannelDLE=function(t,e){var i=this.squareChannels[t];switch(e>>6&3){case 0:i.duty=.125;break;case 1:i.duty=.25;break;case 2:i.duty=.5;break;case 3:i.duty=.75}this.writeChannelLE(i,e),this.resetSquareChannel(i)},GameBoyAdvanceAudio.prototype.writeSquareChannelFC=function(t,e){var i=this.squareChannels[t],t=2047&e;i.frequency=t,i.interval=this.cpuFrequency*(2048-t)/131072,i.timed=!!(16384&e),32768&e&&(this.resetSquareChannel(i),i.volume=i.initialVolume)},GameBoyAdvanceAudio.prototype.updateSquareChannel=function(t,e){if(t.timed&&e>=t.end)t.playing=!1;else{if(t.doSweep&&e>=t.nextSweep){if(t.frequency+=t.sweepIncrement*(t.frequency>>t.sweepSteps),t.frequency<0)t.frequency=0;else if(2047<t.frequency)return t.frequency=2047,void(t.playing=!1);t.interval=this.cpuFrequency*(2048-t.frequency)/131072,t.nextSweep+=t.sweepInterval}e>=t.raise?(t.sample=t.volume,t.lower=t.raise+t.duty*t.interval,t.raise+=t.interval):e>=t.lower&&(t.sample=-t.volume,t.lower+=t.interval),this.updateEnvelope(t,e),this.nextEvent>t.raise&&(this.nextEvent=t.raise),this.nextEvent>t.lower&&(this.nextEvent=t.lower),t.timed&&this.nextEvent>t.end&&(this.nextEvent=t.end),t.doSweep&&this.nextEvent>t.nextSweep&&(this.nextEvent=t.nextSweep)}},GameBoyAdvanceAudio.prototype.writeChannel3Lo=function(t){this.channel3Dimension=32&t,this.channel3Bank=64&t;t&=128;!this.channel3Write&&t?(this.channel3Write=t,this.resetChannel3()):this.channel3Write=t},GameBoyAdvanceAudio.prototype.writeChannel3Hi=function(t){switch(this.channel3Length=this.cpuFrequency*(256-(255&t))/256,t>>13&7){case 0:this.channel3Volume=0;break;case 1:this.channel3Volume=1;break;case 2:this.channel3Volume=.5;break;case 3:this.channel3Volume=.25;break;default:this.channel3Volume=.75}},GameBoyAdvanceAudio.prototype.writeChannel3X=function(t){this.channel3Interval=this.cpuFrequency*(2048-(2047&t))/2097152,this.channel3Timed=!!(16384&t),this.channel3Write&&this.resetChannel3()},GameBoyAdvanceAudio.prototype.resetChannel3=function(){this.channel3Next=this.cpu.cycles,this.nextEvent=this.channel3Next,this.channel3End=this.cpu.cycles+this.channel3Length,this.playingChannel3=this.channel3Write,this.updateTimers(),this.core.irq.pollNextEvent()},GameBoyAdvanceAudio.prototype.writeWaveData=function(t,e,i){this.channel3Bank||(t+=16),2==i&&(this.waveData[t]=255&e,e>>=8,++t),this.waveData[t]=255&e},GameBoyAdvanceAudio.prototype.setChannel4Enabled=function(t){!this.enableChannel4&&t?(this.channel4.next=this.cpu.cycles,this.channel4.end=this.cpu.cycles+this.channel4.length,this.enableChannel4=!0,this.playingChannel4=!0,this.nextEvent=this.cpu.cycles,this.updateEnvelope(this.channel4),this.updateTimers(),this.core.irq.pollNextEvent()):this.enableChannel4=t},GameBoyAdvanceAudio.prototype.writeChannel4LE=function(t){this.writeChannelLE(this.channel4,t),this.resetChannel4()},GameBoyAdvanceAudio.prototype.writeChannel4FC=function(t){this.channel4.timed=!!(16384&t);var e=(e=7&t)||.5,i=t>>4&15,i=this.cpuFrequency*(e*(2<<i))/524288;i!=this.channel4.interval&&(this.channel4.interval=i,this.resetChannel4());i=8&t?7:15;i!=this.channel4.width&&(this.channel4.width=i,this.resetChannel4()),32768&t&&this.resetChannel4()},GameBoyAdvanceAudio.prototype.resetChannel4=function(){15==this.channel4.width?this.channel4.lfsr=16384:this.channel4.lfsr=64,this.channel4.volume=this.channel4.initialVolume,this.channel4.step&&(this.channel4.nextStep=this.cpu.cycles+this.channel4.step),this.channel4.end=this.cpu.cycles+this.channel4.length,this.channel4.next=this.cpu.cycles,this.nextEvent=this.channel4.next,this.playingChannel4=this.enableChannel4,this.updateTimers(),this.core.irq.pollNextEvent()},GameBoyAdvanceAudio.prototype.writeChannelLE=function(t,e){t.length=this.cpuFrequency*((64-(63&e))/256),t.increment=2048&e?1/16:-1/16,t.initialVolume=(e>>12&15)/16,t.step=this.cpuFrequency*((e>>8&7)/64)},GameBoyAdvanceAudio.prototype.updateEnvelope=function(t,e){t.step&&(e>=t.nextStep&&(t.volume+=t.increment,1<t.volume?t.volume=1:t.volume<0&&(t.volume=0),t.nextStep+=t.step),this.nextEvent>t.nextStep&&(this.nextEvent=t.nextStep))},GameBoyAdvanceAudio.prototype.appendToFifoA=function(t){var e;28<this.fifoA.length&&(this.fifoA=this.fifoA.slice(-28));for(var i=0;i<4;++i)e=(255&t)<<24,t>>=8,this.fifoA.push(e/2147483648)},GameBoyAdvanceAudio.prototype.appendToFifoB=function(t){var e;28<this.fifoB.length&&(this.fifoB=this.fifoB.slice(-28));for(var i=0;i<4;++i)e=(255&t)<<24,t>>=8,this.fifoB.push(e/2147483648)},GameBoyAdvanceAudio.prototype.sampleFifoA=function(){var t;this.fifoA.length<=16&&((t=this.core.irq.dma[this.dmaA]).nextCount=4,this.core.mmu.serviceDma(this.dmaA,t)),this.fifoASample=this.fifoA.shift()},GameBoyAdvanceAudio.prototype.sampleFifoB=function(){var t;this.fifoB.length<=16&&((t=this.core.irq.dma[this.dmaB]).nextCount=4,this.core.mmu.serviceDma(this.dmaB,t)),this.fifoBSample=this.fifoB.shift()},GameBoyAdvanceAudio.prototype.scheduleFIFODma=function(t,e){switch(e.dest){case this.cpu.mmu.BASE_IO|this.cpu.irq.io.FIFO_A_LO:e.dstControl=2,this.dmaA=t;break;case this.cpu.mmu.BASE_IO|this.cpu.irq.io.FIFO_B_LO:e.dstControl=2,this.dmaB=t;break;default:this.core.WARN("Tried to schedule FIFO DMA for non-FIFO destination")}},GameBoyAdvanceAudio.prototype.sample=function(){var t=0,e=0,i=this.squareChannels[0];i.playing&&(s=i.sample*this.soundRatio*this.PSG_MAX,1&this.enabledLeft&&(t+=s),1&this.enabledRight&&(e+=s)),(i=this.squareChannels[1]).playing&&(s=i.sample*this.soundRatio*this.PSG_MAX,2&this.enabledLeft&&(t+=s),2&this.enabledRight&&(e+=s)),this.playingChannel3&&(s=this.channel3Sample*this.soundRatio*this.channel3Volume*this.PSG_MAX,4&this.enabledLeft&&(t+=s),4&this.enabledRight&&(e+=s)),this.playingChannel4&&(s=this.channel4.sample*this.soundRatio*this.PSG_MAX,8&this.enabledLeft&&(t+=s),8&this.enabledRight&&(e+=s)),this.enableChannelA&&(s=this.fifoASample*this.FIFO_MAX*this.ratioChannelA,this.enableLeftChannelA&&(t+=s),this.enableRightChannelA&&(e+=s)),this.enableChannelB&&(s=this.fifoBSample*this.FIFO_MAX*this.ratioChannelB,this.enableLeftChannelB&&(t+=s),this.enableRightChannelB&&(e+=s));var s=this.samplePointer;t*=this.masterVolume/this.SOUND_MAX,t=Math.max(Math.min(t,1),-1),e*=this.masterVolume/this.SOUND_MAX,e=Math.max(Math.min(e,1),-1),this.buffers&&(this.buffers[0][s]=t,this.buffers[1][s]=e),this.samplePointer=s+1&this.sampleMask},GameBoyAdvanceAudio.prototype.audioProcess=function(t){var e=t.outputBuffer.getChannelData(0),i=t.outputBuffer.getChannelData(1);if(this.masterEnable){for(var s=this.outputPointer,r=0;r<this.bufferSize;++r,s+=this.resampleRatio){if(s>=this.maxSamples&&(s-=this.maxSamples),(0|s)==this.samplePointer){++this.backup;break}e[r]=this.buffers[0][0|s],i[r]=this.buffers[1][0|s]}for(;r<this.bufferSize;++r)e[r]=0,i[r]=0;this.outputPointer=s,++this.totalSamples}else for(r=0;r<this.bufferSize;++r)e[r]=0,i[r]=0},ARMCore.prototype.resetCPU=function(t){for(var e=0;e<this.PC;++e)this.gprs[e]=0;this.gprs[this.PC]=t+this.WORD_SIZE_ARM,this.loadInstruction=this.loadInstructionArm,this.execMode=this.MODE_ARM,this.instructionWidth=this.WORD_SIZE_ARM,this.mode=this.MODE_SYSTEM,this.cpsrI=!1,this.cpsrF=!1,this.cpsrV=!1,this.cpsrC=!1,this.cpsrZ=!1,this.cpsrN=!1,this.bankedRegisters=[new Int32Array(7),new Int32Array(7),new Int32Array(2),new Int32Array(2),new Int32Array(2),new Int32Array(2)],this.spsr=0,this.bankedSPSRs=new Int32Array(6),this.cycles=0,this.shifterOperand=0,this.shifterCarryOut=0,this.page=null,this.pageId=0,this.pageRegion=-1,this.instruction=null,this.irq.clear();var i=this.gprs,s=this.mmu;this.step=function(){var t,e=this.instruction||(this.instruction=this.loadInstruction(i[this.PC]-this.instructionWidth));i[this.PC]+=this.instructionWidth,this.conditionPassed=!0,e(),e.writesPC?this.conditionPassed?(t=i[this.PC]&=4294967294,this.execMode==this.MODE_ARM?(s.wait32(t),s.waitPrefetch32(t)):(s.wait(t),s.waitPrefetch(t)),i[this.PC]+=this.instructionWidth,e.fixedJump?null!=this.instruction&&(null!=e.next&&!e.next.page.invalid||(e.next=this.loadInstruction(i[this.PC]-this.instructionWidth)),this.instruction=e.next):this.instruction=null):this.instruction=null:null!=this.instruction&&(null!=e.next&&!e.next.page.invalid||(e.next=this.loadInstruction(i[this.PC]-this.instructionWidth)),this.instruction=e.next),this.irq.updateTimers()}},ARMCore.prototype.freeze=function(){return{gprs:[this.gprs[0],this.gprs[1],this.gprs[2],this.gprs[3],this.gprs[4],this.gprs[5],this.gprs[6],this.gprs[7],this.gprs[8],this.gprs[9],this.gprs[10],this.gprs[11],this.gprs[12],this.gprs[13],this.gprs[14],this.gprs[15]],mode:this.mode,cpsrI:this.cpsrI,cpsrF:this.cpsrF,cpsrV:this.cpsrV,cpsrC:this.cpsrC,cpsrZ:this.cpsrZ,cpsrN:this.cpsrN,bankedRegisters:[[this.bankedRegisters[0][0],this.bankedRegisters[0][1],this.bankedRegisters[0][2],this.bankedRegisters[0][3],this.bankedRegisters[0][4],this.bankedRegisters[0][5],this.bankedRegisters[0][6]],[this.bankedRegisters[1][0],this.bankedRegisters[1][1],this.bankedRegisters[1][2],this.bankedRegisters[1][3],this.bankedRegisters[1][4],this.bankedRegisters[1][5],this.bankedRegisters[1][6]],[this.bankedRegisters[2][0],this.bankedRegisters[2][1]],[this.bankedRegisters[3][0],this.bankedRegisters[3][1]],[this.bankedRegisters[4][0],this.bankedRegisters[4][1]],[this.bankedRegisters[5][0],this.bankedRegisters[5][1]]],spsr:this.spsr,bankedSPSRs:[this.bankedSPSRs[0],this.bankedSPSRs[1],this.bankedSPSRs[2],this.bankedSPSRs[3],this.bankedSPSRs[4],this.bankedSPSRs[5]],cycles:this.cycles}},ARMCore.prototype.defrost=function(t){this.instruction=null,this.page=null,this.pageId=0,this.pageRegion=-1,this.gprs[0]=t.gprs[0],this.gprs[1]=t.gprs[1],this.gprs[2]=t.gprs[2],this.gprs[3]=t.gprs[3],this.gprs[4]=t.gprs[4],this.gprs[5]=t.gprs[5],this.gprs[6]=t.gprs[6],this.gprs[7]=t.gprs[7],this.gprs[8]=t.gprs[8],this.gprs[9]=t.gprs[9],this.gprs[10]=t.gprs[10],this.gprs[11]=t.gprs[11],this.gprs[12]=t.gprs[12],this.gprs[13]=t.gprs[13],this.gprs[14]=t.gprs[14],this.gprs[15]=t.gprs[15],this.mode=t.mode,this.cpsrI=t.cpsrI,this.cpsrF=t.cpsrF,this.cpsrV=t.cpsrV,this.cpsrC=t.cpsrC,this.cpsrZ=t.cpsrZ,this.cpsrN=t.cpsrN,this.bankedRegisters[0][0]=t.bankedRegisters[0][0],this.bankedRegisters[0][1]=t.bankedRegisters[0][1],this.bankedRegisters[0][2]=t.bankedRegisters[0][2],this.bankedRegisters[0][3]=t.bankedRegisters[0][3],this.bankedRegisters[0][4]=t.bankedRegisters[0][4],this.bankedRegisters[0][5]=t.bankedRegisters[0][5],this.bankedRegisters[0][6]=t.bankedRegisters[0][6],this.bankedRegisters[1][0]=t.bankedRegisters[1][0],this.bankedRegisters[1][1]=t.bankedRegisters[1][1],this.bankedRegisters[1][2]=t.bankedRegisters[1][2],this.bankedRegisters[1][3]=t.bankedRegisters[1][3],this.bankedRegisters[1][4]=t.bankedRegisters[1][4],this.bankedRegisters[1][5]=t.bankedRegisters[1][5],this.bankedRegisters[1][6]=t.bankedRegisters[1][6],this.bankedRegisters[2][0]=t.bankedRegisters[2][0],this.bankedRegisters[2][1]=t.bankedRegisters[2][1],this.bankedRegisters[3][0]=t.bankedRegisters[3][0],this.bankedRegisters[3][1]=t.bankedRegisters[3][1],this.bankedRegisters[4][0]=t.bankedRegisters[4][0],this.bankedRegisters[4][1]=t.bankedRegisters[4][1],this.bankedRegisters[5][0]=t.bankedRegisters[5][0],this.bankedRegisters[5][1]=t.bankedRegisters[5][1],this.spsr=t.spsr,this.bankedSPSRs[0]=t.bankedSPSRs[0],this.bankedSPSRs[1]=t.bankedSPSRs[1],this.bankedSPSRs[2]=t.bankedSPSRs[2],this.bankedSPSRs[3]=t.bankedSPSRs[3],this.bankedSPSRs[4]=t.bankedSPSRs[4],this.bankedSPSRs[5]=t.bankedSPSRs[5],this.cycles=t.cycles},ARMCore.prototype.fetchPage=function(t){var e=t>>this.mmu.BASE_OFFSET,t=this.mmu.addressToPage(e,t&this.mmu.OFFSET_MASK);if(e==this.pageRegion){if(t==this.pageId&&!this.page.invalid)return;this.pageId=t}else this.pageMask=this.mmu.memory[e].PAGE_MASK,this.pageRegion=e,this.pageId=t;this.page=this.mmu.accessPage(e,t)},ARMCore.prototype.loadInstructionArm=function(t){var e=null;this.fetchPage(t);var i=(t&this.pageMask)>>2;if(e=this.page.arm[i])return e;var s=this.mmu.load32(t)>>>0;return(e=this.compileArm(s)).next=null,e.page=this.page,e.address=t,e.opcode=s,this.page.arm[i]=e},ARMCore.prototype.loadInstructionThumb=function(t){var e=null;this.fetchPage(t);var i=(t&this.pageMask)>>1;if(e=this.page.thumb[i])return e;var s=this.mmu.load16(t);return(e=this.compileThumb(s)).next=null,e.page=this.page,e.address=t,e.opcode=s,this.page.thumb[i]=e},ARMCore.prototype.selectBank=function(t){switch(t){case this.MODE_USER:case this.MODE_SYSTEM:return this.BANK_NONE;case this.MODE_FIQ:return this.BANK_FIQ;case this.MODE_IRQ:return this.BANK_IRQ;case this.MODE_SUPERVISOR:return this.BANK_SUPERVISOR;case this.MODE_ABORT:return this.BANK_ABORT;case this.MODE_UNDEFINED:return this.BANK_UNDEFINED;default:throw"Invalid user mode passed to selectBank"}},ARMCore.prototype.switchExecMode=function(t){this.execMode!=t&&((this.execMode=t)==this.MODE_ARM?(this.instructionWidth=this.WORD_SIZE_ARM,this.loadInstruction=this.loadInstructionArm):(this.instructionWidth=this.WORD_SIZE_THUMB,this.loadInstruction=this.loadInstructionThumb))},ARMCore.prototype.switchMode=function(t){var e,i,s,r;t!=this.mode&&(t==this.MODE_USER&&t==this.MODE_SYSTEM||(e=this.selectBank(t))!=(i=this.selectBank(this.mode))&&(t!=this.MODE_FIQ&&this.mode!=this.MODE_FIQ||(s=+(i==this.BANK_FIQ),r=+(e==this.BANK_FIQ),this.bankedRegisters[s][2]=this.gprs[8],this.bankedRegisters[s][3]=this.gprs[9],this.bankedRegisters[s][4]=this.gprs[10],this.bankedRegisters[s][5]=this.gprs[11],this.bankedRegisters[s][6]=this.gprs[12],this.gprs[8]=this.bankedRegisters[r][2],this.gprs[9]=this.bankedRegisters[r][3],this.gprs[10]=this.bankedRegisters[r][4],this.gprs[11]=this.bankedRegisters[r][5],this.gprs[12]=this.bankedRegisters[r][6]),this.bankedRegisters[i][0]=this.gprs[this.SP],this.bankedRegisters[i][1]=this.gprs[this.LR],this.gprs[this.SP]=this.bankedRegisters[e][0],this.gprs[this.LR]=this.bankedRegisters[e][1],this.bankedSPSRs[i]=this.spsr,this.spsr=this.bankedSPSRs[e]),this.mode=t)},ARMCore.prototype.packCPSR=function(){return this.mode|!!this.execMode<<5|!!this.cpsrF<<6|!!this.cpsrI<<7|!!this.cpsrN<<31|!!this.cpsrZ<<30|!!this.cpsrC<<29|!!this.cpsrV<<28},ARMCore.prototype.unpackCPSR=function(t){this.switchMode(31&t),this.switchExecMode(!!(32&t)),this.cpsrF=64&t,this.cpsrI=128&t,this.cpsrN=2147483648&t,this.cpsrZ=1073741824&t,this.cpsrC=536870912&t,this.cpsrV=268435456&t,this.irq.testIRQ()},ARMCore.prototype.hasSPSR=function(){return this.mode!=this.MODE_SYSTEM&&this.mode!=this.MODE_USER},ARMCore.prototype.raiseIRQ=function(){var t,e;this.cpsrI||(t=this.packCPSR(),e=this.instructionWidth,this.switchMode(this.MODE_IRQ),this.spsr=t,this.gprs[this.LR]=this.gprs[this.PC]-e+4,this.gprs[this.PC]=this.BASE_IRQ+this.WORD_SIZE_ARM,this.instruction=null,this.switchExecMode(this.MODE_ARM),this.cpsrI=!0)},ARMCore.prototype.raiseTrap=function(){var t=this.packCPSR(),e=this.instructionWidth;this.switchMode(this.MODE_SUPERVISOR),this.spsr=t,this.gprs[this.LR]=this.gprs[this.PC]-e,this.gprs[this.PC]=this.BASE_SWI+this.WORD_SIZE_ARM,this.instruction=null,this.switchExecMode(this.MODE_ARM),this.cpsrI=!0},ARMCore.prototype.badOp=function(t){function e(){throw"Illegal instruction: 0x"+t.toString(16)}return e.writesPC=!0,e.fixedJump=!1,e},ARMCore.prototype.generateConds=function(){var t=this;this.conds=[function(){return t.conditionPassed=t.cpsrZ},function(){return t.conditionPassed=!t.cpsrZ},function(){return t.conditionPassed=t.cpsrC},function(){return t.conditionPassed=!t.cpsrC},function(){return t.conditionPassed=t.cpsrN},function(){return t.conditionPassed=!t.cpsrN},function(){return t.conditionPassed=t.cpsrV},function(){return t.conditionPassed=!t.cpsrV},function(){return t.conditionPassed=t.cpsrC&&!t.cpsrZ},function(){return t.conditionPassed=!t.cpsrC||t.cpsrZ},function(){return t.conditionPassed=!t.cpsrN==!t.cpsrV},function(){return t.conditionPassed=!t.cpsrN!=!t.cpsrV},function(){return t.conditionPassed=!t.cpsrZ&&!t.cpsrN==!t.cpsrV},function(){return t.conditionPassed=t.cpsrZ||!t.cpsrN!=!t.cpsrV},null,null]},ARMCore.prototype.barrelShiftImmediate=function(t,e,i){var s=this,r=this.gprs,a=this.badOp;switch(t){case 0:a=e?function(){s.shifterOperand=r[i]<<e,s.shifterCarryOut=r[i]&1<<32-e}:function(){s.shifterOperand=r[i],s.shifterCarryOut=s.cpsrC};break;case 32:a=e?function(){s.shifterOperand=r[i]>>>e,s.shifterCarryOut=r[i]&1<<e-1}:function(){s.shifterOperand=0,s.shifterCarryOut=2147483648&r[i]};break;case 64:a=e?function(){s.shifterOperand=r[i]>>e,s.shifterCarryOut=r[i]&1<<e-1}:function(){s.shifterCarryOut=2147483648&r[i],s.shifterCarryOut?s.shifterOperand=4294967295:s.shifterOperand=0};break;case 96:a=e?function(){s.shifterOperand=r[i]>>>e|r[i]<<32-e,s.shifterCarryOut=r[i]&1<<e-1}:function(){s.shifterOperand=!!s.cpsrC<<31|r[i]>>>1,s.shifterCarryOut=1&r[i]}}return a},ARMCore.prototype.compileArm=function(t){var e=this.badOp(t),i=234881024&t,s=(this.gprs,this.conds[(4026531840&t)>>>28]);if(19922704==(268435440&t)){var r=15&t;(e=this.armCompiler.constructBX(r,s)).writesPC=!0,e.fixedJump=!1}else if(201326592&t||33554432!=i&&144==(144&t))if(16777360==(263196656&t)){r=15&t,n=t>>12&15,l=t>>16&15;(e=4194304&t?this.armCompiler.constructSWPB(n,l,r,s):this.armCompiler.constructSWP(n,l,r,s)).writesPC=n==this.PC}else switch(i){case 0:if(144==(16777456&t)){n=(983040&t)>>16,l=(61440&t)>>12,m=(3840&t)>>8,r=15&t;switch(15728640&t){case 0:e=this.armCompiler.constructMUL(n,m,r,s);break;case 1048576:e=this.armCompiler.constructMULS(n,m,r,s);break;case 2097152:e=this.armCompiler.constructMLA(n,l,m,r,s);break;case 3145728:e=this.armCompiler.constructMLAS(n,l,m,r,s);break;case 8388608:e=this.armCompiler.constructUMULL(n,l,m,r,s);break;case 9437184:e=this.armCompiler.constructUMULLS(n,l,m,r,s);break;case 10485760:e=this.armCompiler.constructUMLAL(n,l,m,r,s);break;case 11534336:e=this.armCompiler.constructUMLALS(n,l,m,r,s);break;case 12582912:e=this.armCompiler.constructSMULL(n,l,m,r,s);break;case 13631488:e=this.armCompiler.constructSMULLS(n,l,m,r,s);break;case 14680064:e=this.armCompiler.constructSMLAL(n,l,m,r,s);break;case 15728640:e=this.armCompiler.constructSMLALS(n,l,m,r,s)}e.writesPC=n==this.PC}else{var a=1048576&t,n=(61440&t)>>12,o=r=15&t,h=32&t,c=64&t,u=2097152&t;(o=(i=4194304&t)?(A=o|(3840&t)>>4,this.armCompiler.constructAddressingMode23Immediate(t,A,s)):this.armCompiler.constructAddressingMode23Register(t,r,s)).writesPC=!!u&&l==this.PC,144==(144&t)&&(a?h?e=c?this.armCompiler.constructLDRSH(n,o,s):this.armCompiler.constructLDRH(n,o,s):c&&(e=this.armCompiler.constructLDRSB(n,o,s)):!c&&h&&(e=this.armCompiler.constructSTRH(n,o,s))),e.writesPC=n==this.PC||o.writesPC}break;case 67108864:case 100663296:var n=(61440&t)>>12,a=1048576&t,p=4194304&t,i=33554432&t,o=function(){throw"Unimplemented memory access: 0x"+t.toString(16)};16777216&~t&&(t&=4292870143),o=i?(r=15&t,d=(3968&t)>>7,(C=96&t)||d?(v=this.barrelShiftImmediate(C,d,r),this.armCompiler.constructAddressingMode2RegisterShifted(t,v,s)):this.armCompiler.constructAddressingMode23Register(t,r,s)):(f=4095&t,this.armCompiler.constructAddressingMode23Immediate(t,f,s)),(e=a?p?this.armCompiler.constructLDRB(n,o,s):this.armCompiler.constructLDR(n,o,s):p?this.armCompiler.constructSTRB(n,o,s):this.armCompiler.constructSTR(n,o,s)).writesPC=n==this.PC||o.writesPC;break;case 134217728:var a=1048576&t,u=2097152&t,d=4194304&t,p=16777216&t,m=65535&t,l=(983040&t)>>16,A=0,f=0,y=!1;if(8388608&t){p&&(A=4);for(var R=1,i=0;i<16;R<<=1,++i)m&R&&(u&&i==l&&!f&&(m&=~R,A+=4,y=!0),f+=4)}else{p||(A=4);for(R=1,i=0;i<16;R<<=1,++i)m&R&&(u&&i==l&&!f&&(m&=~R,A+=4,y=!0),A-=4,f-=4)}o=u?this.armCompiler.constructAddressingMode4Writeback(A,f,l,y):this.armCompiler.constructAddressingMode4(A,l),a?(e=d?this.armCompiler.constructLDMS(m,o,s):this.armCompiler.constructLDM(m,o,s)).writesPC=!!(32768&m):(e=d?this.armCompiler.constructSTMS(m,o,s):this.armCompiler.constructSTM(m,o,s)).writesPC=!1;break;case 167772160:8388608&(A=16777215&t)&&(A|=4278190080),A<<=2,(e=16777216&t?this.armCompiler.constructBL(A,s):this.armCompiler.constructB(A,s)).writesPC=!0,e.fixedJump=!0;break;case 201326592:break;case 234881024:251658240==(251658240&t)&&(A=16777215&t,(e=this.armCompiler.constructSWI(A,s)).writesPC=!1);break;default:throw"Bad opcode: 0x"+t.toString(16)}else{var S=31457280&t,c=1048576&t;if(16777216!=(25165824&S)||c){var l=(983040&t)>>16,n=(61440&t)>>12,C=96&t,r=15&t,v=function(){throw"BUG: invalid barrel shifter"};if(33554432&t){var A=255&t,b=(3840&t)>>7;v=b?this.armCompiler.constructAddressingMode1ImmediateRotate(A,b):this.armCompiler.constructAddressingMode1Immediate(A)}else if(16&t){var m=(3840&t)>>8;switch(C){case 0:v=this.armCompiler.constructAddressingMode1LSL(m,r);break;case 32:v=this.armCompiler.constructAddressingMode1LSR(m,r);break;case 64:v=this.armCompiler.constructAddressingMode1ASR(m,r);break;case 96:v=this.armCompiler.constructAddressingMode1ROR(m,r)}}else{var A=(3968&t)>>7;v=this.barrelShiftImmediate(C,A,r)}switch(S){case 0:e=c?this.armCompiler.constructANDS(n,l,v,s):this.armCompiler.constructAND(n,l,v,s);break;case 2097152:e=c?this.armCompiler.constructEORS(n,l,v,s):this.armCompiler.constructEOR(n,l,v,s);break;case 4194304:e=c?this.armCompiler.constructSUBS(n,l,v,s):this.armCompiler.constructSUB(n,l,v,s);break;case 6291456:e=c?this.armCompiler.constructRSBS(n,l,v,s):this.armCompiler.constructRSB(n,l,v,s);break;case 8388608:e=c?this.armCompiler.constructADDS(n,l,v,s):this.armCompiler.constructADD(n,l,v,s);break;case 10485760:e=c?this.armCompiler.constructADCS(n,l,v,s):this.armCompiler.constructADC(n,l,v,s);break;case 12582912:e=c?this.armCompiler.constructSBCS(n,l,v,s):this.armCompiler.constructSBC(n,l,v,s);break;case 14680064:e=c?this.armCompiler.constructRSCS(n,l,v,s):this.armCompiler.constructRSC(n,l,v,s);break;case 16777216:e=this.armCompiler.constructTST(n,l,v,s);break;case 18874368:e=this.armCompiler.constructTEQ(n,l,v,s);break;case 20971520:e=this.armCompiler.constructCMP(n,l,v,s);break;case 23068672:e=this.armCompiler.constructCMN(n,l,v,s);break;case 25165824:e=c?this.armCompiler.constructORRS(n,l,v,s):this.armCompiler.constructORR(n,l,v,s);break;case 27262976:e=c?this.armCompiler.constructMOVS(n,l,v,s):this.armCompiler.constructMOV(n,l,v,s);break;case 29360128:e=c?this.armCompiler.constructBICS(n,l,v,s):this.armCompiler.constructBIC(n,l,v,s);break;case 31457280:e=c?this.armCompiler.constructMVNS(n,l,v,s):this.armCompiler.constructMVN(n,l,v,s)}e.writesPC=n==this.PC}else{b=4194304&t;2158592==(11595776&t)?(r=15&t,A=(A=255&t)>>>(S=(3840&t)>>7)|A<<32-S,(e=this.armCompiler.constructMSR(r,b,t,A,s)).writesPC=!1):983040==(12517376&t)&&(n=(61440&t)>>12,(e=this.armCompiler.constructMRS(n,b,s)).writesPC=n==this.PC)}}return e.execMode=this.MODE_ARM,e.fixedJump=e.fixedJump||!1,e},ARMCore.prototype.compileThumb=function(t){var e=this.badOp(65535&t);this.gprs;if(16384==(64512&t)){var i=(56&t)>>3,s=7&t;switch(960&t){case 0:e=this.thumbCompiler.constructAND(s,i);break;case 64:e=this.thumbCompiler.constructEOR(s,i);break;case 128:e=this.thumbCompiler.constructLSL2(s,i);break;case 192:e=this.thumbCompiler.constructLSR2(s,i);break;case 256:e=this.thumbCompiler.constructASR2(s,i);break;case 320:e=this.thumbCompiler.constructADC(s,i);break;case 384:e=this.thumbCompiler.constructSBC(s,i);break;case 448:e=this.thumbCompiler.constructROR(s,i);break;case 512:e=this.thumbCompiler.constructTST(s,i);break;case 576:e=this.thumbCompiler.constructNEG(s,i);break;case 640:e=this.thumbCompiler.constructCMP2(s,i);break;case 704:e=this.thumbCompiler.constructCMN(s,i);break;case 768:e=this.thumbCompiler.constructORR(s,i);break;case 832:e=this.thumbCompiler.constructMUL(s,i);break;case 896:e=this.thumbCompiler.constructBIC(s,i);break;case 960:e=this.thumbCompiler.constructMVN(s,i)}e.writesPC=!1}else if(17408==(64512&t)){i=(120&t)>>3,s=(r=7&t)|(128&t)>>4;switch(768&t){case 0:(e=this.thumbCompiler.constructADD4(s,i)).writesPC=s==this.PC;break;case 256:(e=this.thumbCompiler.constructCMP3(s,i)).writesPC=!1;break;case 512:(e=this.thumbCompiler.constructMOV3(s,i)).writesPC=s==this.PC;break;case 768:(e=this.thumbCompiler.constructBX(s,i)).writesPC=!0,e.fixedJump=!1}}else if(6144==(63488&t)){var i=(448&t)>>6,r=(56&t)>>3,s=7&t;switch(1536&t){case 0:e=this.thumbCompiler.constructADD3(s,r,i);break;case 512:e=this.thumbCompiler.constructSUB3(s,r,i);break;case 1024:e=(a=(448&t)>>6)?this.thumbCompiler.constructADD1(s,r,a):this.thumbCompiler.constructMOV2(s,r,i);break;case 1536:var a=(448&t)>>6;e=this.thumbCompiler.constructSUB1(s,r,a)}e.writesPC=!1}else if(57344&t)if(8192==(57344&t)){a=255&t,r=(1792&t)>>8;switch(6144&t){case 0:e=this.thumbCompiler.constructMOV1(r,a);break;case 2048:e=this.thumbCompiler.constructCMP1(r,a);break;case 4096:e=this.thumbCompiler.constructADD2(r,a);break;case 6144:e=this.thumbCompiler.constructSUB2(r,a)}e.writesPC=!1}else if(18432==(63488&t)){s=(1792&t)>>8,a=(255&t)<<2;(e=this.thumbCompiler.constructLDR3(s,a)).writesPC=!1}else if(20480==(61440&t)){s=7&t,r=(56&t)>>3,i=(448&t)>>6;switch(3584&t){case 0:e=this.thumbCompiler.constructSTR2(s,r,i);break;case 512:e=this.thumbCompiler.constructSTRH2(s,r,i);break;case 1024:e=this.thumbCompiler.constructSTRB2(s,r,i);break;case 1536:e=this.thumbCompiler.constructLDRSB(s,r,i);break;case 2048:e=this.thumbCompiler.constructLDR2(s,r,i);break;case 2560:e=this.thumbCompiler.constructLDRH2(s,r,i);break;case 3072:e=this.thumbCompiler.constructLDRB2(s,r,i);break;case 3584:e=this.thumbCompiler.constructLDRSH(s,r,i)}e.writesPC=!1}else if(24576==(57344&t)){var n,s=7&t,r=(56&t)>>3,a=(1984&t)>>4;(n=4096&t)&&(a>>=2),(e=2048&t?n?this.thumbCompiler.constructLDRB1(s,r,a):this.thumbCompiler.constructLDR1(s,r,a):n?this.thumbCompiler.constructSTRB1(s,r,a):this.thumbCompiler.constructSTR1(s,r,a)).writesPC=!1}else if(46080==(62976&t)){var o=!!(256&t),h=255&t;2048&t?((e=this.thumbCompiler.constructPOP(h,o)).writesPC=o,e.fixedJump=!1):(e=this.thumbCompiler.constructPUSH(h,o)).writesPC=!1}else{if(!(32768&t))throw"Bad opcode: 0x"+t.toString(16);switch(28672&t){case 0:s=7&t,r=(56&t)>>3,a=(1984&t)>>5;(e=2048&t?this.thumbCompiler.constructLDRH1(s,r,a):this.thumbCompiler.constructSTRH1(s,r,a)).writesPC=!1;break;case 4096:s=(1792&t)>>8,a=(255&t)<<2;(e=2048&t?this.thumbCompiler.constructLDR4(s,a):this.thumbCompiler.constructSTR3(s,a)).writesPC=!1;break;case 8192:s=(1792&t)>>8,a=(255&t)<<2;(e=2048&t?this.thumbCompiler.constructADD6(s,a):this.thumbCompiler.constructADD5(s,a)).writesPC=!1;break;case 12288:3840&t||(a=(127&t)<<2,(n=128&t)&&(a=-a),(e=this.thumbCompiler.constructADD7(a)).writesPC=!1);break;case 16384:r=(1792&t)>>8,h=255&t;(e=2048&t?this.thumbCompiler.constructLDMIA(r,h):this.thumbCompiler.constructSTMIA(r,h)).writesPC=!1;break;case 20480:var c=(3840&t)>>8,a=255&t;15==c?(e=this.thumbCompiler.constructSWI(a)).writesPC=!1:(128&t&&(a|=4294967040),a<<=1,c=this.conds[c],(e=this.thumbCompiler.constructB1(a,c)).writesPC=!0,e.fixedJump=!0);break;case 24576:case 28672:a=2047&t;switch(6144&t){case 0:1024&a&&(a|=4294965248),a<<=1,(e=this.thumbCompiler.constructB2(a)).writesPC=!0,e.fixedJump=!0;break;case 2048:break;case 4096:1024&a&&(a|=4294966272),a<<=12,(e=this.thumbCompiler.constructBL1(a)).writesPC=!1;break;case 6144:(e=this.thumbCompiler.constructBL2(a)).writesPC=!0,e.fixedJump=!1}break;default:this.WARN("Undefined instruction: 0x"+t.toString(16))}}else{var s=7&t,i=(56&t)>>3,a=(1984&t)>>6;switch(6144&t){case 0:e=this.thumbCompiler.constructLSL1(s,i,a);break;case 2048:e=this.thumbCompiler.constructLSR1(s,i,a);break;case 4096:e=this.thumbCompiler.constructASR1(s,i,a)}e.writesPC=!1}return e.execMode=this.MODE_THUMB,e.fixedJump=e.fixedJump||!1,e},GameBoyAdvance.prototype.setCanvas=function(t){var e,i=this;240!=t.offsetWidth||160!=t.offsetHeight?(this.indirectCanvas=document.createElement("canvas"),this.indirectCanvas.setAttribute("height","160"),this.indirectCanvas.setAttribute("width","240"),this.targetCanvas=t,this.setCanvasDirect(this.indirectCanvas),e=t.getContext("2d"),this.video.drawCallback=function(){e.drawImage(i.indirectCanvas,0,0,t.offsetWidth,t.offsetHeight)}):(this.setCanvasDirect(t),i=this)},GameBoyAdvance.prototype.setCanvasDirect=function(t){this.context=t.getContext("2d"),this.video.setBacking(this.context)},GameBoyAdvance.prototype.setBios=function(t,e){this.mmu.loadBios(t,e)},GameBoyAdvance.prototype.setRom=function(t){return this.reset(),this.rom=this.mmu.loadRom(t,!0),!!this.rom&&(this.retrieveSavedata(),!0)},GameBoyAdvance.prototype.hasRom=function(){return!!this.rom},GameBoyAdvance.prototype.loadRomFromFile=function(t,e){var i=new FileReader,s=this;i.onload=function(t){t=s.setRom(t.target.result);e&&e(t)},i.readAsArrayBuffer(t)},GameBoyAdvance.prototype.reset=function(){this.audio.pause(!0),this.mmu.clear(),this.io.clear(),this.audio.clear(),this.video.clear(),this.sio.clear(),this.mmu.mmap(this.mmu.REGION_IO,this.io),this.mmu.mmap(this.mmu.REGION_PALETTE_RAM,this.video.renderPath.palette),this.mmu.mmap(this.mmu.REGION_VRAM,this.video.renderPath.vram),this.mmu.mmap(this.mmu.REGION_OAM,this.video.renderPath.oam),this.cpu.resetCPU(0)},GameBoyAdvance.prototype.step=function(){for(;this.doStep();)this.cpu.step()},GameBoyAdvance.prototype.waitFrame=function(){var t=this.seenFrame;return this.seenFrame=!1,!t},GameBoyAdvance.prototype.pause=function(){this.paused=!0,this.audio.pause(!0),this.queue&&(clearTimeout(this.queue),this.queue=null)},GameBoyAdvance.prototype.advanceFrame=function(){this.step(),this.seenSave?this.mmu.saveNeedsFlush()?this.mmu.flushSave():(this.storeSavedata(),this.seenSave=!1):this.mmu.saveNeedsFlush()&&(this.seenSave=!0,this.mmu.flushSave())},GameBoyAdvance.prototype.runStable=function(){var e,t,i,s,r;this.interval||(e=this,i=t=0,r=Date.now(),this.paused=!1,this.audio.pause(!1),s=this.reportFPS?function(){try{if(t+=Date.now()-r,e.paused)return;queueFrame(s),r=Date.now(),e.advanceFrame(),60==++i&&(e.reportFPS(1e3*i/t),t=i=0)}catch(t){throw e.ERROR(t),t.stack&&e.logStackTrace(t.stack.split("\n")),t}}:function(){try{if(e.paused)return;queueFrame(s),e.advanceFrame()}catch(t){throw e.ERROR(t),t.stack&&e.logStackTrace(t.stack.split("\n")),t}},queueFrame(s))},GameBoyAdvance.prototype.setSavedata=function(t){this.mmu.loadSavedata(t)},GameBoyAdvance.prototype.loadSavedataFromFile=function(t){var e=new FileReader,i=this;e.onload=function(t){i.setSavedata(t.target.result)},e.readAsArrayBuffer(t)},GameBoyAdvance.prototype.decodeSavedata=function(t){this.setSavedata(this.decodeBase64(t))},GameBoyAdvance.prototype.decodeBase64=function(t){var e=3*t.length/4;"="==t[t.length-2]?e-=2:"="==t[t.length-1]&&--e;for(var i=new ArrayBuffer(e),s=new Uint8Array(i),r=t.match(/..../g),a=0;a+2<e;a+=3){var n=atob(r.shift());s[a]=n.charCodeAt(0),s[a+1]=n.charCodeAt(1),s[a+2]=n.charCodeAt(2)}return a<e&&(n=atob(r.shift()),s[a++]=n.charCodeAt(0),1<n.length&&(s[a++]=n.charCodeAt(1))),i},GameBoyAdvance.prototype.encodeBase64=function(t){for(var e,i,s=[],r=[],a=0;a<t.byteLength;++a)for(e=t.getUint8(a,!0),r.push(String.fromCharCode(e));3<=r.length;)i=r.splice(0,3),s.push(btoa(i.join("")));return r.length&&s.push(btoa(r.join(""))),s.join("")},GameBoyAdvance.prototype.downloadSavedata=function(){var t,e=this.mmu.save;if(!e)return this.WARN("No save data available"),null;window.URL?(t=window.URL.createObjectURL(new Blob([e.buffer],{type:"application/octet-stream"})),window.open(t)):(e=this.encodeBase64(e.view),window.open("data:application/octet-stream;base64,"+e,this.rom.code+".sav"))},GameBoyAdvance.prototype.storeSavedata=function(){var t=this.mmu.save;try{window.localStorage[this.SYS_ID+"."+this.mmu.cart.code]=this.encodeBase64(t.view)}catch(t){this.WARN("Could not store savedata! "+t)}},GameBoyAdvance.prototype.retrieveSavedata=function(){try{var t=window.localStorage[this.SYS_ID+"."+this.mmu.cart.code];if(t)return this.decodeSavedata(t),!0}catch(t){this.WARN("Could not retrieve savedata! "+t)}return!1},GameBoyAdvance.prototype.freeze=function(){return{cpu:this.cpu.freeze(),mmu:this.mmu.freeze(),irq:this.irq.freeze(),io:this.io.freeze(),audio:this.audio.freeze(),video:this.video.freeze()}},GameBoyAdvance.prototype.defrost=function(t){this.cpu.defrost(t.cpu),this.mmu.defrost(t.mmu),this.audio.defrost(t.audio),this.video.defrost(t.video),this.irq.defrost(t.irq),this.io.defrost(t.io)},GameBoyAdvance.prototype.log=function(t,e){},GameBoyAdvance.prototype.setLogger=function(t){this.log=t},GameBoyAdvance.prototype.logStackTrace=function(t){var e=t.length-32;this.ERROR("Stack trace follows:"),0<e&&this.log(-1,"> (Too many frames)");for(var i=Math.max(e,0);i<t.length;++i)this.log(-1,"> "+t[i])},GameBoyAdvance.prototype.ERROR=function(t){this.logLevel&this.LOG_ERROR&&this.log(this.LOG_ERROR,t)},GameBoyAdvance.prototype.WARN=function(t){this.logLevel&this.LOG_WARN&&this.log(this.LOG_WARN,t)},GameBoyAdvance.prototype.STUB=function(t){this.logLevel&this.LOG_STUB&&this.log(this.LOG_STUB,t)},GameBoyAdvance.prototype.INFO=function(t){this.logLevel&this.LOG_INFO&&this.log(this.LOG_INFO,t)},GameBoyAdvance.prototype.DEBUG=function(t){this.logLevel&this.LOG_DEBUG&&this.log(this.LOG_DEBUG,t)},GameBoyAdvance.prototype.ASSERT_UNREACHED=function(t){throw new Error("Should be unreached: "+t)},GameBoyAdvance.prototype.ASSERT=function(t,e){if(!t)throw new Error("Assertion failed: "+e)},GameBoyAdvanceGPIO.prototype.store16=function(t,e){switch(t){case 196:this.device.setPins(15&e);break;case 198:this.direction=15&e,this.device.setDirection(this.direction);break;case 200:this.readWrite=1&e;break;default:throw new Error("BUG: Bad offset passed to GPIO: "+t.toString(16))}var i;this.readWrite&&(i=this.rom.view.getUint16(t,!0),i&=~this.direction,this.rom.view.setUint16(t,i|e&this.direction,!0))},GameBoyAdvanceGPIO.prototype.outputPins=function(t){var e;this.readWrite&&(e=this.rom.view.getUint16(196,!0),e&=this.direction,this.rom.view.setUint16(196,e|t&~this.direction&15,!0))},GameBoyAdvanceRTC.prototype.setPins=function(t){switch(this.transferStep){case 0:1==(5&t)&&(this.transferStep=1);break;case 1:4&t&&(this.transferStep=2);break;case 2:1&t?4&t?2&this.direction&&!this.read?(++this.bitsRead,8==this.bitsRead&&this.processByte()):(this.gpio.outputPins(5|this.sioOutputPin()<<1),++this.bitsRead,8==this.bitsRead&&(--this.bytesRemaining,this.bytesRemaining<=0&&(this.command=-1),this.bitsRead=0)):(this.bitsRead=0,this.bytesRemaining=0,this.command=-1,this.transferStep=0):(this.bits&=~(1<<this.bitsRead),this.bits|=(2&t)>>1<<this.bitsRead)}this.pins=7&t},GameBoyAdvanceRTC.prototype.setDirection=function(t){this.direction=t},GameBoyAdvanceRTC.prototype.processByte=function(){switch(--this.bytesRemaining,this.command){case-1:if(6==(15&this.bits))switch(this.command=this.bits>>4&7,this.reading=128&this.bits,this.bytesRemaining=this.totalBytes[this.command],this.command){case 0:this.control=0;break;case 2:case 6:this.updateClock()}else this.gpio.core.WARN("Invalid RTC command byte: "+this.bits.toString(16));break;case 4:this.control=64&this.bits}this.bits=0,this.bitsRead=0,this.bytesRemaining||(this.command=-1)},GameBoyAdvanceRTC.prototype.sioOutputPin=function(){var t=0;switch(this.command){case 4:t=this.control;break;case 2:case 6:t=this.time[7-this.bytesRemaining]}return t>>this.bitsRead&1},GameBoyAdvanceRTC.prototype.updateClock=function(){var t=new Date;this.time[0]=this.bcd(t.getFullYear()),this.time[1]=this.bcd(t.getMonth()+1),this.time[2]=this.bcd(t.getDate()),this.time[3]=t.getDay()-1,this.time[3]<0&&(this.time[3]=6),64&this.control?this.time[4]=this.bcd(t.getHours()):(this.time[4]=this.bcd(t.getHours()%2),12<=t.getHours()&&(this.time[4]|=128)),this.time[5]=this.bcd(t.getMinutes()),this.time[6]=this.bcd(t.getSeconds())},GameBoyAdvanceRTC.prototype.bcd=function(t){var e=t%10;return e+=(t/=10)%10<<4},GameBoyAdvanceIO.prototype.clear=function(){this.registers=new Uint16Array(this.cpu.mmu.SIZE_IO),this.registers[this.DISPCNT>>1]=this.DEFAULT_DISPCNT,this.registers[this.SOUNDBIAS>>1]=this.DEFAULT_SOUNDBIAS,this.registers[this.BG2PA>>1]=this.DEFAULT_BGPA,this.registers[this.BG2PD>>1]=this.DEFAULT_BGPD,this.registers[this.BG3PA>>1]=this.DEFAULT_BGPA,this.registers[this.BG3PD>>1]=this.DEFAULT_BGPD,this.registers[this.RCNT>>1]=this.DEFAULT_RCNT},GameBoyAdvanceIO.prototype.freeze=function(){return{registers:Serializer.prefix(this.registers.buffer)}},GameBoyAdvanceIO.prototype.defrost=function(t){this.registers=new Uint16Array(t.registers);for(var e=0;e<=this.BLDY;e+=2)this.store16(this.registers[e>>1])},GameBoyAdvanceIO.prototype.load8=function(t){throw"Unimplmeneted unaligned I/O access"},GameBoyAdvanceIO.prototype.load16=function(t){return this.loadU16(t)<<16>>16},GameBoyAdvanceIO.prototype.load32=function(t){switch(t&=4294967292){case this.DMA0CNT_LO:case this.DMA1CNT_LO:case this.DMA2CNT_LO:case this.DMA3CNT_LO:return this.loadU16(2|t)<<16;case this.IME:return 65535&this.loadU16(t);case this.JOY_RECV:case this.JOY_TRANS:return this.core.STUB("Unimplemented JOY register read: 0x"+t.toString(16)),0}return this.loadU16(t)|this.loadU16(2|t)<<16},GameBoyAdvanceIO.prototype.loadU8=function(t){var e=1&t;return this.loadU16(65534&t)>>>(e<<3)&255},GameBoyAdvanceIO.prototype.loadU16=function(t){switch(t){case this.DISPCNT:case this.BG0CNT:case this.BG1CNT:case this.BG2CNT:case this.BG3CNT:case this.WININ:case this.WINOUT:case this.SOUND1CNT_LO:case this.SOUND3CNT_LO:case this.SOUNDCNT_LO:case this.SOUNDCNT_HI:case this.SOUNDBIAS:case this.BLDCNT:case this.BLDALPHA:case this.TM0CNT_HI:case this.TM1CNT_HI:case this.TM2CNT_HI:case this.TM3CNT_HI:case this.DMA0CNT_HI:case this.DMA1CNT_HI:case this.DMA2CNT_HI:case this.DMA3CNT_HI:case this.RCNT:case this.WAITCNT:case this.IE:case this.IF:case this.IME:case this.POSTFLG:break;case this.DISPSTAT:return this.registers[t>>1]|this.video.readDisplayStat();case this.VCOUNT:return this.video.vcount;case this.SOUND1CNT_HI:case this.SOUND2CNT_LO:return 65472&this.registers[t>>1];case this.SOUND1CNT_X:case this.SOUND2CNT_HI:case this.SOUND3CNT_X:return 16384&this.registers[t>>1];case this.SOUND3CNT_HI:return 57344&this.registers[t>>1];case this.SOUND4CNT_LO:return 65280&this.registers[t>>1];case this.SOUND4CNT_HI:return 16639&this.registers[t>>1];case this.SOUNDCNT_X:return this.core.STUB("Unimplemented sound register read: SOUNDCNT_X"),0|this.registers[t>>1];case this.TM0CNT_LO:return this.cpu.irq.timerRead(0);case this.TM1CNT_LO:return this.cpu.irq.timerRead(1);case this.TM2CNT_LO:return this.cpu.irq.timerRead(2);case this.TM3CNT_LO:return this.cpu.irq.timerRead(3);case this.SIOCNT:return this.sio.readSIOCNT();case this.KEYINPUT:return this.keypad.pollGamepads(),this.keypad.currentDown;case this.KEYCNT:return this.core.STUB("Unimplemented I/O register read: KEYCNT"),0;case this.BG0HOFS:case this.BG0VOFS:case this.BG1HOFS:case this.BG1VOFS:case this.BG2HOFS:case this.BG2VOFS:case this.BG3HOFS:case this.BG3VOFS:case this.BG2PA:case this.BG2PB:case this.BG2PC:case this.BG2PD:case this.BG3PA:case this.BG3PB:case this.BG3PC:case this.BG3PD:case this.BG2X_LO:case this.BG2X_HI:case this.BG2Y_LO:case this.BG2Y_HI:case this.BG3X_LO:case this.BG3X_HI:case this.BG3Y_LO:case this.BG3Y_HI:case this.WIN0H:case this.WIN1H:case this.WIN0V:case this.WIN1V:case this.BLDY:case this.DMA0SAD_LO:case this.DMA0SAD_HI:case this.DMA0DAD_LO:case this.DMA0DAD_HI:case this.DMA0CNT_LO:case this.DMA1SAD_LO:case this.DMA1SAD_HI:case this.DMA1DAD_LO:case this.DMA1DAD_HI:case this.DMA1CNT_LO:case this.DMA2SAD_LO:case this.DMA2SAD_HI:case this.DMA2DAD_LO:case this.DMA2DAD_HI:case this.DMA2CNT_LO:case this.DMA3SAD_LO:case this.DMA3SAD_HI:case this.DMA3DAD_LO:case this.DMA3DAD_HI:case this.DMA3CNT_LO:case this.FIFO_A_LO:case this.FIFO_A_HI:case this.FIFO_B_LO:case this.FIFO_B_HI:return this.core.WARN("Read for write-only register: 0x"+t.toString(16)),this.core.mmu.badMemory.loadU16(0);case this.MOSAIC:return this.core.WARN("Read for write-only register: 0x"+t.toString(16)),0;case this.SIOMULTI0:case this.SIOMULTI1:case this.SIOMULTI2:case this.SIOMULTI3:return this.sio.read(t-this.SIOMULTI0>>1);case this.SIODATA8:return this.core.STUB("Unimplemented SIO register read: 0x"+t.toString(16)),0;case this.JOYCNT:case this.JOYSTAT:return this.core.STUB("Unimplemented JOY register read: 0x"+t.toString(16)),0;default:return this.core.WARN("Bad I/O register read: 0x"+t.toString(16)),this.core.mmu.badMemory.loadU16(0)}return this.registers[t>>1]},GameBoyAdvanceIO.prototype.store8=function(t,e){switch(t){case this.WININ:case 1|this.WININ:case this.WINOUT:case 1|this.WINOUT:this.value;break;case this.SOUND1CNT_LO:case 1|this.SOUND1CNT_LO:case this.SOUND1CNT_HI:case 1|this.SOUND1CNT_HI:case this.SOUND1CNT_X:case 1|this.SOUND1CNT_X:case this.SOUND2CNT_LO:case 1|this.SOUND2CNT_LO:case this.SOUND2CNT_HI:case 1|this.SOUND2CNT_HI:case this.SOUND3CNT_LO:case 1|this.SOUND3CNT_LO:case this.SOUND3CNT_HI:case 1|this.SOUND3CNT_HI:case this.SOUND3CNT_X:case 1|this.SOUND3CNT_X:case this.SOUND4CNT_LO:case 1|this.SOUND4CNT_LO:case this.SOUND4CNT_HI:case 1|this.SOUND4CNT_HI:case this.SOUNDCNT_LO:case 1|this.SOUNDCNT_LO:case this.SOUNDCNT_X:case this.IF:case this.IME:break;case 1|this.SOUNDBIAS:this.STUB_REG("sound",t);break;case this.HALTCNT:return void((e&=128)?this.core.STUB("Stop"):this.core.irq.halt());default:this.STUB_REG("8-bit I/O",t)}1&t?(e<<=8,e|=255&this.registers[t>>1]):(e&=255,e|=65280&this.registers[t>>1]),this.store16(268435454&t,e)},GameBoyAdvanceIO.prototype.store16=function(t,e){switch(t){case this.DISPCNT:this.video.renderPath.writeDisplayControl(e);break;case this.DISPSTAT:e&=this.video.DISPSTAT_MASK,this.video.writeDisplayStat(e);break;case this.BG0CNT:this.video.renderPath.writeBackgroundControl(0,e);break;case this.BG1CNT:this.video.renderPath.writeBackgroundControl(1,e);break;case this.BG2CNT:this.video.renderPath.writeBackgroundControl(2,e);break;case this.BG3CNT:this.video.renderPath.writeBackgroundControl(3,e);break;case this.BG0HOFS:this.video.renderPath.writeBackgroundHOffset(0,e);break;case this.BG0VOFS:this.video.renderPath.writeBackgroundVOffset(0,e);break;case this.BG1HOFS:this.video.renderPath.writeBackgroundHOffset(1,e);break;case this.BG1VOFS:this.video.renderPath.writeBackgroundVOffset(1,e);break;case this.BG2HOFS:this.video.renderPath.writeBackgroundHOffset(2,e);break;case this.BG2VOFS:this.video.renderPath.writeBackgroundVOffset(2,e);break;case this.BG3HOFS:this.video.renderPath.writeBackgroundHOffset(3,e);break;case this.BG3VOFS:this.video.renderPath.writeBackgroundVOffset(3,e);break;case this.BG2X_LO:this.video.renderPath.writeBackgroundRefX(2,this.registers[t>>1|1]<<16|e);break;case this.BG2X_HI:this.video.renderPath.writeBackgroundRefX(2,this.registers[t>>1^1]|e<<16);break;case this.BG2Y_LO:this.video.renderPath.writeBackgroundRefY(2,this.registers[t>>1|1]<<16|e);break;case this.BG2Y_HI:this.video.renderPath.writeBackgroundRefY(2,this.registers[t>>1^1]|e<<16);break;case this.BG2PA:this.video.renderPath.writeBackgroundParamA(2,e);break;case this.BG2PB:this.video.renderPath.writeBackgroundParamB(2,e);break;case this.BG2PC:this.video.renderPath.writeBackgroundParamC(2,e);break;case this.BG2PD:this.video.renderPath.writeBackgroundParamD(2,e);break;case this.BG3X_LO:this.video.renderPath.writeBackgroundRefX(3,this.registers[t>>1|1]<<16|e);break;case this.BG3X_HI:this.video.renderPath.writeBackgroundRefX(3,this.registers[t>>1^1]|e<<16);break;case this.BG3Y_LO:this.video.renderPath.writeBackgroundRefY(3,this.registers[t>>1|1]<<16|e);break;case this.BG3Y_HI:this.video.renderPath.writeBackgroundRefY(3,this.registers[t>>1^1]|e<<16);break;case this.BG3PA:this.video.renderPath.writeBackgroundParamA(3,e);break;case this.BG3PB:this.video.renderPath.writeBackgroundParamB(3,e);break;case this.BG3PC:this.video.renderPath.writeBackgroundParamC(3,e);break;case this.BG3PD:this.video.renderPath.writeBackgroundParamD(3,e);break;case this.WIN0H:this.video.renderPath.writeWin0H(e);break;case this.WIN1H:this.video.renderPath.writeWin1H(e);break;case this.WIN0V:this.video.renderPath.writeWin0V(e);break;case this.WIN1V:this.video.renderPath.writeWin1V(e);break;case this.WININ:e&=16191,this.video.renderPath.writeWinIn(e);break;case this.WINOUT:e&=16191,this.video.renderPath.writeWinOut(e);break;case this.BLDCNT:e&=32767,this.video.renderPath.writeBlendControl(e);break;case this.BLDALPHA:e&=7967,this.video.renderPath.writeBlendAlpha(e);break;case this.BLDY:e&=31,this.video.renderPath.writeBlendY(e);break;case this.MOSAIC:this.video.renderPath.writeMosaic(e);break;case this.SOUND1CNT_LO:e&=127,this.audio.writeSquareChannelSweep(0,e);break;case this.SOUND1CNT_HI:this.audio.writeSquareChannelDLE(0,e);break;case this.SOUND1CNT_X:e&=51199,this.audio.writeSquareChannelFC(0,e),e&=-32769;break;case this.SOUND2CNT_LO:this.audio.writeSquareChannelDLE(1,e);break;case this.SOUND2CNT_HI:e&=51199,this.audio.writeSquareChannelFC(1,e),e&=-32769;break;case this.SOUND3CNT_LO:e&=224,this.audio.writeChannel3Lo(e);break;case this.SOUND3CNT_HI:e&=57599,this.audio.writeChannel3Hi(e);break;case this.SOUND3CNT_X:e&=51199,this.audio.writeChannel3X(e),e&=-32769;break;case this.SOUND4CNT_LO:e&=65343,this.audio.writeChannel4LE(e);break;case this.SOUND4CNT_HI:e&=49407,this.audio.writeChannel4FC(e),e&=-32769;break;case this.SOUNDCNT_LO:e&=65399,this.audio.writeSoundControlLo(e);break;case this.SOUNDCNT_HI:e&=65295,this.audio.writeSoundControlHi(e);break;case this.SOUNDCNT_X:e&=128,this.audio.writeEnable(e);break;case this.WAVE_RAM0_LO:case this.WAVE_RAM0_HI:case this.WAVE_RAM1_LO:case this.WAVE_RAM1_HI:case this.WAVE_RAM2_LO:case this.WAVE_RAM2_HI:case this.WAVE_RAM3_LO:case this.WAVE_RAM3_HI:this.audio.writeWaveData(t-this.WAVE_RAM0_LO,e,2);break;case this.DMA0SAD_LO:case this.DMA0DAD_LO:case this.DMA1SAD_LO:case this.DMA1DAD_LO:case this.DMA2SAD_LO:case this.DMA2DAD_LO:case this.DMA3SAD_LO:case this.DMA3DAD_LO:return void this.store32(t,this.registers[1+(t>>1)]<<16|e);case this.DMA0SAD_HI:case this.DMA0DAD_HI:case this.DMA1SAD_HI:case this.DMA1DAD_HI:case this.DMA2SAD_HI:case this.DMA2DAD_HI:case this.DMA3SAD_HI:case this.DMA3DAD_HI:return void this.store32(t-2,this.registers[(t>>1)-1]|e<<16);case this.DMA0CNT_LO:this.cpu.irq.dmaSetWordCount(0,e);break;case this.DMA0CNT_HI:return this.registers[t>>1]=65504&e,void this.cpu.irq.dmaWriteControl(0,e);case this.DMA1CNT_LO:this.cpu.irq.dmaSetWordCount(1,e);break;case this.DMA1CNT_HI:return this.registers[t>>1]=65504&e,void this.cpu.irq.dmaWriteControl(1,e);case this.DMA2CNT_LO:this.cpu.irq.dmaSetWordCount(2,e);break;case this.DMA2CNT_HI:return this.registers[t>>1]=65504&e,void this.cpu.irq.dmaWriteControl(2,e);case this.DMA3CNT_LO:this.cpu.irq.dmaSetWordCount(3,e);break;case this.DMA3CNT_HI:return this.registers[t>>1]=65504&e,void this.cpu.irq.dmaWriteControl(3,e);case this.TM0CNT_LO:return void this.cpu.irq.timerSetReload(0,e);case this.TM1CNT_LO:return void this.cpu.irq.timerSetReload(1,e);case this.TM2CNT_LO:return void this.cpu.irq.timerSetReload(2,e);case this.TM3CNT_LO:return void this.cpu.irq.timerSetReload(3,e);case this.TM0CNT_HI:e&=199,this.cpu.irq.timerWriteControl(0,e);break;case this.TM1CNT_HI:e&=199,this.cpu.irq.timerWriteControl(1,e);break;case this.TM2CNT_HI:e&=199,this.cpu.irq.timerWriteControl(2,e);break;case this.TM3CNT_HI:e&=199,this.cpu.irq.timerWriteControl(3,e);break;case this.SIOMULTI0:case this.SIOMULTI1:case this.SIOMULTI2:case this.SIOMULTI3:case this.SIODATA8:this.STUB_REG("SIO",t);break;case this.RCNT:this.sio.setMode(e>>12&12|this.registers[this.SIOCNT>>1]>>12&3),this.sio.writeRCNT(e);break;case this.SIOCNT:return this.sio.setMode(e>>12&3|this.registers[this.RCNT>>1]>>12&12),void this.sio.writeSIOCNT(e);case this.JOYCNT:case this.JOYSTAT:this.STUB_REG("JOY",t);break;case this.IE:e&=16383,this.cpu.irq.setInterruptsEnabled(e);break;case this.IF:return void this.cpu.irq.dismissIRQs(e);case this.WAITCNT:e&=57343,this.cpu.mmu.adjustTimings(e);break;case this.IME:e&=1,this.cpu.irq.masterEnable(e);break;default:this.STUB_REG("I/O",t)}this.registers[t>>1]=e},GameBoyAdvanceIO.prototype.store32=function(t,e){switch(t){case this.BG2X_LO:e&=268435455,this.video.renderPath.writeBackgroundRefX(2,e);break;case this.BG2Y_LO:e&=268435455,this.video.renderPath.writeBackgroundRefY(2,e);break;case this.BG3X_LO:e&=268435455,this.video.renderPath.writeBackgroundRefX(3,e);break;case this.BG3Y_LO:e&=268435455,this.video.renderPath.writeBackgroundRefY(3,e);break;case this.DMA0SAD_LO:this.cpu.irq.dmaSetSourceAddress(0,e);break;case this.DMA0DAD_LO:this.cpu.irq.dmaSetDestAddress(0,e);break;case this.DMA1SAD_LO:this.cpu.irq.dmaSetSourceAddress(1,e);break;case this.DMA1DAD_LO:this.cpu.irq.dmaSetDestAddress(1,e);break;case this.DMA2SAD_LO:this.cpu.irq.dmaSetSourceAddress(2,e);break;case this.DMA2DAD_LO:this.cpu.irq.dmaSetDestAddress(2,e);break;case this.DMA3SAD_LO:this.cpu.irq.dmaSetSourceAddress(3,e);break;case this.DMA3DAD_LO:this.cpu.irq.dmaSetDestAddress(3,e);break;case this.FIFO_A_LO:return void this.audio.appendToFifoA(e);case this.FIFO_B_LO:return void this.audio.appendToFifoB(e);case this.IME:return void this.store16(t,65535&e);case this.JOY_RECV:case this.JOY_TRANS:return void this.STUB_REG("JOY",t);default:return this.store16(t,65535&e),void this.store16(2|t,e>>>16)}this.registers[t>>1]=65535&e,this.registers[1+(t>>1)]=e>>>16},GameBoyAdvanceIO.prototype.invalidatePage=function(t){},GameBoyAdvanceIO.prototype.STUB_REG=function(t,e){this.core.STUB("Unimplemented "+t+" register write: "+e.toString(16))},GameBoyAdvanceInterruptHandler.prototype.clear=function(){this.enable=!1,this.enabledIRQs=0,this.interruptFlags=0,this.dma=new Array;for(var t=0;t<4;++t)this.dma.push({source:0,dest:0,count:0,nextSource:0,nextDest:0,nextCount:0,srcControl:0,dstControl:0,repeat:!1,width:0,drq:!1,timing:0,doIrq:!1,enable:!1,nextIRQ:0});this.timersEnabled=0,this.timers=new Array;for(t=0;t<4;++t)this.timers.push({reload:0,oldReload:0,prescaleBits:0,countUp:!1,doIrq:!1,enable:!1,lastEvent:0,nextEvent:0,overflowInterval:1});this.nextEvent=0,this.springIRQ=!1,this.resetSP()},GameBoyAdvanceInterruptHandler.prototype.freeze=function(){return{enable:this.enable,enabledIRQs:this.enabledIRQs,interruptFlags:this.interruptFlags,dma:this.dma,timers:this.timers,nextEvent:this.nextEvent,springIRQ:this.springIRQ}},GameBoyAdvanceInterruptHandler.prototype.defrost=function(t){this.enable=t.enable,this.enabledIRQs=t.enabledIRQs,this.interruptFlags=t.interruptFlags,this.dma=t.dma,this.timers=t.timers,this.timersEnabled=0,this.timers[0].enable&&++this.timersEnabled,this.timers[1].enable&&++this.timersEnabled,this.timers[2].enable&&++this.timersEnabled,this.timers[3].enable&&++this.timersEnabled,this.nextEvent=t.nextEvent,this.springIRQ=t.springIRQ},GameBoyAdvanceInterruptHandler.prototype.updateTimers=function(){var t;this.nextEvent>this.cpu.cycles||(this.springIRQ&&(this.cpu.raiseIRQ(),this.springIRQ=!1),this.video.updateTimers(this.cpu),this.audio.updateTimers(),this.timersEnabled&&((t=this.timers[0]).enable&&this.cpu.cycles>=t.nextEvent&&(t.lastEvent=t.nextEvent,t.nextEvent+=t.overflowInterval,this.io.registers[this.io.TM0CNT_LO>>1]=t.reload,t.oldReload=t.reload,t.doIrq&&this.raiseIRQ(this.IRQ_TIMER0),this.audio.enabled&&(this.audio.enableChannelA&&!this.audio.soundTimerA&&0<=this.audio.dmaA&&this.audio.sampleFifoA(),this.audio.enableChannelB&&!this.audio.soundTimerB&&0<=this.audio.dmaB&&this.audio.sampleFifoB()),(t=this.timers[1]).countUp&&65536==++this.io.registers[this.io.TM1CNT_LO>>1]&&(t.nextEvent=this.cpu.cycles)),(t=this.timers[1]).enable&&this.cpu.cycles>=t.nextEvent&&(t.lastEvent=t.nextEvent,t.nextEvent+=t.overflowInterval,t.countUp&&65536!=this.io.registers[this.io.TM1CNT_LO>>1]||(this.io.registers[this.io.TM1CNT_LO>>1]=t.reload),t.oldReload=t.reload,t.doIrq&&this.raiseIRQ(this.IRQ_TIMER1),t.countUp&&(t.nextEvent=0),this.audio.enabled&&(this.audio.enableChannelA&&this.audio.soundTimerA&&0<=this.audio.dmaA&&this.audio.sampleFifoA(),this.audio.enableChannelB&&this.audio.soundTimerB&&0<=this.audio.dmaB&&this.audio.sampleFifoB()),(t=this.timers[2]).countUp&&65536==++this.io.registers[this.io.TM2CNT_LO>>1]&&(t.nextEvent=this.cpu.cycles)),(t=this.timers[2]).enable&&this.cpu.cycles>=t.nextEvent&&(t.lastEvent=t.nextEvent,t.nextEvent+=t.overflowInterval,t.countUp&&65536!=this.io.registers[this.io.TM2CNT_LO>>1]||(this.io.registers[this.io.TM2CNT_LO>>1]=t.reload),t.oldReload=t.reload,t.doIrq&&this.raiseIRQ(this.IRQ_TIMER2),t.countUp&&(t.nextEvent=0),(t=this.timers[3]).countUp&&65536==++this.io.registers[this.io.TM3CNT_LO>>1]&&(t.nextEvent=this.cpu.cycles)),(t=this.timers[3]).enable&&this.cpu.cycles>=t.nextEvent&&(t.lastEvent=t.nextEvent,t.nextEvent+=t.overflowInterval,t.countUp&&65536!=this.io.registers[this.io.TM3CNT_LO>>1]||(this.io.registers[this.io.TM3CNT_LO>>1]=t.reload),t.oldReload=t.reload,t.doIrq&&this.raiseIRQ(this.IRQ_TIMER3),t.countUp&&(t.nextEvent=0))),(t=this.dma[0]).enable&&t.doIrq&&t.nextIRQ&&this.cpu.cycles>=t.nextIRQ&&(t.nextIRQ=0,this.raiseIRQ(this.IRQ_DMA0)),(t=this.dma[1]).enable&&t.doIrq&&t.nextIRQ&&this.cpu.cycles>=t.nextIRQ&&(t.nextIRQ=0,this.raiseIRQ(this.IRQ_DMA1)),(t=this.dma[2]).enable&&t.doIrq&&t.nextIRQ&&this.cpu.cycles>=t.nextIRQ&&(t.nextIRQ=0,this.raiseIRQ(this.IRQ_DMA2)),(t=this.dma[3]).enable&&t.doIrq&&t.nextIRQ&&this.cpu.cycles>=t.nextIRQ&&(t.nextIRQ=0,this.raiseIRQ(this.IRQ_DMA3)),this.pollNextEvent())},GameBoyAdvanceInterruptHandler.prototype.resetSP=function(){this.cpu.switchMode(this.cpu.MODE_SUPERVISOR),this.cpu.gprs[this.cpu.SP]=50364384,this.cpu.switchMode(this.cpu.MODE_IRQ),this.cpu.gprs[this.cpu.SP]=50364320,this.cpu.switchMode(this.cpu.MODE_SYSTEM),this.cpu.gprs[this.cpu.SP]=50364160},GameBoyAdvanceInterruptHandler.prototype.swi32=function(t){this.swi(t>>16)},GameBoyAdvanceInterruptHandler.prototype.swi=function(t){if(this.core.mmu.bios.real)this.cpu.raiseTrap();else switch(t){case 0:for(var e=this.core.mmu.memory[this.core.mmu.REGION_WORKING_IRAM],i=e.loadU8(32762),s=32256;s<32768;s+=4)e.store32(s,0);this.resetSP(),this.cpu.gprs[this.cpu.LR]=i?33554432:134217728,this.cpu.switchExecMode(this.cpu.MODE_ARM),this.cpu.instruction.writesPC=!0,this.cpu.gprs[this.cpu.PC]=this.cpu.gprs[this.cpu.LR];break;case 1:i=this.cpu.gprs[0];if(1&i&&(this.core.mmu.memory[this.core.mmu.REGION_WORKING_RAM]=new MemoryBlock(this.core.mmu.SIZE_WORKING_RAM,9)),2&i)for(s=0;s<this.core.mmu.SIZE_WORKING_IRAM-512;s+=4)this.core.mmu.memory[this.core.mmu.REGION_WORKING_IRAM].store32(s,0);28&i&&this.video.renderPath.clearSubsets(this.core.mmu,i),224&i&&this.core.STUB("Unimplemented RegisterRamReset");break;case 2:this.halt();break;case 5:this.cpu.gprs[0]=1,this.cpu.gprs[1]=1;case 4:if(this.enable||this.io.store16(this.io.IME,1),!this.cpu.gprs[0]&&this.interruptFlags&this.cpu.gprs[1])return;this.dismissIRQs(4294967295),this.cpu.raiseTrap();break;case 6:var r=(0|this.cpu.gprs[0])/(0|this.cpu.gprs[1]),a=(0|this.cpu.gprs[0])%(0|this.cpu.gprs[1]);this.cpu.gprs[0]=0|r,this.cpu.gprs[1]=0|a,this.cpu.gprs[3]=Math.abs(0|r);break;case 7:r=(0|this.cpu.gprs[1])/(0|this.cpu.gprs[0]),a=(0|this.cpu.gprs[1])%(0|this.cpu.gprs[0]);this.cpu.gprs[0]=0|r,this.cpu.gprs[1]=0|a,this.cpu.gprs[3]=Math.abs(0|r);break;case 8:var n=Math.sqrt(this.cpu.gprs[0]);this.cpu.gprs[0]=0|n;break;case 10:var o=this.cpu.gprs[0]/16384,n=this.cpu.gprs[1]/16384;this.cpu.gprs[0]=Math.atan2(n,o)/(2*Math.PI)*65536;break;case 11:var h=this.cpu.gprs[0],c=this.cpu.gprs[1],u=1048575&(I=this.cpu.gprs[2]),o=67108864&I?4:2;if(16777216&I)if(4==o){h&=4294967292,c&=4294967292;for(var p=this.cpu.mmu.load32(h),s=0;s<u;++s)this.cpu.mmu.store32(c+(s<<2),p)}else{h&=4294967294,c&=4294967294;for(p=this.cpu.mmu.load16(h),s=0;s<u;++s)this.cpu.mmu.store16(c+(s<<1),p)}else if(4==o){h&=4294967292,c&=4294967292;for(s=0;s<u;++s){p=this.cpu.mmu.load32(h+(s<<2));this.cpu.mmu.store32(c+(s<<2),p)}}else{h&=4294967294,c&=4294967294;for(s=0;s<u;++s){p=this.cpu.mmu.load16(h+(s<<1));this.cpu.mmu.store16(c+(s<<1),p)}}return;case 12:h=4294967292&this.cpu.gprs[0],c=4294967292&this.cpu.gprs[1];if(u=(u=1048575&(I=this.cpu.gprs[2]))+7>>3<<3,16777216&I)for(p=this.cpu.mmu.load32(h),s=0;s<u;++s)this.cpu.mmu.store32(c+(s<<2),p);else for(s=0;s<u;++s){p=this.cpu.mmu.load32(h+(s<<2));this.cpu.mmu.store32(c+(s<<2),p)}return;case 14:for(var d,m,l,A,s=this.cpu.gprs[2],f=this.cpu.gprs[0],y=this.cpu.gprs[1];s--;)l=this.core.mmu.load32(f)/256,d=this.core.mmu.load32(f+4)/256,m=this.core.mmu.load16(f+8),A=this.core.mmu.load16(f+10),R=this.core.mmu.load16(f+12)/256,S=this.core.mmu.load16(f+14)/256,C=(this.core.mmu.loadU16(f+16)>>8)/128*Math.PI,f+=20,v=w=Math.cos(C),b=M=Math.sin(C),l=l-((v*=R)*m+(b*=-R)*A),A=d-((M*=S)*m+(w*=S)*A),this.core.mmu.store16(y,256*v|0),this.core.mmu.store16(y+2,256*b|0),this.core.mmu.store16(y+4,256*M|0),this.core.mmu.store16(y+6,256*w|0),this.core.mmu.store32(y+8,256*l|0),this.core.mmu.store32(y+12,256*A|0),y+=16;break;case 15:for(var R,S,C,v,b,M,w,s=this.cpu.gprs[2],f=this.cpu.gprs[0],y=this.cpu.gprs[1],g=this.cpu.gprs[3];s--;)R=this.core.mmu.load16(f)/256,S=this.core.mmu.load16(f+2)/256,C=(this.core.mmu.loadU16(f+4)>>8)/128*Math.PI,f+=6,v=w=Math.cos(C),b=M=Math.sin(C),v*=R,b*=-R,M*=S,w*=S,this.core.mmu.store16(y,256*v|0),this.core.mmu.store16(y+g,256*b|0),this.core.mmu.store16(y+2*g,256*M|0),this.core.mmu.store16(y+3*g,256*w|0),y+=4*g;break;case 17:this.lz77(this.cpu.gprs[0],this.cpu.gprs[1],1);break;case 18:this.lz77(this.cpu.gprs[0],this.cpu.gprs[1],2);break;case 19:this.huffman(this.cpu.gprs[0],this.cpu.gprs[1]);break;case 20:this.rl(this.cpu.gprs[0],this.cpu.gprs[1],1);break;case 21:this.rl(this.cpu.gprs[0],this.cpu.gprs[1],2);break;case 31:var I=this.cpu.mmu.load32(this.cpu.gprs[0]+4);this.cpu.gprs[0]=I/Math.pow(2,(180-this.cpu.gprs[1]-this.cpu.gprs[2]/256)/12)>>>0;break;default:throw"Unimplemented software interrupt: 0x"+t.toString(16)}},GameBoyAdvanceInterruptHandler.prototype.masterEnable=function(t){this.enable=t,this.enable&&this.enabledIRQs&this.interruptFlags&&this.cpu.raiseIRQ()},GameBoyAdvanceInterruptHandler.prototype.setInterruptsEnabled=function(t){this.enabledIRQs=t,this.enabledIRQs&this.MASK_SIO&&this.core.STUB("Serial I/O interrupts not implemented"),this.enabledIRQs&this.MASK_KEYPAD&&this.core.STUB("Keypad interrupts not implemented"),this.enable&&this.enabledIRQs&this.interruptFlags&&this.cpu.raiseIRQ()},GameBoyAdvanceInterruptHandler.prototype.pollNextEvent=function(){var t,e=this.video.nextEvent;this.audio.enabled&&(t=this.audio.nextEvent,(!e||t<e)&&(e=t)),this.timersEnabled&&(t=(i=this.timers[0]).nextEvent,i.enable&&t&&(!e||t<e)&&(e=t),t=(i=this.timers[1]).nextEvent,i.enable&&t&&(!e||t<e)&&(e=t),t=(i=this.timers[2]).nextEvent,i.enable&&t&&(!e||t<e)&&(e=t),t=(i=this.timers[3]).nextEvent,i.enable&&t&&(!e||t<e)&&(e=t));var i=this.dma[0];t=i.nextIRQ,i.enable&&i.doIrq&&t&&(!e||t<e)&&(e=t),t=(i=this.dma[1]).nextIRQ,i.enable&&i.doIrq&&t&&(!e||t<e)&&(e=t),t=(i=this.dma[2]).nextIRQ,i.enable&&i.doIrq&&t&&(!e||t<e)&&(e=t),t=(i=this.dma[3]).nextIRQ,i.enable&&i.doIrq&&t&&(!e||t<e)&&(e=t),this.core.ASSERT(e>=this.cpu.cycles,"Next event is before present"),this.nextEvent=e},GameBoyAdvanceInterruptHandler.prototype.waitForIRQ=function(){var t,e=this.testIRQ()||this.video.hblankIRQ||this.video.vblankIRQ||this.video.vcounterIRQ;if(this.timersEnabled&&(t=this.timers[0],e=e||t.doIrq,t=this.timers[1],e=e||t.doIrq,t=this.timers[2],e=e||t.doIrq,t=this.timers[3],e=e||t.doIrq),!e)return!1;for(;;){if(this.pollNextEvent(),!this.nextEvent)return!1;if(this.cpu.cycles=this.nextEvent,this.updateTimers(),this.interruptFlags)return!0}},GameBoyAdvanceInterruptHandler.prototype.testIRQ=function(){return!!(this.enable&&this.enabledIRQs&this.interruptFlags)&&(this.springIRQ=!0,this.nextEvent=this.cpu.cycles,!0)},GameBoyAdvanceInterruptHandler.prototype.raiseIRQ=function(t){this.interruptFlags|=1<<t,this.io.registers[this.io.IF>>1]=this.interruptFlags,this.enable&&this.enabledIRQs&1<<t&&this.cpu.raiseIRQ()},GameBoyAdvanceInterruptHandler.prototype.dismissIRQs=function(t){this.interruptFlags&=~t,this.io.registers[this.io.IF>>1]=this.interruptFlags},GameBoyAdvanceInterruptHandler.prototype.dmaSetSourceAddress=function(t,e){this.dma[t].source=4294967294&e},GameBoyAdvanceInterruptHandler.prototype.dmaSetDestAddress=function(t,e){this.dma[t].dest=4294967294&e},GameBoyAdvanceInterruptHandler.prototype.dmaSetWordCount=function(t,e){this.dma[t].count=e||(3==t?65536:16384)},GameBoyAdvanceInterruptHandler.prototype.dmaWriteControl=function(t,e){var i=this.dma[t],s=i.enable;i.dstControl=(96&e)>>5,i.srcControl=(384&e)>>7,i.repeat=!!(512&e),i.width=1024&e?4:2,i.drq=!!(2048&e),i.timing=(12288&e)>>12,i.doIrq=!!(16384&e),i.enable=!!(32768&e),i.nextIRQ=0,i.drq&&this.core.WARN("DRQ not implemented"),!s&&i.enable&&(i.nextSource=i.source,i.nextDest=i.dest,i.nextCount=i.count,this.cpu.mmu.scheduleDma(t,i))},GameBoyAdvanceInterruptHandler.prototype.timerSetReload=function(t,e){this.timers[t].reload=65535&e},GameBoyAdvanceInterruptHandler.prototype.timerWriteControl=function(t,e){var i=this.timers[t],s=i.prescaleBits;switch(3&e){case 0:i.prescaleBits=0;break;case 1:i.prescaleBits=6;break;case 2:i.prescaleBits=8;break;case 3:i.prescaleBits=10}i.countUp=!!(4&e),i.doIrq=!!(64&e),i.overflowInterval=65536-i.reload<<i.prescaleBits;var r=i.enable;i.enable=!!((128&e)>>7<<t),!r&&i.enable?(i.countUp?i.nextEvent=0:(i.lastEvent=this.cpu.cycles,i.nextEvent=this.cpu.cycles+i.overflowInterval),this.io.registers[this.io.TM0CNT_LO+(t<<2)>>1]=i.reload,i.oldReload=i.reload,++this.timersEnabled):r&&!i.enable?(i.countUp||(this.io.registers[this.io.TM0CNT_LO+(t<<2)>>1]=i.oldReload+(this.cpu.cycles-i.lastEvent)>>s),--this.timersEnabled):i.prescaleBits==s||i.countUp||(i.nextEvent=i.lastEvent+i.overflowInterval),this.pollNextEvent()},GameBoyAdvanceInterruptHandler.prototype.timerRead=function(t){var e=this.timers[t];return e.enable&&!e.countUp?e.oldReload+(this.cpu.cycles-e.lastEvent)>>e.prescaleBits:this.io.registers[this.io.TM0CNT_LO+(t<<2)>>1]},GameBoyAdvanceInterruptHandler.prototype.halt=function(){if(!this.enable)throw"Requested HALT when interrupts were disabled!";if(!this.waitForIRQ())throw"Waiting on interrupt forever."},GameBoyAdvanceInterruptHandler.prototype.lz77=function(t,e,i){for(var s,r,a,n,o,h=(4294967040&this.cpu.mmu.load32(t))>>8,c=t+4,u=e,p=0,d=0;0<h;)if(p){if(128&s)for(r=this.cpu.mmu.loadU8(c)|this.cpu.mmu.loadU8(c+1)<<8,c+=2,a=u-((15&r)<<8|(65280&r)>>8)-1,n=3+((240&r)>>4);n--&&h;)o=this.cpu.mmu.loadU8(a++),2==i?(d>>=8,d|=o<<8,1&u&&this.cpu.mmu.store16(u-1,d)):this.cpu.mmu.store8(u,o),--h,++u;else o=this.cpu.mmu.loadU8(c++),2==i?(d>>=8,d|=o<<8,1&u&&this.cpu.mmu.store16(u-1,d)):this.cpu.mmu.store8(u,o),--h,++u;s<<=1,--p}else s=this.cpu.mmu.loadU8(c++),p=8},GameBoyAdvanceInterruptHandler.prototype.huffman=function(t,e){t&=4294967292;var i=this.cpu.mmu.load32(t),s=i>>8,r=15&i;if(32%r)throw"Unimplemented unaligned Huffman";i=4-s&3;s&=4294967292;for(var a,n=[],o=1+(this.cpu.mmu.loadU8(t+4)<<1),h=t+5+o,c=4294967292&e,u=0;u<o;++u)n.push(this.cpu.mmu.loadU8(t+5+u));var p,d,m=0,l=0;for(f=n[0];0<s;){var A,f,y=this.cpu.mmu.load32(h);for(h+=4,p=32;0<p;--p,y<<=1){if("number"==typeof f&&(f={l:A=(m-1|1)+((63&f)<<1)+2,r:1+A,lTerm:128&f,rTerm:64&f},n[m]=f),2147483648&y){if(!f.rTerm){m=f.r,f=n[f.r];continue}d=n[f.r]}else{if(!f.lTerm){f=n[m=f.l];continue}d=n[f.l]}a|=(d&(1<<r)-1)<<l,l+=r,f=n[m=0],32==l&&(l=0,this.cpu.mmu.store32(c,a),c+=4,s-=4,a=0)}}i&&this.cpu.mmu.store32(c,a)},GameBoyAdvanceInterruptHandler.prototype.rl=function(t,e,i){t&=4294967292;for(var s,r,a=(4294967040&this.cpu.mmu.load32(t))>>8,n=4-a&3,o=t+4,h=e,c=0;0<a;)if(128&(s=this.cpu.mmu.loadU8(o++)))for(s&=127,s+=3,r=this.cpu.mmu.loadU8(o++);s--&&a;)--a,2==i?(c>>=8,c|=r<<8,1&h&&this.cpu.mmu.store16(h-1,c)):this.cpu.mmu.store8(h,r),++h;else for(s++;s--&&a;)--a,r=this.cpu.mmu.loadU8(o++),2==i?(c>>=8,c|=r<<8,1&h&&this.cpu.mmu.store16(h-1,c)):this.cpu.mmu.store8(h,r),++h;for(;n--;)this.cpu.mmu.store8(h++,0)},GameBoyAdvanceKeypad.prototype.keyboardHandler=function(t){var e=0;switch(t.keyCode){case this.KEYCODE_START:e=this.START;break;case this.KEYCODE_SELECT:e=this.SELECT;break;case this.KEYCODE_A:e=this.A;break;case this.KEYCODE_B:e=this.B;break;case this.KEYCODE_L:e=this.L;break;case this.KEYCODE_R:e=this.R;break;case this.KEYCODE_UP:e=this.UP;break;case this.KEYCODE_RIGHT:e=this.RIGHT;break;case this.KEYCODE_DOWN:e=this.DOWN;break;case this.KEYCODE_LEFT:e=this.LEFT;break;default:return}e=1<<e,"keydown"==t.type?this.currentDown&=~e:this.currentDown|=e,this.eatInput&&t.preventDefault()},GameBoyAdvanceKeypad.prototype.gamepadHandler=function(t){var e=0;t.buttons[this.GAMEPAD_LEFT]>this.GAMEPAD_THRESHOLD&&(e|=1<<this.LEFT),t.buttons[this.GAMEPAD_UP]>this.GAMEPAD_THRESHOLD&&(e|=1<<this.UP),t.buttons[this.GAMEPAD_RIGHT]>this.GAMEPAD_THRESHOLD&&(e|=1<<this.RIGHT),t.buttons[this.GAMEPAD_DOWN]>this.GAMEPAD_THRESHOLD&&(e|=1<<this.DOWN),t.buttons[this.GAMEPAD_START]>this.GAMEPAD_THRESHOLD&&(e|=1<<this.START),t.buttons[this.GAMEPAD_SELECT]>this.GAMEPAD_THRESHOLD&&(e|=1<<this.SELECT),t.buttons[this.GAMEPAD_A]>this.GAMEPAD_THRESHOLD&&(e|=1<<this.A),t.buttons[this.GAMEPAD_B]>this.GAMEPAD_THRESHOLD&&(e|=1<<this.B),t.buttons[this.GAMEPAD_L]>this.GAMEPAD_THRESHOLD&&(e|=1<<this.L),t.buttons[this.GAMEPAD_R]>this.GAMEPAD_THRESHOLD&&(e|=1<<this.R),this.currentDown=1023&~e},GameBoyAdvanceKeypad.prototype.gamepadConnectHandler=function(t){this.gamepads.push(t)},GameBoyAdvanceKeypad.prototype.gamepadDisconnectHandler=function(e){this.gamepads=self.gamepads.filter(function(t){return t!=e})},GameBoyAdvanceKeypad.prototype.pollGamepads=function(){var t=[];navigator.webkitGetGamepads?t=navigator.webkitGetGamepads():navigator.getGamepads&&(t=navigator.getGamepads()),t.length&&(this.gamepads=[]);for(var e=0;e<t.length;++e)t[e]&&this.gamepads.push(t[e]);0<this.gamepads.length&&this.gamepadHandler(this.gamepads[0])},GameBoyAdvanceKeypad.prototype.registerHandlers=function(){window.addEventListener("keydown",this.keyboardHandler.bind(this),!0),window.addEventListener("keyup",this.keyboardHandler.bind(this),!0),window.addEventListener("gamepadconnected",this.gamepadConnectHandler.bind(this),!0),window.addEventListener("mozgamepadconnected",this.gamepadConnectHandler.bind(this),!0),window.addEventListener("webkitgamepadconnected",this.gamepadConnectHandler.bind(this),!0),window.addEventListener("gamepaddisconnected",this.gamepadDisconnectHandler.bind(this),!0),window.addEventListener("mozgamepaddisconnected",this.gamepadDisconnectHandler.bind(this),!0),window.addEventListener("webkitgamepaddisconnected",this.gamepadDisconnectHandler.bind(this),!0)},MemoryView.prototype.resetMask=function(){this.mask8=4294967295&this.mask,this.mask16=4294967294&this.mask,this.mask32=4294967292&this.mask},MemoryView.prototype.load8=function(t){return this.view.getInt8(t&this.mask8)},MemoryView.prototype.load16=function(t){return this.view.getInt16(t&this.mask,!0)},MemoryView.prototype.loadU8=function(t){return this.view.getUint8(t&this.mask8)},MemoryView.prototype.loadU16=function(t){return this.view.getUint16(t&this.mask,!0)},MemoryView.prototype.load32=function(t){var e=(3&t)<<3,t=this.view.getInt32(t&this.mask32,!0);return t>>>e|t<<32-e},MemoryView.prototype.store8=function(t,e){this.view.setInt8(t&this.mask8,e)},MemoryView.prototype.store16=function(t,e){this.view.setInt16(t&this.mask16,e,!0)},MemoryView.prototype.store32=function(t,e){this.view.setInt32(t&this.mask32,e,!0)},MemoryView.prototype.invalidatePage=function(t){},MemoryView.prototype.replaceData=function(t,e){this.buffer=t,this.view=new DataView(this.buffer,"number"==typeof e?e:0),this.icache&&(this.icache=new Array(this.icache.length))},MemoryBlock.prototype=Object.create(MemoryView.prototype),MemoryBlock.prototype.invalidatePage=function(t){t=this.icache[(t&this.mask)>>this.ICACHE_PAGE_BITS];t&&(t.invalid=!0)},ROMView.prototype=Object.create(MemoryView.prototype),ROMView.prototype.store8=function(t,e){},ROMView.prototype.store16=function(t,e){t<202&&196<=t&&(this.gpio||(this.gpio=this.mmu.allocGPIO(this)),this.gpio.store16(t,e))},ROMView.prototype.store32=function(t,e){t<202&&196<=t&&(this.gpio||(this.gpio=this.mmu.allocGPIO(this)),this.gpio.store32(t,e))},BIOSView.prototype=Object.create(MemoryView.prototype),BIOSView.prototype.load8=function(t){return t>=this.buffer.byteLength?-1:this.view.getInt8(t)},BIOSView.prototype.load16=function(t){return t>=this.buffer.byteLength?-1:this.view.getInt16(t,!0)},BIOSView.prototype.loadU8=function(t){return t>=this.buffer.byteLength?-1:this.view.getUint8(t)},BIOSView.prototype.loadU16=function(t){return t>=this.buffer.byteLength?-1:this.view.getUint16(t,!0)},BIOSView.prototype.load32=function(t){return t>=this.buffer.byteLength?-1:this.view.getInt32(t,!0)},BIOSView.prototype.store8=function(t,e){},BIOSView.prototype.store16=function(t,e){},BIOSView.prototype.store32=function(t,e){},BadMemory.prototype.load8=function(t){return this.mmu.load8(this.cpu.gprs[this.cpu.PC]-this.cpu.instructionWidth+(3&t))},BadMemory.prototype.load16=function(t){return this.mmu.load16(this.cpu.gprs[this.cpu.PC]-this.cpu.instructionWidth+(2&t))},BadMemory.prototype.loadU8=function(t){return this.mmu.loadU8(this.cpu.gprs[this.cpu.PC]-this.cpu.instructionWidth+(3&t))},BadMemory.prototype.loadU16=function(t){return this.mmu.loadU16(this.cpu.gprs[this.cpu.PC]-this.cpu.instructionWidth+(2&t))},BadMemory.prototype.load32=function(t){if(this.cpu.execMode==this.cpu.MODE_ARM)return this.mmu.load32(this.cpu.gprs[this.cpu.gprs.PC]-this.cpu.instructionWidth);var e=this.mmu.loadU16(this.cpu.gprs[this.cpu.PC]-this.cpu.instructionWidth);return e|e<<16},BadMemory.prototype.store8=function(t,e){},BadMemory.prototype.store16=function(t,e){},BadMemory.prototype.store32=function(t,e){},BadMemory.prototype.invalidatePage=function(t){},GameBoyAdvanceMMU.prototype.mmap=function(t,e){this.memory[t]=e},GameBoyAdvanceMMU.prototype.clear=function(){this.badMemory=new BadMemory(this,this.cpu),this.memory=[this.bios,this.badMemory,new MemoryBlock(this.SIZE_WORKING_RAM,9),new MemoryBlock(this.SIZE_WORKING_IRAM,7),null,null,null,null,this.badMemory,this.badMemory,this.badMemory,this.badMemory,this.badMemory,this.badMemory,this.badMemory,this.badMemory];for(var t=16;t<256;++t)this.memory[t]=this.badMemory;this.waitstates=this.WAITSTATES.slice(0),this.waitstatesSeq=this.WAITSTATES_SEQ.slice(0),this.waitstates32=this.WAITSTATES_32.slice(0),this.waitstatesSeq32=this.WAITSTATES_SEQ_32.slice(0),this.waitstatesPrefetch=this.WAITSTATES_SEQ.slice(0),this.waitstatesPrefetch32=this.WAITSTATES_SEQ_32.slice(0),this.cart=null,this.save=null,this.DMA_REGISTER=[this.core.io.DMA0CNT_HI>>1,this.core.io.DMA1CNT_HI>>1,this.core.io.DMA2CNT_HI>>1,this.core.io.DMA3CNT_HI>>1]},GameBoyAdvanceMMU.prototype.freeze=function(){return{ram:Serializer.prefix(this.memory[this.REGION_WORKING_RAM].buffer),iram:Serializer.prefix(this.memory[this.REGION_WORKING_IRAM].buffer)}},GameBoyAdvanceMMU.prototype.defrost=function(t){this.memory[this.REGION_WORKING_RAM].replaceData(t.ram),this.memory[this.REGION_WORKING_IRAM].replaceData(t.iram)},GameBoyAdvanceMMU.prototype.loadBios=function(t,e){this.bios=new BIOSView(t),this.bios.real=!!e},GameBoyAdvanceMMU.prototype.loadRom=function(t,e){var i,s={title:null,code:null,maker:null,memory:t,saveType:null},r=new ROMView(t);if(150!=r.view.getUint8(178))return null;if((r.mmu=this).memory[this.REGION_CART0]=r,this.memory[this.REGION_CART1]=r,this.memory[this.REGION_CART2]=r,16777216<t.byteLength&&(i=new ROMView(t,16777216),this.memory[this.REGION_CART0+1]=i,this.memory[this.REGION_CART1+1]=i,this.memory[this.REGION_CART2+1]=i),e){for(var a="",n=0;n<12;++n){if(!(h=r.loadU8(n+160)))break;a+=String.fromCharCode(h)}s.title=a;for(var o="",n=0;n<4;++n){if(!(h=r.loadU8(n+172)))break;o+=String.fromCharCode(h)}s.code=o;for(var h,c="",n=0;n<2;++n){if(!(h=r.loadU8(n+176)))break;c+=String.fromCharCode(h)}s.maker=c;for(var u,p="",d=!1,n=228;n<t.byteLength&&!d;++n)switch(p+=u=String.fromCharCode(r.loadU8(n))){case"F":case"FL":case"FLA":case"FLAS":case"FLASH":case"FLASH_":case"FLASH5":case"FLASH51":case"FLASH512":case"FLASH512_":case"FLASH1":case"FLASH1M":case"FLASH1M_":case"S":case"SR":case"SRA":case"SRAM":case"SRAM_":case"E":case"EE":case"EEP":case"EEPR":case"EEPRO":case"EEPROM":case"EEPROM_":break;case"FLASH_V":case"FLASH512_V":case"FLASH1M_V":case"SRAM_V":case"EEPROM_V":d=!0;break;default:p=u}if(d)switch(s.saveType=p){case"FLASH_V":case"FLASH512_V":this.save=this.memory[this.REGION_CART_SRAM]=new FlashSavedata(this.SIZE_CART_FLASH512);break;case"FLASH1M_V":this.save=this.memory[this.REGION_CART_SRAM]=new FlashSavedata(this.SIZE_CART_FLASH1M);break;case"SRAM_V":this.save=this.memory[this.REGION_CART_SRAM]=new SRAMSavedata(this.SIZE_CART_SRAM);break;case"EEPROM_V":this.save=this.memory[this.REGION_CART2+1]=new EEPROMSavedata(this.SIZE_CART_EEPROM,this)}this.save||(this.save=this.memory[this.REGION_CART_SRAM]=new SRAMSavedata(this.SIZE_CART_SRAM))}return this.cart=s},GameBoyAdvanceMMU.prototype.loadSavedata=function(t){this.save.replaceData(t)},GameBoyAdvanceMMU.prototype.load8=function(t){return this.memory[t>>>this.BASE_OFFSET].load8(16777215&t)},GameBoyAdvanceMMU.prototype.load16=function(t){return this.memory[t>>>this.BASE_OFFSET].load16(16777215&t)},GameBoyAdvanceMMU.prototype.load32=function(t){return this.memory[t>>>this.BASE_OFFSET].load32(16777215&t)},GameBoyAdvanceMMU.prototype.loadU8=function(t){return this.memory[t>>>this.BASE_OFFSET].loadU8(16777215&t)},GameBoyAdvanceMMU.prototype.loadU16=function(t){return this.memory[t>>>this.BASE_OFFSET].loadU16(16777215&t)},GameBoyAdvanceMMU.prototype.store8=function(t,e){var i=16777215&t,t=this.memory[t>>>this.BASE_OFFSET];t.store8(i,e),t.invalidatePage(i)},GameBoyAdvanceMMU.prototype.store16=function(t,e){var i=16777214&t,t=this.memory[t>>>this.BASE_OFFSET];t.store16(i,e),t.invalidatePage(i)},GameBoyAdvanceMMU.prototype.store32=function(t,e){var i=16777212&t,t=this.memory[t>>>this.BASE_OFFSET];t.store32(i,e),t.invalidatePage(i),t.invalidatePage(2+i)},GameBoyAdvanceMMU.prototype.waitPrefetch=function(t){this.cpu.cycles+=1+this.waitstatesPrefetch[t>>>this.BASE_OFFSET]},GameBoyAdvanceMMU.prototype.waitPrefetch32=function(t){this.cpu.cycles+=1+this.waitstatesPrefetch32[t>>>this.BASE_OFFSET]},GameBoyAdvanceMMU.prototype.wait=function(t){this.cpu.cycles+=1+this.waitstates[t>>>this.BASE_OFFSET]},GameBoyAdvanceMMU.prototype.wait32=function(t){this.cpu.cycles+=1+this.waitstates32[t>>>this.BASE_OFFSET]},GameBoyAdvanceMMU.prototype.waitSeq=function(t){this.cpu.cycles+=1+this.waitstatesSeq[t>>>this.BASE_OFFSET]},GameBoyAdvanceMMU.prototype.waitSeq32=function(t){this.cpu.cycles+=1+this.waitstatesSeq32[t>>>this.BASE_OFFSET]},GameBoyAdvanceMMU.prototype.waitMul=function(t){this.cpu.cycles+=!0&t||!(4294967040&t)?1:!0&t||!(4294901760&t)?2:!0&t||!(4278190080&t)?3:4},GameBoyAdvanceMMU.prototype.waitMulti32=function(t,e){this.cpu.cycles+=1+this.waitstates32[t>>>this.BASE_OFFSET],this.cpu.cycles+=(1+this.waitstatesSeq32[t>>>this.BASE_OFFSET])*(e-1)},GameBoyAdvanceMMU.prototype.addressToPage=function(t,e){return e>>this.memory[t].ICACHE_PAGE_BITS},GameBoyAdvanceMMU.prototype.accessPage=function(t,e){var i=this.memory[t],t=i.icache[e];return t&&!t.invalid||(t={thumb:new Array(1<<i.ICACHE_PAGE_BITS),arm:new Array(1<<i.ICACHE_PAGE_BITS-1),invalid:!1},i.icache[e]=t),t},GameBoyAdvanceMMU.prototype.scheduleDma=function(t,e){switch(e.timing){case this.DMA_TIMING_NOW:this.serviceDma(t,e);break;case this.DMA_TIMING_HBLANK:case this.DMA_TIMING_VBLANK:break;case this.DMA_TIMING_CUSTOM:switch(t){case 0:this.core.WARN("Discarding invalid DMA0 scheduling");break;case 1:case 2:this.cpu.irq.audio.scheduleFIFODma(t,e);break;case 3:this.cpu.irq.video.scheduleVCaptureDma(dma,e)}}},GameBoyAdvanceMMU.prototype.runHblankDmas=function(){for(var t,e=0;e<this.cpu.irq.dma.length;++e)(t=this.cpu.irq.dma[e]).enable&&t.timing==this.DMA_TIMING_HBLANK&&this.serviceDma(e,t)},GameBoyAdvanceMMU.prototype.runVblankDmas=function(){for(var t,e=0;e<this.cpu.irq.dma.length;++e)(t=this.cpu.irq.dma[e]).enable&&t.timing==this.DMA_TIMING_VBLANK&&this.serviceDma(e,t)},GameBoyAdvanceMMU.prototype.serviceDma=function(t,e){if(e.enable){var i,s=e.width,r=this.DMA_OFFSET[e.srcControl]*s,a=this.DMA_OFFSET[e.dstControl]*s,n=e.nextCount,o=e.nextSource&this.OFFSET_MASK,h=e.nextDest&this.OFFSET_MASK,c=e.nextSource>>>this.BASE_OFFSET,u=e.nextDest>>>this.BASE_OFFSET,p=this.memory[c],d=this.memory[u],m=null,l=null,A=4294967295,f=4294967295;if(d.ICACHE_PAGE_BITS)for(var y=h+n*s>>d.ICACHE_PAGE_BITS,R=h>>d.ICACHE_PAGE_BITS;R<=y;++R)d.invalidatePage(R<<d.ICACHE_PAGE_BITS);if(u!=this.REGION_WORKING_RAM&&u!=this.REGION_WORKING_IRAM||(l=d.view,f=d.mask),c!=this.REGION_WORKING_RAM&&c!=this.REGION_WORKING_IRAM&&c!=this.REGION_CART0&&c!=this.REGION_CART1||(m=p.view,A=p.mask),p&&d)if(m&&l)if(4==s)for(o&=4294967292,h&=4294967292;n--;)i=m.getInt32(o&A),l.setInt32(h&f,i),o+=r,h+=a;else for(;n--;)i=m.getUint16(o&A),l.setUint16(h&f,i),o+=r,h+=a;else if(m)if(4==s)for(o&=4294967292,h&=4294967292;n--;)i=m.getInt32(o&A,!0),d.store32(h,i),o+=r,h+=a;else for(;n--;)i=m.getUint16(o&A,!0),d.store16(h,i),o+=r,h+=a;else if(4==s)for(o&=4294967292,h&=4294967292;n--;)i=p.load32(o),d.store32(h,i),o+=r,h+=a;else for(;n--;)i=p.loadU16(o),d.store16(h,i),o+=r,h+=a;else this.core.WARN("Invalid DMA");e.doIrq&&(e.nextIRQ=this.cpu.cycles+2,e.nextIRQ+=4==s?this.waitstates32[c]+this.waitstates32[u]:this.waitstates[c]+this.waitstates[u],e.nextIRQ+=(e.count-1)*(4==s?this.waitstatesSeq32[c]+this.waitstatesSeq32[u]:this.waitstatesSeq[c]+this.waitstatesSeq[u])),e.nextSource=o|c<<this.BASE_OFFSET,e.nextDest=h|u<<this.BASE_OFFSET,e.nextCount=n,e.repeat?(e.nextCount=e.count,e.dstControl==this.DMA_INCREMENT_RELOAD&&(e.nextDest=e.dest),this.scheduleDma(t,e)):(e.enable=!1,this.memory[this.REGION_IO].registers[this.DMA_REGISTER[t]]&=32736)}},GameBoyAdvanceMMU.prototype.adjustTimings=function(t){var e=3&t,i=(12&t)>>2,s=(16&t)>>4,r=(96&t)>>5,a=(128&t)>>7,n=(768&t)>>8,o=(1024&t)>>10,t=16384&t;this.waitstates[this.REGION_CART_SRAM]=this.ROM_WS[e],this.waitstatesSeq[this.REGION_CART_SRAM]=this.ROM_WS[e],this.waitstates32[this.REGION_CART_SRAM]=this.ROM_WS[e],this.waitstatesSeq32[this.REGION_CART_SRAM]=this.ROM_WS[e],this.waitstates[this.REGION_CART0]=this.waitstates[this.REGION_CART0+1]=this.ROM_WS[i],this.waitstates[this.REGION_CART1]=this.waitstates[this.REGION_CART1+1]=this.ROM_WS[r],this.waitstates[this.REGION_CART2]=this.waitstates[this.REGION_CART2+1]=this.ROM_WS[n],this.waitstatesSeq[this.REGION_CART0]=this.waitstatesSeq[this.REGION_CART0+1]=this.ROM_WS_SEQ[0][s],this.waitstatesSeq[this.REGION_CART1]=this.waitstatesSeq[this.REGION_CART1+1]=this.ROM_WS_SEQ[1][a],this.waitstatesSeq[this.REGION_CART2]=this.waitstatesSeq[this.REGION_CART2+1]=this.ROM_WS_SEQ[2][o],this.waitstates32[this.REGION_CART0]=this.waitstates32[this.REGION_CART0+1]=this.waitstates[this.REGION_CART0]+1+this.waitstatesSeq[this.REGION_CART0],this.waitstates32[this.REGION_CART1]=this.waitstates32[this.REGION_CART1+1]=this.waitstates[this.REGION_CART1]+1+this.waitstatesSeq[this.REGION_CART1],this.waitstates32[this.REGION_CART2]=this.waitstates32[this.REGION_CART2+1]=this.waitstates[this.REGION_CART2]+1+this.waitstatesSeq[this.REGION_CART2],this.waitstatesSeq32[this.REGION_CART0]=this.waitstatesSeq32[this.REGION_CART0+1]=2*this.waitstatesSeq[this.REGION_CART0]+1,this.waitstatesSeq32[this.REGION_CART1]=this.waitstatesSeq32[this.REGION_CART1+1]=2*this.waitstatesSeq[this.REGION_CART1]+1,this.waitstatesSeq32[this.REGION_CART2]=this.waitstatesSeq32[this.REGION_CART2+1]=2*this.waitstatesSeq[this.REGION_CART2]+1,t?(this.waitstatesPrefetch[this.REGION_CART0]=this.waitstatesPrefetch[this.REGION_CART0+1]=0,this.waitstatesPrefetch[this.REGION_CART1]=this.waitstatesPrefetch[this.REGION_CART1+1]=0,this.waitstatesPrefetch[this.REGION_CART2]=this.waitstatesPrefetch[this.REGION_CART2+1]=0,this.waitstatesPrefetch32[this.REGION_CART0]=this.waitstatesPrefetch32[this.REGION_CART0+1]=0,this.waitstatesPrefetch32[this.REGION_CART1]=this.waitstatesPrefetch32[this.REGION_CART1+1]=0,this.waitstatesPrefetch32[this.REGION_CART2]=this.waitstatesPrefetch32[this.REGION_CART2+1]=0):(this.waitstatesPrefetch[this.REGION_CART0]=this.waitstatesPrefetch[this.REGION_CART0+1]=this.waitstatesSeq[this.REGION_CART0],this.waitstatesPrefetch[this.REGION_CART1]=this.waitstatesPrefetch[this.REGION_CART1+1]=this.waitstatesSeq[this.REGION_CART1],this.waitstatesPrefetch[this.REGION_CART2]=this.waitstatesPrefetch[this.REGION_CART2+1]=this.waitstatesSeq[this.REGION_CART2],this.waitstatesPrefetch32[this.REGION_CART0]=this.waitstatesPrefetch32[this.REGION_CART0+1]=this.waitstatesSeq32[this.REGION_CART0],this.waitstatesPrefetch32[this.REGION_CART1]=this.waitstatesPrefetch32[this.REGION_CART1+1]=this.waitstatesSeq32[this.REGION_CART1],this.waitstatesPrefetch32[this.REGION_CART2]=this.waitstatesPrefetch32[this.REGION_CART2+1]=this.waitstatesSeq32[this.REGION_CART2])},GameBoyAdvanceMMU.prototype.saveNeedsFlush=function(){return this.save.writePending},GameBoyAdvanceMMU.prototype.flushSave=function(){this.save.writePending=!1},GameBoyAdvanceMMU.prototype.allocGPIO=function(t){return new GameBoyAdvanceGPIO(this.core,t)},MemoryAligned16.prototype.load8=function(t){return this.loadU8(t)<<24>>24},MemoryAligned16.prototype.load16=function(t){return this.loadU16(t)<<16>>16},MemoryAligned16.prototype.loadU8=function(t){var e=t>>1;return 1&t?(65280&this.buffer[e])>>>8:255&this.buffer[e]},MemoryAligned16.prototype.loadU16=function(t){return this.buffer[t>>1]},MemoryAligned16.prototype.load32=function(t){return this.buffer[t>>1&-2]|this.buffer[t>>1|1]<<16},MemoryAligned16.prototype.store8=function(t,e){this.store16(t,e<<8|e)},MemoryAligned16.prototype.store16=function(t,e){this.buffer[t>>1]=e},MemoryAligned16.prototype.store32=function(t,e){var i=t>>1;this.store16(t,this.buffer[i]=65535&e),this.store16(t+2,this.buffer[1+i]=e>>>16)},MemoryAligned16.prototype.insert=function(t,e){this.buffer.set(e,t)},MemoryAligned16.prototype.invalidatePage=function(t){},GameBoyAdvanceVRAM.prototype=Object.create(MemoryAligned16.prototype),GameBoyAdvanceOAM.prototype=Object.create(MemoryAligned16.prototype),GameBoyAdvanceOAM.prototype.overwrite=function(t){for(var e=0;e<this.buffer.byteLength>>1;++e)this.store16(e<<1,t[e])},GameBoyAdvanceOAM.prototype.store16=function(t,e){var i=(1016&t)>>3,s=this.objs[i],r=this.scalerot[i>>2];s.priority,s.disable,s.y;switch(6&t){case 0:s.y=255&e;var a=s.scalerot;s.scalerot=256&e,s.scalerot?(s.scalerotOam=this.scalerot[s.scalerotParam],s.doublesize=!!(512&e),s.disable=0,s.hflip=0,s.vflip=0):(s.doublesize=!1,s.disable=512&e,a&&(s.hflip=8&s.scalerotParam,s.vflip=16&s.scalerotParam)),s.mode=(3072&e)>>6,s.mosaic=4096&e,s.multipalette=8192&e,s.shape=(49152&e)>>14,s.recalcSize();break;case 2:s.x=511&e,s.scalerot?(s.scalerotParam=(15872&e)>>9,s.scalerotOam=this.scalerot[s.scalerotParam],s.hflip=0,s.vflip=0,s.drawScanline=s.drawScanlineAffine):(s.hflip=4096&e,s.vflip=8192&e,s.drawScanline=s.drawScanlineNormal),s.size=(49152&e)>>14,s.recalcSize();break;case 4:s.tileBase=1023&e,s.priority=(3072&e)>>10,s.palette=(61440&e)>>8;break;case 6:switch(3&i){case 0:r.a=(e<<16)/16777216;break;case 1:r.b=(e<<16)/16777216;break;case 2:r.c=(e<<16)/16777216;break;case 3:r.d=(e<<16)/16777216}}MemoryAligned16.prototype.store16.call(this,t,e)},GameBoyAdvancePalette.prototype.overwrite=function(t){for(var e=0;e<512;++e)this.store16(e<<1,t[e])},GameBoyAdvancePalette.prototype.loadU8=function(t){return this.loadU16(t)>>8*(1&t)&255},GameBoyAdvancePalette.prototype.loadU16=function(t){return this.colors[(512&t)>>9][(511&t)>>1]},GameBoyAdvancePalette.prototype.load16=function(t){return this.loadU16(t)<<16>>16},GameBoyAdvancePalette.prototype.load32=function(t){return this.loadU16(t)|this.loadU16(t+2)<<16},GameBoyAdvancePalette.prototype.store16=function(t,e){var i=(512&t)>>9,t=(511&t)>>1;this.colors[i][t]=e,this.adjustedColors[i][t]=this.adjustColor(e)},GameBoyAdvancePalette.prototype.store32=function(t,e){this.store16(t,65535&e),this.store16(t+2,e>>16)},GameBoyAdvancePalette.prototype.invalidatePage=function(t){},GameBoyAdvancePalette.prototype.convert16To32=function(t,e){var i=(31&t)<<3,s=(992&t)>>2,t=(31744&t)>>7;e[0]=i,e[1]=s,e[2]=t},GameBoyAdvancePalette.prototype.mix=function(t,e,i,s){var r=31&e,a=(992&e)>>5,n=(31744&e)>>10,o=31&s,e=(992&s)>>5,s=(31744&s)>>10;return Math.min(t*r+i*o,31)|Math.min(t*a+i*e,31)<<5|Math.min(t*n+i*s,31)<<10},GameBoyAdvancePalette.prototype.makeDarkPalettes=function(t){this.adjustColor!=this.adjustColorDark&&(this.adjustColor=this.adjustColorDark,this.resetPalettes()),this.resetPaletteLayers(t)},GameBoyAdvancePalette.prototype.makeBrightPalettes=function(t){this.adjustColor!=this.adjustColorBright&&(this.adjustColor=this.adjustColorBright,this.resetPalettes()),this.resetPaletteLayers(t)},GameBoyAdvancePalette.prototype.makeNormalPalettes=function(){this.passthroughColors[0]=this.colors[0],this.passthroughColors[1]=this.colors[0],this.passthroughColors[2]=this.colors[0],this.passthroughColors[3]=this.colors[0],this.passthroughColors[4]=this.colors[1],this.passthroughColors[5]=this.colors[0]},GameBoyAdvancePalette.prototype.makeSpecialPalette=function(t){this.passthroughColors[t]=this.adjustedColors[4==t?1:0]},GameBoyAdvancePalette.prototype.makeNormalPalette=function(t){this.passthroughColors[t]=this.colors[4==t?1:0]},GameBoyAdvancePalette.prototype.resetPaletteLayers=function(t){this.passthroughColors[0]=(1&t?this.adjustedColors:this.colors)[0],this.passthroughColors[1]=(2&t?this.adjustedColors:this.colors)[0],this.passthroughColors[2]=(4&t?this.adjustedColors:this.colors)[0],this.passthroughColors[3]=(8&t?this.adjustedColors:this.colors)[0],this.passthroughColors[4]=(16&t?this.adjustedColors:this.colors)[1],this.passthroughColors[5]=(32&t?this.adjustedColors:this.colors)[0]},GameBoyAdvancePalette.prototype.resetPalettes=function(){for(var t=this.adjustedColors[0],e=this.colors[0],i=0;i<256;++i)t[i]=this.adjustColor(e[i]);for(t=this.adjustedColors[1],e=this.colors[1],i=0;i<256;++i)t[i]=this.adjustColor(e[i])},GameBoyAdvancePalette.prototype.accessColor=function(t,e){return this.passthroughColors[t][e]},GameBoyAdvancePalette.prototype.adjustColorDark=function(t){var e=31&t,i=(992&t)>>5,t=(31744&t)>>10;return(e-=e*this.blendY)|(i-=i*this.blendY)<<5|(t-=t*this.blendY)<<10},GameBoyAdvancePalette.prototype.adjustColorBright=function(t){var e=31&t,i=(992&t)>>5,t=(31744&t)>>10;return(e+=(31-e)*this.blendY)|(i+=(31-i)*this.blendY)<<5|(t+=(31-t)*this.blendY)<<10},GameBoyAdvancePalette.prototype.adjustColor=GameBoyAdvancePalette.prototype.adjustColorBright,GameBoyAdvancePalette.prototype.setBlendY=function(t){this.blendY!=t&&(this.blendY=t,this.resetPalettes())},GameBoyAdvanceOBJ.prototype.drawScanlineNormal=function(t,e,i,s,r){var a,n,o=this.oam.video,h=this.mode|o.target2[o.LAYER_OBJ]|this.priority<<1;16==this.mode&&(h|=o.TARGET1_MASK),1==o.blendMode&&o.alphaEnabled&&(h|=o.target1[o.LAYER_OBJ]);var c,u=this.cachedWidth;this.x<o.HORIZONTAL_PIXELS?(n=this.x<s?(a=s-this.x,s):(a=0,this.x),r<this.cachedWidth+this.x&&(u=r-this.x)):(a=s+512-this.x,n=s,r<this.cachedWidth-a&&(u=r));var p,d=7&(i=this.vflip?this.cachedHeight-e+i-1:e-i),m=this.multipalette?1:0,l=o.objCharacterMapping?(504&i)*this.cachedWidth>>6:(504&i)<<2-m;this.mosaic&&(n+=p=o.objMosaicX-1-(o.objMosaicX+n-1)%o.objMosaicX,a+=p),c=this.hflip?this.cachedWidth-a-1:a;for(var A=o.accessTile(this.TILE_OFFSET+(4&f)*m,this.tileBase+(l<<m)+((504&c)>>3-m),d<<m),f=a;f<u;++f)p=this.mosaic?n%o.objMosaicX:0,c=this.hflip?this.cachedWidth-(f-p)-1:f-p,m?3&f&&(!this.mosaic||p)||(A=o.accessTile(this.TILE_OFFSET+(4&c),this.tileBase+(l<<1)+((504&c)>>2),d<<1)):7&f&&(!this.mosaic||p)||(A=o.accessTile(this.TILE_OFFSET,this.tileBase+l+(c>>3),d)),this.pushPixel(o.LAYER_OBJ,this,o,A,7&c,n,t,h,!1),n++},GameBoyAdvanceOBJ.prototype.drawScanlineAffine=function(t,e,i,s,r){var a,n,o,h,c,u=this.oam.video,p=this.mode|u.target2[u.LAYER_OBJ]|this.priority<<1;16==this.mode&&(p|=u.TARGET1_MASK),1==u.blendMode&&u.alphaEnabled&&(p|=u.target1[u.LAYER_OBJ]);var d,m=e-i,l=this.multipalette?1:0,A=this.cachedWidth<<this.doublesize,f=this.cachedHeight<<this.doublesize,y=A;for(y>u.HORIZONTAL_PIXELS&&(A=u.HORIZONTAL_PIXELS),this.x<u.HORIZONTAL_PIXELS?(o=this.x<s?(n=s-this.x,s):(n=0,this.x),r<y+this.x&&(y=r-this.x)):r<y-(n=(o=s)+512-this.x)&&(y=r),a=n;a<y;++a)h=this.scalerotOam.a*(a-(A>>1))+this.scalerotOam.b*(m-(f>>1))+(this.cachedWidth>>1),c=this.scalerotOam.c*(a-(A>>1))+this.scalerotOam.d*(m-(f>>1))+(this.cachedHeight>>1),this.mosaic&&(h-=a%u.objMosaicX*this.scalerotOam.a+e%u.objMosaicY*this.scalerotOam.b,c-=a%u.objMosaicX*this.scalerotOam.c+e%u.objMosaicY*this.scalerotOam.d),h<0||h>=this.cachedWidth||c<0||c>=this.cachedHeight||(d=u.objCharacterMapping?(504&c)*this.cachedWidth>>6:(504&c)<<2-l,tileRow=u.accessTile(this.TILE_OFFSET+(4&h)*l,this.tileBase+(d<<l)+((504&h)>>3-l),(7&c)<<l),this.pushPixel(u.LAYER_OBJ,this,u,tileRow,7&h,o,t,p,!1)),o++},GameBoyAdvanceOBJ.prototype.recalcSize=function(){switch(this.shape){case 0:this.cachedHeight=this.cachedWidth=8<<this.size;break;case 1:switch(this.size){case 0:this.cachedHeight=8,this.cachedWidth=16;break;case 1:this.cachedHeight=8,this.cachedWidth=32;break;case 2:this.cachedHeight=16,this.cachedWidth=32;break;case 3:this.cachedHeight=32,this.cachedWidth=64}break;case 2:switch(this.size){case 0:this.cachedHeight=16,this.cachedWidth=8;break;case 1:this.cachedHeight=32,this.cachedWidth=8;break;case 2:this.cachedHeight=32,this.cachedWidth=16;break;case 3:this.cachedHeight=64,this.cachedWidth=32}}},GameBoyAdvanceOBJLayer.prototype.drawScanline=function(t,e,i,s){var r=this.video.vcount;if(!(s<=i))for(var a,n,o,h,c=this.video.oam.objs,u=0;u<c.length;++u)(h=c[u]).disable||(h.mode&this.video.OBJWIN_MASK)==this.objwin&&(h.mode&this.video.OBJWIN_MASK||this.priority==h.priority)&&(a=h.y<this.video.VERTICAL_PIXELS?h.y:h.y-256,n=h.scalerot?h.cachedHeight<<h.doublesize:h.cachedHeight,o=h.mosaic?r-r%this.video.objMosaicY:r,a<=r&&r<a+n&&h.drawScanline(t,o,a,i,s))},GameBoyAdvanceOBJLayer.prototype.objComparator=function(t,e){return t.index-e.index},GameBoyAdvanceSoftwareRenderer.prototype.clear=function(t){this.palette=new GameBoyAdvancePalette,this.vram=new GameBoyAdvanceVRAM(t.SIZE_VRAM),this.oam=new GameBoyAdvanceOAM(t.SIZE_OAM),(this.oam.video=this).objLayers=[new GameBoyAdvanceOBJLayer(this,0),new GameBoyAdvanceOBJLayer(this,1),new GameBoyAdvanceOBJLayer(this,2),new GameBoyAdvanceOBJLayer(this,3)],this.objwinLayer=new GameBoyAdvanceOBJLayer(this,4),this.objwinLayer.objwin=this.OBJWIN_MASK,this.backgroundMode=0,this.displayFrameSelect=0,this.hblankIntervalFree=0,this.objCharacterMapping=0,this.forcedBlank=1,this.win0=0,this.win1=0,this.objwin=0,this.vcount=-1,this.win0Left=0,this.win0Right=240,this.win1Left=0,this.win1Right=240,this.win0Top=0,this.win0Bottom=160,this.win1Top=0,this.win1Bottom=160,this.windows=new Array;for(var e=0;e<4;++e)this.windows.push({enabled:[!1,!1,!1,!1,!1,!0],special:0});this.target1=new Array(5),this.target2=new Array(5),this.blendMode=0,this.blendA=0,this.blendB=0,this.blendY=0,this.bgMosaicX=1,this.bgMosaicY=1,this.objMosaicX=1,this.objMosaicY=1,this.lastHblank=0,this.nextHblank=this.HDRAW_LENGTH,this.nextEvent=this.nextHblank,this.nextHblankIRQ=0,this.nextVblankIRQ=0,this.nextVcounterIRQ=0,this.bg=new Array;for(e=0;e<4;++e)this.bg.push({bg:!0,index:e,enabled:!1,video:this,vram:this.vram,priority:0,charBase:0,mosaic:!1,multipalette:!1,screenBase:0,overflow:0,size:0,x:0,y:0,refx:0,refy:0,dx:1,dmx:0,dy:0,dmy:1,sx:0,sy:0,pushPixel:GameBoyAdvanceSoftwareRenderer.pushPixel,drawScanline:this.drawScanlineBGMode0});this.bgModes=[this.drawScanlineBGMode0,this.drawScanlineBGMode2,this.drawScanlineBGMode2,this.drawScanlineBGMode3,this.drawScanlineBGMode4,this.drawScanlineBGMode5],this.drawLayers=[this.bg[0],this.bg[1],this.bg[2],this.bg[3],this.objLayers[0],this.objLayers[1],this.objLayers[2],this.objLayers[3],this.objwinLayer,this.drawBackdrop],objwinActive=!1,this.alphaEnabled=!1,this.scanline={color:new Uint16Array(this.HORIZONTAL_PIXELS),stencil:new Uint8Array(this.HORIZONTAL_PIXELS)},this.sharedColor=[0,0,0],this.sharedMap={tile:0,hflip:!1,vflip:!1,palette:0}},GameBoyAdvanceSoftwareRenderer.prototype.clearSubsets=function(t,e){4&e&&this.palette.overwrite(new Uint16Array(t.SIZE_PALETTE>>1)),8&e&&this.vram.insert(0,new Uint16Array(t.SIZE_VRAM>>1)),16&e&&(this.oam.overwrite(new Uint16Array(t.SIZE_OAM>>1)),this.oam.video=this)},GameBoyAdvanceSoftwareRenderer.prototype.freeze=function(){},GameBoyAdvanceSoftwareRenderer.prototype.defrost=function(t){},GameBoyAdvanceSoftwareRenderer.prototype.setBacking=function(t){this.pixelData=t;for(var e=0;e<this.HORIZONTAL_PIXELS*this.VERTICAL_PIXELS*4;)this.pixelData.data[e++]=255,this.pixelData.data[e++]=255,this.pixelData.data[e++]=255,this.pixelData.data[e++]=255},GameBoyAdvanceSoftwareRenderer.prototype.writeDisplayControl=function(t){this.backgroundMode=7&t,this.displayFrameSelect=16&t,this.hblankIntervalFree=32&t,this.objCharacterMapping=64&t,this.forcedBlank=128&t,this.bg[0].enabled=256&t,this.bg[1].enabled=512&t,this.bg[2].enabled=1024&t,this.bg[3].enabled=2048&t,this.objLayers[0].enabled=4096&t,this.objLayers[1].enabled=4096&t,this.objLayers[2].enabled=4096&t,this.objLayers[3].enabled=4096&t,this.win0=8192&t,this.win1=16384&t,this.objwin=32768&t,this.objwinLayer.enabled=4096&t&&32768&t,this.bg[2].multipalette&=-2,this.bg[3].multipalette&=-2,0<this.backgroundMode&&(this.bg[2].multipalette|=1),2==this.backgroundMode&&(this.bg[3].multipalette|=1),this.resetLayers()},GameBoyAdvanceSoftwareRenderer.prototype.writeBackgroundControl=function(t,e){var i=this.bg[t];i.priority=3&e,i.charBase=(12&e)<<12,i.mosaic=64&e,i.multipalette&=-129,(t<2||0==this.backgroundMode)&&(i.multipalette|=128&e),i.screenBase=(7936&e)<<3,i.overflow=8192&e,i.size=(49152&e)>>14,this.drawLayers.sort(this.layerComparator)},GameBoyAdvanceSoftwareRenderer.prototype.writeBackgroundHOffset=function(t,e){this.bg[t].x=511&e},GameBoyAdvanceSoftwareRenderer.prototype.writeBackgroundVOffset=function(t,e){this.bg[t].y=511&e},GameBoyAdvanceSoftwareRenderer.prototype.writeBackgroundRefX=function(t,e){this.bg[t].refx=(e<<4)/4096,this.bg[t].sx=this.bg[t].refx},GameBoyAdvanceSoftwareRenderer.prototype.writeBackgroundRefY=function(t,e){this.bg[t].refy=(e<<4)/4096,this.bg[t].sy=this.bg[t].refy},GameBoyAdvanceSoftwareRenderer.prototype.writeBackgroundParamA=function(t,e){this.bg[t].dx=(e<<16)/16777216},GameBoyAdvanceSoftwareRenderer.prototype.writeBackgroundParamB=function(t,e){this.bg[t].dmx=(e<<16)/16777216},GameBoyAdvanceSoftwareRenderer.prototype.writeBackgroundParamC=function(t,e){this.bg[t].dy=(e<<16)/16777216},GameBoyAdvanceSoftwareRenderer.prototype.writeBackgroundParamD=function(t,e){this.bg[t].dmy=(e<<16)/16777216},GameBoyAdvanceSoftwareRenderer.prototype.writeWin0H=function(t){this.win0Left=(65280&t)>>8,this.win0Right=Math.min(this.HORIZONTAL_PIXELS,255&t),this.win0Left>this.win0Right&&(this.win0Right=this.HORIZONTAL_PIXELS)},GameBoyAdvanceSoftwareRenderer.prototype.writeWin1H=function(t){this.win1Left=(65280&t)>>8,this.win1Right=Math.min(this.HORIZONTAL_PIXELS,255&t),this.win1Left>this.win1Right&&(this.win1Right=this.HORIZONTAL_PIXELS)},GameBoyAdvanceSoftwareRenderer.prototype.writeWin0V=function(t){this.win0Top=(65280&t)>>8,this.win0Bottom=Math.min(this.VERTICAL_PIXELS,255&t),this.win0Top>this.win0Bottom&&(this.win0Bottom=this.VERTICAL_PIXELS)},GameBoyAdvanceSoftwareRenderer.prototype.writeWin1V=function(t){this.win1Top=(65280&t)>>8,this.win1Bottom=Math.min(this.VERTICAL_PIXELS,255&t),this.win1Top>this.win1Bottom&&(this.win1Bottom=this.VERTICAL_PIXELS)},GameBoyAdvanceSoftwareRenderer.prototype.writeWindow=function(t,e){t=this.windows[t];t.enabled[0]=1&e,t.enabled[1]=2&e,t.enabled[2]=4&e,t.enabled[3]=8&e,t.enabled[4]=16&e,t.special=32&e},GameBoyAdvanceSoftwareRenderer.prototype.writeWinIn=function(t){this.writeWindow(0,t),this.writeWindow(1,t>>8)},GameBoyAdvanceSoftwareRenderer.prototype.writeWinOut=function(t){this.writeWindow(2,t),this.writeWindow(3,t>>8)},GameBoyAdvanceSoftwareRenderer.prototype.writeBlendControl=function(t){switch(this.target1[0]=!!(1&t)*this.TARGET1_MASK,this.target1[1]=!!(2&t)*this.TARGET1_MASK,this.target1[2]=!!(4&t)*this.TARGET1_MASK,this.target1[3]=!!(8&t)*this.TARGET1_MASK,this.target1[4]=!!(16&t)*this.TARGET1_MASK,this.target1[5]=!!(32&t)*this.TARGET1_MASK,this.target2[0]=!!(256&t)*this.TARGET2_MASK,this.target2[1]=!!(512&t)*this.TARGET2_MASK,this.target2[2]=!!(1024&t)*this.TARGET2_MASK,this.target2[3]=!!(2048&t)*this.TARGET2_MASK,this.target2[4]=!!(4096&t)*this.TARGET2_MASK,this.target2[5]=!!(8192&t)*this.TARGET2_MASK,this.blendMode=(192&t)>>6,this.blendMode){case 1:case 0:this.palette.makeNormalPalettes();break;case 2:this.palette.makeBrightPalettes(63&t);break;case 3:this.palette.makeDarkPalettes(63&t)}},GameBoyAdvanceSoftwareRenderer.prototype.setBlendEnabled=function(t,e,i){if(this.alphaEnabled=e&&1==i,e)switch(i){case 1:case 0:this.palette.makeNormalPalette(t);break;case 2:case 3:this.palette.makeSpecialPalette(t)}else this.palette.makeNormalPalette(t)},GameBoyAdvanceSoftwareRenderer.prototype.writeBlendAlpha=function(t){this.blendA=(31&t)/16,1<this.blendA&&(this.blendA=1),this.blendB=((7936&t)>>8)/16,1<this.blendB&&(this.blendB=1)},GameBoyAdvanceSoftwareRenderer.prototype.writeBlendY=function(t){this.blendY=t,this.palette.setBlendY(16<=t?1:t/16)},GameBoyAdvanceSoftwareRenderer.prototype.writeMosaic=function(t){this.bgMosaicX=1+(15&t),this.bgMosaicY=1+(t>>4&15),this.objMosaicX=1+(t>>8&15),this.objMosaicY=1+(t>>12&15)},GameBoyAdvanceSoftwareRenderer.prototype.resetLayers=function(){1<this.backgroundMode&&(this.bg[0].enabled=!1,this.bg[1].enabled=!1),this.bg[2].enabled&&(this.bg[2].drawScanline=this.bgModes[this.backgroundMode]),0==this.backgroundMode||2==this.backgroundMode?this.bg[3].enabled&&(this.bg[3].drawScanline=this.bgModes[this.backgroundMode]):this.bg[3].enabled=!1,this.drawLayers.sort(this.layerComparator)},GameBoyAdvanceSoftwareRenderer.prototype.layerComparator=function(t,e){var i=e.priority-t.priority;return i||(t.bg&&!e.bg?-1:!t.bg&&e.bg?1:e.index-t.index)},GameBoyAdvanceSoftwareRenderer.prototype.accessMapMode0=function(t,e,i,s,r){s=t+(i>>2&62)+s;1&e&&(s+=(256&i)<<3);s=this.vram.loadU16(s);r.tile=1023&s,r.hflip=1024&s,r.vflip=2048&s,r.palette=(61440&s)>>8},GameBoyAdvanceSoftwareRenderer.prototype.accessMapMode1=function(t,e,i,s,r){s=t+(i>>3)+s;r.tile=this.vram.loadU8(s)},GameBoyAdvanceSoftwareRenderer.prototype.accessTile=function(t,e,i){e=t+(e<<5);return e|=i<<2,this.vram.load32(e)},GameBoyAdvanceSoftwareRenderer.pushPixel=function(t,e,i,s,r,a,n,o,h){if(!h){if(!(u=this.multipalette?s>>(r<<3)&255:s>>(r<<2)&15))return;this.multipalette||(u|=e.palette)}var c=i.WRITTEN_MASK,r=n.stencil[a],e=i.blendMode;if(i.objwinActive)if(r&i.OBJWIN_MASK){if(!i.windows[3].enabled[t])return;i.setBlendEnabled(t,i.windows[3].special&&i.target1[t],e),i.windows[3].special&&i.alphaEnabled&&(o|=i.target1[t]),c|=i.OBJWIN_MASK}else{if(!i.windows[2].enabled[t])return;i.setBlendEnabled(t,i.windows[2].special&&i.target1[t],e),i.windows[2].special&&i.alphaEnabled&&(o|=i.target1[t])}o&i.TARGET1_MASK&&r&i.TARGET2_MASK&&i.setBlendEnabled(t,!0,1);var u=h?s:i.palette.accessColor(t,u);o&i.TARGET1_MASK&&i.setBlendEnabled(t,!!e,e);e=(o&i.PRIORITY_MASK)<(r&i.PRIORITY_MASK);if((o&i.PRIORITY_MASK)==(r&i.PRIORITY_MASK)&&(e=o&i.BACKGROUND_MASK),r&i.WRITTEN_MASK)if(e)o&i.TARGET1_MASK&&r&i.TARGET2_MASK&&(u=i.palette.mix(i.blendA,u,i.blendB,n.color[a])),c|=o&~i.TARGET1_MASK;else{if(!((o&i.PRIORITY_MASK)>(r&i.PRIORITY_MASK)))return;if(c=r&~(i.TARGET1_MASK|i.TARGET2_MASK),!(o&i.TARGET2_MASK&&r&i.TARGET1_MASK))return;u=i.palette.mix(i.blendB,u,i.blendA,n.color[a])}else c|=o;o&i.OBJWIN_MASK?n.stencil[a]|=i.OBJWIN_MASK:(n.color[a]=u,n.stencil[a]=c)},GameBoyAdvanceSoftwareRenderer.prototype.identity=function(t){return t},GameBoyAdvanceSoftwareRenderer.prototype.drawScanlineBlank=function(t){for(var e=0;e<this.HORIZONTAL_PIXELS;++e)t.color[e]=65535,t.stencil[e]=0},GameBoyAdvanceSoftwareRenderer.prototype.prepareScanline=function(t){for(var e=0;e<this.HORIZONTAL_PIXELS;++e)t.stencil[e]=this.target2[this.LAYER_BACKDROP]},GameBoyAdvanceSoftwareRenderer.prototype.drawScanlineBGMode0=function(t,e,i,s){var r,a,n=this.video,o=n.vcount,h=i,c=e.x,u=o+e.y;this.mosaic&&(u-=o%n.bgMosaicY);var p,d=7&u,m=e.screenBase,l=e.charBase,A=e.size,f=e.index,y=n.sharedMap,R=e.multipalette?1:0,S=n.target2[f]|e.priority<<1|n.BACKGROUND_MASK;1==n.blendMode&&n.alphaEnabled&&(S|=n.target1[f]);var C,v=u<<3&1984;2==A?v+=u<<3&2048:3==A&&(v+=u<<4&4096),C=1&A?511:255,n.accessMapMode0(m,A,i+c&C,v,y);for(var b=n.accessTile(l,y.tile<<R,(y.vflip?7-d:d)<<R),M=i;M<s;++M){if(r=M+c&C,a=7&(r-=p=this.mosaic?h%n.bgMosaicX:0),R){if(a&&(!this.mosaic||p)||n.accessMapMode0(m,A,r,v,y),(!(3&a)||this.mosaic&&!p)&&!((b=n.accessTile(l+(!!(4&r)==!y.hflip?4:0),y.tile<<1,(y.vflip?7-d:d)<<1))||3&a)){M+=3,h+=4;continue}}else if((!a||this.mosaic&&!p)&&(n.accessMapMode0(m,A,r,v,y),!(b=n.accessTile(l,y.tile,y.vflip?7-d:d))&&!a)){M+=7,h+=8;continue}y.hflip&&(a=7-a),e.pushPixel(f,y,n,b,a,h,t,S,!1),h++}},GameBoyAdvanceSoftwareRenderer.prototype.drawScanlineBGMode2=function(t,e,i,s){var r,a,n,o,h=this.video,c=h.vcount,u=i,p=e.screenBase,d=e.charBase,m=e.size,l=128<<m,A=e.index,f=h.sharedMap,y=h.target2[A]|e.priority<<1|h.BACKGROUND_MASK;for(1==h.blendMode&&h.alphaEnabled&&(y|=h.target1[A]),r=i;r<s;++r){if(n=e.dx*r+e.sx,a=e.dy*r+e.sy,this.mosaic&&(n-=r%h.bgMosaicX*e.dx+c%h.bgMosaicY*e.dmx,a-=r%h.bgMosaicX*e.dy+c%h.bgMosaicY*e.dmy),e.overflow)(n&=l-1)<0&&(n+=l),(a&=l-1)<0&&(a+=l);else if(n<0||a<0||l<=n||l<=a){u++;continue}o=(a<<1&2032)<<m,h.accessMapMode1(p,m,n,o,f),n=this.vram.loadU8(d+(f.tile<<6)+((7&a)<<3)+(7&n)),e.pushPixel(A,f,h,n,0,u,t,y,!1),u++}},GameBoyAdvanceSoftwareRenderer.prototype.drawScanlineBGMode3=function(t,e,i,s){var r,a,n,o=this.video,h=o.vcount,c=i,u=e.index,p=o.sharedMap,d=o.target2[u]|e.priority<<1|o.BACKGROUND_MASK;for(1==o.blendMode&&o.alphaEnabled&&(d|=o.target1[u]),r=i;r<s;++r)n=e.dx*r+e.sx,a=e.dy*r+e.sy,this.mosaic&&(n-=r%o.bgMosaicX*e.dx+h%o.bgMosaicY*e.dmx,a-=r%o.bgMosaicX*e.dy+h%o.bgMosaicY*e.dmy),n<0||a<0||n>=o.HORIZONTAL_PIXELS||a>=o.VERTICAL_PIXELS||(n=this.vram.loadU16(a*o.HORIZONTAL_PIXELS+n<<1),e.pushPixel(u,p,o,n,0,c,t,d,!0)),c++},GameBoyAdvanceSoftwareRenderer.prototype.drawScanlineBGMode4=function(t,e,i,s){var r,a,n=this.video,o=n.vcount,h=i,c=0;n.displayFrameSelect&&(c+=40960);e.size;var u,p=e.index,d=n.sharedMap,m=n.target2[p]|e.priority<<1|n.BACKGROUND_MASK;for(1==n.blendMode&&n.alphaEnabled&&(m|=n.target1[p]),r=i;r<s;++r)u=e.dx*r+e.sx,a=0|e.dy*r+e.sy,this.mosaic&&(u-=r%n.bgMosaicX*e.dx+o%n.bgMosaicY*e.dmx,a-=r%n.bgMosaicX*e.dy+o%n.bgMosaicY*e.dmy),u<0||a<0||u>=n.HORIZONTAL_PIXELS||a>=n.VERTICAL_PIXELS||(u=this.vram.loadU8(c+a*n.HORIZONTAL_PIXELS+u),e.pushPixel(p,d,n,u,0,h,t,m,!1)),h++},GameBoyAdvanceSoftwareRenderer.prototype.drawScanlineBGMode5=function(t,e,i,s){var r,a,n=this.video,o=n.vcount,h=i,c=0;n.displayFrameSelect&&(c+=40960);var u,p=e.index,d=n.sharedMap,m=n.target2[p]|e.priority<<1|n.BACKGROUND_MASK;for(1==n.blendMode&&n.alphaEnabled&&(m|=n.target1[p]),r=i;r<s;++r)u=e.dx*r+e.sx,a=e.dy*r+e.sy,this.mosaic&&(u-=r%n.bgMosaicX*e.dx+o%n.bgMosaicY*e.dmx,a-=r%n.bgMosaicX*e.dy+o%n.bgMosaicY*e.dmy),u<0||a<0||160<=u||128<=a||(u=this.vram.loadU16(c+(160*a+u)<<1),e.pushPixel(p,d,n,u,0,h,t,m,!0)),h++},GameBoyAdvanceSoftwareRenderer.prototype.drawScanline=function(t){var e,i,s,r,a,n=this.scanline;if(this.forcedBlank)this.drawScanlineBlank(n);else{this.prepareScanline(n),this.vcount=t;for(var o=0;o<this.drawLayers.length;++o)(e=this.drawLayers[o]).enabled&&(this.objwinActive=!1,this.win0||this.win1||this.objwin?(i=0,s=this.HORIZONTAL_PIXELS,r=0,a=this.HORIZONTAL_PIXELS,this.win0&&t>=this.win0Top&&t<this.win0Bottom&&(this.windows[0].enabled[e.index]&&(this.setBlendEnabled(e.index,this.windows[0].special&&this.target1[e.index],this.blendMode),e.drawScanline(n,e,this.win0Left,this.win0Right)),i=Math.max(i,this.win0Left),s=Math.min(s,this.win0Left),r=Math.max(r,this.win0Right),a=Math.min(a,this.win0Right)),this.win1&&t>=this.win1Top&&t<this.win1Bottom&&(this.windows[1].enabled[e.index]&&(this.setBlendEnabled(e.index,this.windows[1].special&&this.target1[e.index],this.blendMode),!this.windows[0].enabled[e.index]&&(this.win1Left<i||this.win1Right<r)?(e.drawScanline(n,e,this.win1Left,i),e.drawScanline(n,e,a,this.win1Right)):e.drawScanline(n,e,this.win1Left,this.win1Right)),i=Math.max(i,this.win1Left),s=Math.min(s,this.win1Left),r=Math.max(r,this.win1Right),a=Math.min(a,this.win1Right)),(this.windows[2].enabled[e.index]||this.objwin&&this.windows[3].enabled[e.index])&&(this.objwinActive=this.objwin,this.setBlendEnabled(e.index,this.windows[2].special&&this.target1[e.index],this.blendMode),r<s?e.drawScanline(n,e,0,this.HORIZONTAL_PIXELS):(s&&e.drawScanline(n,e,0,s),r<this.HORIZONTAL_PIXELS&&e.drawScanline(n,e,r,this.HORIZONTAL_PIXELS),a<i&&e.drawScanline(n,e,a,i))),this.setBlendEnabled(this.LAYER_BACKDROP,this.target1[this.LAYER_BACKDROP]&&this.windows[2].special,this.blendMode)):(this.setBlendEnabled(e.index,this.target1[e.index],this.blendMode),e.drawScanline(n,e,0,this.HORIZONTAL_PIXELS)),e.bg&&(e.sx+=e.dmx,e.sy+=e.dmy));this.finishScanline(n)}},GameBoyAdvanceSoftwareRenderer.prototype.finishScanline=function(t){for(var e,i=this.palette.accessColor(this.LAYER_BACKDROP,0),s=this.vcount*this.HORIZONTAL_PIXELS*4,r=this.target2[this.LAYER_BACKDROP],a=0;a<this.HORIZONTAL_PIXELS;++a)t.stencil[a]&this.WRITTEN_MASK?(e=t.color[a],r&&t.stencil[a]&this.TARGET1_MASK&&(e=this.palette.mix(this.blendA,e,this.blendB,i)),this.palette.convert16To32(e,this.sharedColor)):this.palette.convert16To32(i,this.sharedColor),this.pixelData.data[s++]=this.sharedColor[0],this.pixelData.data[s++]=this.sharedColor[1],this.pixelData.data[s++]=this.sharedColor[2],s++},GameBoyAdvanceSoftwareRenderer.prototype.startDraw=function(){},GameBoyAdvanceSoftwareRenderer.prototype.finishDraw=function(t){this.bg[2].sx=this.bg[2].refx,this.bg[2].sy=this.bg[2].refy,this.bg[3].sx=this.bg[3].refx,this.bg[3].sy=this.bg[3].refy,t.finishDraw(this.pixelData)},importScripts("software.js");var video=new GameBoyAdvanceSoftwareRenderer,proxyBacking=null,currentFrame=0;function receiveDirty(t){for(var e in t)switch(e){case"DISPCNT":video.writeDisplayControl(t[e]);break;case"BGCNT":for(var i in t[e])"number"==typeof t[e][i]&&video.writeBackgroundControl(i,t[e][i]);break;case"BGHOFS":for(var i in t[e])"number"==typeof t[e][i]&&video.writeBackgroundHOffset(i,t[e][i]);break;case"BGVOFS":for(var i in t[e])"number"==typeof t[e][i]&&video.writeBackgroundVOffset(i,t[e][i]);break;case"BGX":for(var i in t[e])"number"==typeof t[e][i]&&video.writeBackgroundRefX(i,t[e][i]);break;case"BGY":for(var i in t[e])"number"==typeof t[e][i]&&video.writeBackgroundRefY(i,t[e][i]);break;case"BGPA":for(var i in t[e])"number"==typeof t[e][i]&&video.writeBackgroundParamA(i,t[e][i]);break;case"BGPB":for(var i in t[e])"number"==typeof t[e][i]&&video.writeBackgroundParamB(i,t[e][i]);break;case"BGPC":for(var i in t[e])"number"==typeof t[e][i]&&video.writeBackgroundParamC(i,t[e][i]);break;case"BGPD":for(var i in t[e])"number"==typeof t[e][i]&&video.writeBackgroundParamD(i,t[e][i]);break;case"WIN0H":video.writeWin0H(t[e]);break;case"WIN1H":video.writeWin1H(t[e]);break;case"WIN0V":video.writeWin0V(t[e]);break;case"WIN1V":video.writeWin1V(t[e]);break;case"WININ":video.writeWinIn(t[e]);break;case"WINOUT":video.writeWinOut(t[e]);break;case"BLDCNT":video.writeBlendControl(t[e]);break;case"BLDALPHA":video.writeBlendAlpha(t[e]);break;case"BLDY":video.writeBlendY(t[e]);break;case"MOSAIC":video.writeMosaic(t[e]);break;case"memory":receiveMemory(t.memory)}}function receiveMemory(t){if(t.palette&&video.palette.overwrite(new Uint16Array(t.palette)),t.oam&&video.oam.overwrite(new Uint16Array(t.oam)),t.vram)for(var e=0;e<12;++e)t.vram[e]&&video.vram.insert(e<<12,new Uint16Array(t.vram[e]))}self.finishDraw=function(t){self.postMessage({type:"finish",backing:t,frame:currentFrame})};var handlers={clear:function(t){video.clear(t)},scanline:function(t){receiveDirty(t.dirty),video.drawScanline(t.y,proxyBacking)},start:function(t){proxyBacking=t.backing,video.setBacking(t.backing)},finish:function(t){currentFrame=t.frame;for(var e=0,i=0;i<t.scanlines.length;++i){for(var s=e;s<t.scanlines[i].y;++s)video.drawScanline(s,proxyBacking);e=t.scanlines[i].y+1,receiveDirty(t.scanlines[i].dirty),video.drawScanline(t.scanlines[i].y,proxyBacking)}for(s=e;s<160;++s)video.drawScanline(s,proxyBacking);video.finishDraw(self)}};function MemoryProxy(t,e,i){if(this.owner=t,this.blocks=[],this.blockSize=i,this.mask=(1<<i)-1,this.size=e,i)for(var s=0;s<e>>i;++s)this.blocks.push(new MemoryView(new ArrayBuffer(1<<i)));else this.blockSize=31,this.mask=-1,this.blocks[0]=new MemoryView(new ArrayBuffer(e))}function GameBoyAdvanceRenderProxy(){this.worker=new Worker("js/video/worker.js"),this.currentFrame=0,this.delay=0,this.skipFrame=!1,this.dirty=null;var e=this,i={finish:function(t){e.backing=t.backing,e.caller.finishDraw(e.backing),--e.delay}};this.worker.onmessage=function(t){i[t.data.type](t.data)}}self.onmessage=function(t){handlers[t.data.type](t.data)},MemoryProxy.prototype.combine=function(){if(1<this.blocks.length){for(var t=new Uint8Array(this.size),e=0;e<this.blocks.length;++e)t.set(new Uint8Array(this.blocks[e].buffer),e<<this.blockSize);return t.buffer}return this.blocks[0].buffer},MemoryProxy.prototype.replace=function(t){for(var e=0;e<this.blocks.length;++e)this.blocks[e]=new MemoryView(t.slice(e<<this.blockSize,(e<<this.blockSize)+this.blocks[e].buffer.byteLength))},MemoryProxy.prototype.load8=function(t){return this.blocks[t>>this.blockSize].load8(t&this.mask)},MemoryProxy.prototype.load16=function(t){return this.blocks[t>>this.blockSize].load16(t&this.mask)},MemoryProxy.prototype.loadU8=function(t){return this.blocks[t>>this.blockSize].loadU8(t&this.mask)},MemoryProxy.prototype.loadU16=function(t){return this.blocks[t>>this.blockSize].loadU16(t&this.mask)},MemoryProxy.prototype.load32=function(t){return this.blocks[t>>this.blockSize].load32(t&this.mask)},MemoryProxy.prototype.store8=function(t,e){t>=this.size||(this.owner.memoryDirtied(this,t>>this.blockSize),this.blocks[t>>this.blockSize].store8(t&this.mask,e),this.blocks[t>>this.blockSize].store8(t&this.mask^1,e))},MemoryProxy.prototype.store16=function(t,e){if(!(t>=this.size))return this.owner.memoryDirtied(this,t>>this.blockSize),this.blocks[t>>this.blockSize].store16(t&this.mask,e)},MemoryProxy.prototype.store32=function(t,e){if(!(t>=this.size))return this.owner.memoryDirtied(this,t>>this.blockSize),this.blocks[t>>this.blockSize].store32(t&this.mask,e)},MemoryProxy.prototype.invalidatePage=function(t){},GameBoyAdvanceRenderProxy.prototype.memoryDirtied=function(t,e){this.dirty=this.dirty||{},this.dirty.memory=this.dirty.memory||{},t===this.palette&&(this.dirty.memory.palette=t.blocks[0].buffer),t===this.oam&&(this.dirty.memory.oam=t.blocks[0].buffer),t===this.vram&&(this.dirty.memory.vram=this.dirty.memory.vram||[],this.dirty.memory.vram[e]=t.blocks[e].buffer)},GameBoyAdvanceRenderProxy.prototype.clear=function(t){this.palette=new MemoryProxy(this,t.SIZE_PALETTE_RAM,0),this.vram=new MemoryProxy(this,t.SIZE_VRAM,13),this.oam=new MemoryProxy(this,t.SIZE_OAM,0),this.dirty=null,this.scanlineQueue=[],this.worker.postMessage({type:"clear",SIZE_VRAM:t.SIZE_VRAM,SIZE_OAM:t.SIZE_OAM})},GameBoyAdvanceRenderProxy.prototype.freeze=function(t){return{palette:Serializer.prefix(this.palette.combine()),vram:Serializer.prefix(this.vram.combine()),oam:Serializer.prefix(this.oam.combine())}},GameBoyAdvanceRenderProxy.prototype.defrost=function(t,e){this.palette.replace(t.palette),this.memoryDirtied(this.palette,0),this.vram.replace(t.vram);for(var i=0;i<this.vram.blocks.length;++i)this.memoryDirtied(this.vram,i);this.oam.replace(t.oam),this.memoryDirtied(this.oam,0)},GameBoyAdvanceRenderProxy.prototype.writeDisplayControl=function(t){this.dirty=this.dirty||{},this.dirty.DISPCNT=t},GameBoyAdvanceRenderProxy.prototype.writeBackgroundControl=function(t,e){this.dirty=this.dirty||{},this.dirty.BGCNT=this.dirty.BGCNT||[],this.dirty.BGCNT[t]=e},GameBoyAdvanceRenderProxy.prototype.writeBackgroundHOffset=function(t,e){this.dirty=this.dirty||{},this.dirty.BGHOFS=this.dirty.BGHOFS||[],this.dirty.BGHOFS[t]=e},GameBoyAdvanceRenderProxy.prototype.writeBackgroundVOffset=function(t,e){this.dirty=this.dirty||{},this.dirty.BGVOFS=this.dirty.BGVOFS||[],this.dirty.BGVOFS[t]=e},GameBoyAdvanceRenderProxy.prototype.writeBackgroundRefX=function(t,e){this.dirty=this.dirty||{},this.dirty.BGX=this.dirty.BGX||[],this.dirty.BGX[t]=e},GameBoyAdvanceRenderProxy.prototype.writeBackgroundRefY=function(t,e){this.dirty=this.dirty||{},this.dirty.BGY=this.dirty.BGY||[],this.dirty.BGY[t]=e},GameBoyAdvanceRenderProxy.prototype.writeBackgroundParamA=function(t,e){this.dirty=this.dirty||{},this.dirty.BGPA=this.dirty.BGPA||[],this.dirty.BGPA[t]=e},GameBoyAdvanceRenderProxy.prototype.writeBackgroundParamB=function(t,e){this.dirty=this.dirty||{},this.dirty.BGPB=this.dirty.BGPB||[],this.dirty.BGPB[t]=e},GameBoyAdvanceRenderProxy.prototype.writeBackgroundParamC=function(t,e){this.dirty=this.dirty||{},this.dirty.BGPC=this.dirty.BGPC||[],this.dirty.BGPC[t]=e},GameBoyAdvanceRenderProxy.prototype.writeBackgroundParamD=function(t,e){this.dirty=this.dirty||{},this.dirty.BGPD=this.dirty.BGPD||[],this.dirty.BGPD[t]=e},GameBoyAdvanceRenderProxy.prototype.writeWin0H=function(t){this.dirty=this.dirty||{},this.dirty.WIN0H=t},GameBoyAdvanceRenderProxy.prototype.writeWin1H=function(t){this.dirty=this.dirty||{},this.dirty.WIN1H=t},GameBoyAdvanceRenderProxy.prototype.writeWin0V=function(t){this.dirty=this.dirty||{},this.dirty.WIN0V=t},GameBoyAdvanceRenderProxy.prototype.writeWin1V=function(t){this.dirty=this.dirty||{},this.dirty.WIN1V=t},GameBoyAdvanceRenderProxy.prototype.writeWinIn=function(t){this.dirty=this.dirty||{},this.dirty.WININ=t},GameBoyAdvanceRenderProxy.prototype.writeWinOut=function(t){this.dirty=this.dirty||{},this.dirty.WINOUT=t},GameBoyAdvanceRenderProxy.prototype.writeBlendControl=function(t){this.dirty=this.dirty||{},this.dirty.BLDCNT=t},GameBoyAdvanceRenderProxy.prototype.writeBlendAlpha=function(t){this.dirty=this.dirty||{},this.dirty.BLDALPHA=t},GameBoyAdvanceRenderProxy.prototype.writeBlendY=function(t){this.dirty=this.dirty||{},this.dirty.BLDY=t},GameBoyAdvanceRenderProxy.prototype.writeMosaic=function(t){this.dirty=this.dirty||{},this.dirty.MOSAIC=t},GameBoyAdvanceRenderProxy.prototype.clearSubsets=function(t,e){if(this.dirty=this.dirty||{},4&e&&(this.palette=new MemoryProxy(this,t.SIZE_PALETTE_RAM,0),t.mmap(t.REGION_PALETTE_RAM,this.palette),this.memoryDirtied(this.palette,0)),8&e){this.vram=new MemoryProxy(this,t.SIZE_VRAM,13),t.mmap(t.REGION_VRAM,this.vram);for(var i=0;i<this.vram.blocks.length;++i)this.memoryDirtied(this.vram,i)}16&e&&(this.oam=new MemoryProxy(this,t.SIZE_OAM,0),t.mmap(t.REGION_OAM,this.oam),this.memoryDirtied(this.oam,0))},GameBoyAdvanceRenderProxy.prototype.setBacking=function(t){this.backing=t,this.worker.postMessage({type:"start",backing:this.backing})},GameBoyAdvanceRenderProxy.prototype.drawScanline=function(t){if(!this.skipFrame&&this.dirty){if(this.dirty.memory&&(this.dirty.memory.palette&&(this.dirty.memory.palette=this.dirty.memory.palette.slice(0)),this.dirty.memory.oam&&(this.dirty.memory.oam=this.dirty.memory.oam.slice(0)),this.dirty.memory.vram))for(var e=0;e<12;++e)this.dirty.memory.vram[e]&&(this.dirty.memory.vram[e]=this.dirty.memory.vram[e].slice(0));this.scanlineQueue.push({y:t,dirty:this.dirty}),this.dirty=null}},GameBoyAdvanceRenderProxy.prototype.startDraw=function(){++this.currentFrame,this.delay<=0&&(this.skipFrame=!1),this.skipFrame||++this.delay},GameBoyAdvanceRenderProxy.prototype.finishDraw=function(t){this.caller=t,this.skipFrame||(this.worker.postMessage({type:"finish",scanlines:this.scanlineQueue,frame:this.currentFrame}),this.scanlineQueue=[],2<this.delay&&(this.skipFrame=!0))};